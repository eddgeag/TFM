---
title: Integration of omics and clinical data of the hormonal, metabolic, inflammatory,
  and oxidative response in the different macronutrients of the diet
author: "Edmond Geraud"
subtitle: '`r params$subtitulo`'
date: '`r format(Sys.Date(),"%e de %B, %Y")`' 
output:
  prettydoc::html_pretty:
    theme: cayman
    highlight: github
    toc: true
  html_document:
    toc: true
    toc_depth: 2
header-includes:
  - \usepackage[english]{babel}
params:
  
  file_IP: Integromics_IPmarkers.xlsx
  file_metabolome: Integromics_Metabolome.xlsx
  file_general: Integromics_1.xlsx
  file_microbiota : integromics_microbiota.xlsx
  folder.data: ../../datos
  subtitulo: FINAL RESULTS
geometry: margin=2cm
---

```{r setup, include=FALSE}
require(knitr)
# include this code chunk as-is to set options
opts_chunk$set(comment = NA, prompt = TRUE, tidy = T, 
               fig.width = 7, fig.height = 7,echo = TRUE, 
               message = FALSE, warning = FALSE, cache=TRUE, fig_caption = TRUE)
Sys.setlocale("LC_TIME", "C")
```

## Load the libraries

```{r libraries}

list.of.packages <- c("xlsx","kableExtra","dplyr","ggplot2","egg","cowplot","patchwork","gridExtra","UsingR","car","lattice","ggpubr","ggbreak","GGally","reshape2","ggcorrplot","corrplot","rela","ggrepel","factoextra","chemometrics","sparsepca","vegan","ca","ade4","pls","OmicsPLS")
new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])] ## check for packages not installed 
if(length(new.packages)) install.packages(new.packages) ## install packages if necessary
res<-unlist(lapply(list.of.packages, require,character.only = T)) ## load packages needed for the session
if(any(res==F)){
  list.of.packages[which(res==F)]  ## show those package if you have troubles to install.
}

list.of.bioc.packages <- c("phyloseq","pcaMethods","ropls","mixOmics")
new.packages.bioc <- list.of.packages[!(list.of.bioc.packages %in% installed.packages()[,"Package"])]
if(length(new.packages.bioc)) BiocManager::install(new.packages.bioc)
res.bioc <- unlist(lapply(list.of.bioc.packages, require,character.only = T)) 
if(any(res.bioc==F)){
  list.of.packages[which(res.bioc==F)]  ## show those package if you have troubles to install.
}
```


# Functions for loading data (microbiome)

```{r}
proces_bacteria <- function(datos,tipo){

	Order <- bacteria_phylum.abs$Order
	variables_in_bacteria <- general_data[general_data$Orden %in% Order , ]
	Sample<-variables_in_bacteria$Paciente


	if(tipo=="genera"){

		Order <- Order

		X <- datos[-1,-1]
		X<-apply(X,2,as.numeric)
		colnames(X) <- datos[1,2:ncol(datos)]
		rownames(X) <- Sample
		X.rel <- 100*X/rowSums(X)


	} else if(tipo=="phylum"){

		X <- datos[,-c(1:2)]
		colnames(X) <- colnames(datos)[3:ncol(datos)]
		rownames(X) <- Sample
		X.rel<-100*X/rowSums(X)
	}

	GROUP <-variables_in_bacteria$GROUP
	SEX <- variables_in_bacteria$SEX
	OBESE<- variables_in_bacteria$OBESE

	X<-as.data.frame(X)
	X.rel<-as.data.frame(X.rel)

	X$GROUP<-GROUP
	X$SEX<-SEX
	X$OBESE<-OBESE


	X.rel$GROUP<-GROUP
	X.rel$SEX<-SEX
	X.rel$OBESE<-OBESE

	return(list(abs=X,rel=X.rel))

}


low.count.removal = function(
                        data, # OTU count data frame of size n (sample) x p (OTU)
                        percent=0.01 # cutoff chosen
                        ){
    keep.otu = which(colSums(data)*100/(sum(colSums(data))) > percent)
    data.filter = data[,keep.otu]
    return(list(data.filter = data.filter, keep.otu = keep.otu))
}

relative.fn <-function(data){
  
  return(100*data/rowSums(data))
  
}


```


# Load the data

## Clinical data.

```{r}
general_data <- read.xlsx(file.path(params$folder.data,params$file_general),sheetIndex =1)
general_data$SEX <- factor(general_data$SEX, levels = c(0, 2), labels = c("Female", "Male"))
general_data$OBESE <- factor(general_data$OBESE, levels = c(0, 1), labels = c("No Obese", "Obese"))
general_data$GROUP <- factor(general_data$GROUP, levels = c(0, 1, 2), labels = c("Female",  "PCOS", "Male"))
```

## IP data.

```{r}
IP_file<-file.path(params$folder.data,file=params$file_IP) ## file path of the data
IP.tmp<-read.xlsx(IP_file,sheetIndex = 1)
IP<-IP.tmp[,-7] # remove the missin values column
IP$SEX <- factor(IP$SEX,levels=c(0,2),labels = c("Female","Male"))
IP$OBESE <- factor(IP$OBESE,levels=c(0,1),labels = c("No Obese","Obese"))
IP$GROUP <- factor(IP$GROUP,levels=c(0,1,2),labels = c("Female","PCOS","Male"))
```


## Metabolome data

```{r}
metabolome_file<-file.path(params$folder.data,file=params$file_metabolome) ## file path of the data
metabolome.tmp<-read.xlsx(metabolome_file,sheetIndex = 1) # read the data
metabolites_name <- read.xlsx(metabolome_file,sheetIndex = 2)$Metabolitos # read the names of the metabolites
any(is.na(metabolome.tmp)) # there is a row of missing values.
metabolome<-metabolome.tmp[-nrow(metabolome.tmp),] ## remove the missing value row
metabolome$GROUP<-general_data$GROUP ## add GROUP variable 
metabolome$OBESE <- general_data$OBESE ## add OBESE variables.
```

## Microbiome data.

```{r}
bacteria_phylum.abs <- as.data.frame(read.xlsx(file.path(params$folder.data,params$file_microbiota), sheetIndex = 1))
bacteria_genera.abs <- as.data.frame(t(read.xlsx(file.path(params$folder.data,params$file_microbiota), sheetIndex = 3)))
phylum.list <- proces_bacteria(bacteria_phylum.abs,tipo="phylum")
genera.list <- proces_bacteria(bacteria_genera.abs,tipo="genera")

phylum.abs <- phylum.list$abs;phylum.rel<-phylum.list$rel
genera.abs <- genera.list$abs;genera.rel<-genera.list$rel
```


# Preprocess data according to the microbiome.

Because we have less subjects on the microbiome, and we have phylum and genera with variables with no records across all samples, we have to clean that.

Furthermore, we have to take care only the basal levels across all blocks. Also we have to clean the data on the metabolome, IP for repeated variables.

```{r}
variables_in_bacteria <- general_data[general_data$Orden %in% bacteria_phylum.abs$Order, ]
```

Because, we only take care of the GROUP, and OBESE variables on the analysis, we can get rid off this variables and store them apart in a new object. Furthermore, we have to have the same names for the rows, so let's keep it in another object.

```{r}
sujetos <- variables_in_bacteria$Paciente
GROUP <- variables_in_bacteria$GROUP
OBESE <- variables_in_bacteria$OBESE
interaccion <-with(variables_in_bacteria,interaction(GROUP,OBESE))
```

## Clinical data.

**NOTE we are going to include also on both levels of integration body measures**
We exclude ISI because it is measured after the load of glucose, the mean values, to exclude redundancy of the data, ant the postprandial levels. 

```{r}
Clin.tmp <- variables_in_bacteria[,-c(1,2,3,4,5)] # get rid off orden, paciente, sex, group and obese
auc_clin <- colnames(Clin.tmp)[grep("AUC",colnames(Clin.tmp))]
mean_basal_clin<-colnames(Clin.tmp)[grep("mean",colnames(Clin.tmp))]
isi <- colnames(Clin.tmp)[grep("ISI",colnames(Clin.tmp))]
variables_clin <- colnames(Clin.tmp)
w<-c(which(variables_clin %in% auc_clin),which(variables_clin %in% mean_basal_clin),which(variables_clin %in% isi))
Clin <- Clin.tmp[,-w]
rownames(Clin) <- sujetos
```


## IP data

```{r}
IP.tmp <- IP[IP$Paciente %in% variables_in_bacteria$Paciente,]
redundant_variables <- c("Orden","Paciente","SEX","GROUP","OBESE","BMI")
variables_ip <- colnames(IP.tmp)
auc_ip <- variables_ip[grep("AUC",variables_ip)]
mean_ip <- variables_ip[grep("mean",variables_ip)]
w <- c(which(variables_ip %in% redundant_variables),which(variables_ip %in% auc_ip),which(variables_ip %in% mean_ip))
IP.basal <- IP.tmp[,-w]
rownames(IP.basal) <- sujetos

```

## Metabolome data.

```{r}
metabolome.basal.tmp <- metabolome[metabolome$Order %in% variables_in_bacteria$Orden,]
redundant_data_meta <- c("Order","Sample","GROUP","OBESE")
variables_meta <- colnames(metabolome.basal.tmp)
mean_meta <- variables_meta[grep("mean",variables_meta)]
auc_meta <- variables_meta[grep("AU[CG]",variables_meta)]
w <- c(which(variables_meta %in% redundant_data_meta),which(variables_meta %in% mean_meta),which(variables_meta %in% auc_meta))
metabolome.basal <- metabolome.basal.tmp[,-w]
rownames(metabolome.basal) <- sujetos
```

## Microbiome data.

### Phylum.

```{r}
phylum.abs.tmp <- phylum.abs
redundant_data_ph <- c("GROUP","SEX","OBESE")
phylum.tmp <- phylum.abs.tmp[,-c(ncol(phylum.abs.tmp)-2,ncol(phylum.abs.tmp)-1,ncol(phylum.abs.tmp))]
phylum <- phylum.tmp[,colSums(phylum.tmp)>0]
rownames(phylum) <- sujetos
## removal of unidentified phyla
phylum<-phylum[,-grep("^ud",colnames(phylum))]


```

### Genus

```{r}
genera.abs.tmp <- genera.abs
redundant_data_ph <- c("GROUP","SEX","OBESE")
genus.tmp.tmp <- genera.abs.tmp[,-c(ncol(genera.abs.tmp)-2,ncol(genera.abs.tmp)-1,ncol(genera.abs.tmp))]
genus <- genus.tmp.tmp[,colSums(genus.tmp.tmp)>0]
rownames(genus) <- sujetos
## removal of genus unidentified

genus<-genus[,-grep("^ud-",colnames(genus))]
```


## Pretreatment of microbiome data.

```{r}
genus.offset<-genus+1
phylum.offset<-phylum+1
sum(which(genus.offset == 0))


result.filter.genus <- low.count.removal(genus.offset, percent=0.01)
result.filter.phylum<- low.count.removal(phylum.offset, percent=0.01)

genus.filter <- result.filter.genus$data.filter
phylum.filter <- result.filter.phylum$data.filter

# length(result.filter$keep.otu) 
lib.size.genus <- apply(genus.filter, 1, sum)
lib.size.phylum <- apply(phylum.filter,1,sum)
par(mfrow=c(1,2))
barplot(lib.size.genus)
barplot(lib.size.phylum)


genus.clr <- logratio.transfo(as.matrix(genus.filter), logratio = 'CLR', offset = 0) 
genus.rel <- relative.fn(genus)


phylum.clr <- logratio.transfo(as.matrix(phylum.filter), logratio = 'CLR', offset = 0) 
phylum.rel <- relative.fn(phylum)
```

# METABOLOME-MICROBIOME

## PLS2

### Phylum

```{r}
X<- metabolome.basal
Y<- phylum.clr
datos <- list(metabolome = X,
              microbiome = Y)
pls_obj <- plsr(as.matrix(datos$metabolome)~as.matrix(datos$microbiome),
                val.type="CV",center=T,scale=T,explvar=T)

rho <- diag(cor(pls_obj$scores[,1:2],pls_obj$Yscores[,1:2]))

Group <- variables_in_bacteria$GROUP
Group2 <- variables_in_bacteria$OBESE
X<-pls_obj$scores
colnames(X)<-paste0("met",paste0("comp",1:length(colnames(X))))
Y<-pls_obj$Yscores
colnames(Y)<-paste0("micro",paste0("comp",1:length(colnames(Y))))
datos <- data.frame(cbind(X,Y))
str(datos)
p1 <- ggplot(datos,aes(metcomp1,metcomp2))+theme_article() +
     geom_hline(yintercept = 0, color = "gray70") +
     geom_vline(xintercept = 0, color = "gray70") +
     geom_point(aes(color = Group,shape=Group2), alpha = 0.55, size = 3) +
     coord_cartesian(xlim = c(min(datos[,1]),max(datos[,1]))) +
     scale_fill_discrete(name = "Group")


      grafico1<- p1 + 
     labs(x = c(paste("PC1 Metabolome ")),
          y=c(paste("PC2 Metabolome "))) +
     theme(plot.title = element_text(hjust = 0.5),legend.position = "none") +
     scale_color_manual(values=1:3)
      
p2 <- ggplot(datos,aes(microcomp1,microcomp2))+theme_article() +
     geom_hline(yintercept = 0, color = "gray70") +
     geom_vline(xintercept = 0, color = "gray70") +
     geom_point(aes(color = Group,shape=Group2), alpha = 0.55, size = 3) +
     coord_cartesian(xlim = c(-5,6)) +
     scale_fill_discrete(name = "Group")


      grafico2<- p2 + 
     labs(x = c(paste("PC1 Microbiome ")),
          y=c(paste("PC2 Microbiome "))) +
     theme(plot.title = element_text(hjust = 0.5),legend.position = "none") +
     scale_color_manual(values=1:3)
      
p3 <- ggplot(datos,aes(metcomp1,microcomp1))+theme_article() +
     geom_hline(yintercept = 0, color = "gray70") +
     geom_vline(xintercept = 0, color = "gray70") +
     geom_point(aes(color = Group,shape=Group2), alpha = 0.55, size = 3) +
     coord_cartesian(xlim = c(min(datos[,1]),max(datos[,1]))) +
     scale_fill_discrete(name = "Group")


      grafico3<- p3 +  labs(x = c(paste("PC1 Metabolome ")),
          y=c(paste("PC1 Microbiome "))) +
     theme(plot.title = element_text(hjust = 0.5),legend.position = "none") +
     scale_color_manual(values=1:3)
      

p4 <- ggplot(datos,aes(metcomp1,microcomp2))+theme_article() +
     geom_hline(yintercept = 0, color = "gray70") +
     geom_vline(xintercept = 0, color = "gray70") +
     geom_point(aes(color = Group,shape=Group2), alpha = 0.55, size = 3) +
     coord_cartesian(xlim = c(min(datos[,1]),max(datos[,1]))) +
     scale_fill_discrete(name = "Group")


      grafico4<- p4 +
     labs(x = c(paste("PC1 Metabolome")),
          y=c(paste("PC2 Microbiome"))) + 
     theme(plot.title = element_text(hjust = 0.5),legend.position = "none") +
     scale_color_manual(values=1:3)     
      
pls2.plot <-ggarrange(grafico1,grafico2,grafico3,grafico4,common.legend = T,nrow=2,ncol=2,legend="bottom")

annotate_figure(pls2.plot, top = text_grob("Metabolome-Microbiome (phylum) Integration: PLS2", 
               color = "black", face = "bold", size = 14))
```


```{r}
X<-scale(metabolome.basal,scale=T)
Y<-genus.clr
datos <- list(metabolome = X,
              microbiome = Y)
pls_obj <- plsr(as.matrix(datos$metabolome)~as.matrix(datos$microbiome),
                val.type="CV",center=T,scale=T,explvar=T)

rho <- diag(cor(pls_obj$scores[,1:2],pls_obj$Yscores[,1:2]))

Group <- variables_in_bacteria$GROUP
Group2 <- variables_in_bacteria$OBESE
X<-pls_obj$scores
colnames(X)<-paste0("met",paste0("comp",1:length(colnames(X))))
Y<-pls_obj$Yscores
colnames(Y)<-paste0("micro",paste0("comp",1:length(colnames(Y))))
datos <- data.frame(cbind(X,Y))
str(datos)
p1 <- ggplot(datos,aes(metcomp1,metcomp2))+theme_article() +
     geom_hline(yintercept = 0, color = "gray70") +
     geom_vline(xintercept = 0, color = "gray70") +
     geom_point(aes(color = Group,shape=Group2), alpha = 0.55, size = 3) +
     coord_cartesian(xlim = c(min(datos[,1]),max(datos[,1]))) +
     scale_fill_discrete(name = "Group")


      grafico1<- p1 + 
     labs(x = c(paste("PC1 Metabolome ")),
          y=c(paste("PC2 Metabolome "))) +
     theme(plot.title = element_text(hjust = 0.5),legend.position = "none") +
     scale_color_manual(values=1:3)
      
p2 <- ggplot(datos,aes(microcomp1,microcomp2))+theme_article() +
     geom_hline(yintercept = 0, color = "gray70") +
     geom_vline(xintercept = 0, color = "gray70") +
     geom_point(aes(color = Group,shape=Group2), alpha = 0.55, size = 3) +
     coord_cartesian(xlim = c(-5,5)) +
     scale_fill_discrete(name = "Group")


      grafico2<- p2 + 
     labs(x = c(paste("PC1 Microbiome ")),
          y=c(paste("PC2 Microbiome "))) +
     theme(plot.title = element_text(hjust = 0.5),legend.position = "none") +
     scale_color_manual(values=1:3)
      
p3 <- ggplot(datos,aes(metcomp1,microcomp1))+theme_article() +
     geom_hline(yintercept = 0, color = "gray70") +
     geom_vline(xintercept = 0, color = "gray70") +
     geom_point(aes(color = Group,shape=Group2), alpha = 0.55, size = 3) +
     coord_cartesian(xlim = c(min(datos[,1]),max(datos[,1]))) +
     scale_fill_discrete(name = "Group")


      grafico3<- p3 +  labs(x = c(paste("PC1 Metabolome ")),
          y=c(paste("PC1 Microbiome "))) +
     theme(plot.title = element_text(hjust = 0.5),legend.position = "none") +
     scale_color_manual(values=1:3)
      

p4 <- ggplot(datos,aes(metcomp1,microcomp2))+theme_article() +
     geom_hline(yintercept = 0, color = "gray70") +
     geom_vline(xintercept = 0, color = "gray70") +
     geom_point(aes(color = Group,shape=Group2), alpha = 0.55, size = 3) +
     coord_cartesian(xlim = c(min(datos[,1]),max(datos[,1]))) +
     scale_fill_discrete(name = "Group")


      grafico4<- p4 +
     labs(x = c(paste("PC1 Metabolome")),
          y=c(paste("PC2 Microbiome"))) + 
     theme(plot.title = element_text(hjust = 0.5),legend.position = "none") +
     scale_color_manual(values=1:3)     
      
pls2.plot <-ggarrange(grafico1,grafico2,grafico3,grafico4,common.legend = T,nrow=2,ncol=2,legend="bottom")

annotate_figure(pls2.plot, top = text_grob("Metabolome-Microbiome (Genera) Integration: PLS2", 
               color = "black", face = "bold", size = 14))
```

## O2PLS

### phylum

#### Interaccion
```{r}


  datos <- list(metabolome = metabolome.basal,
              microbiome = phylum.clr)
  X<-scale(datos$metabolome)
  Y<-scale(datos$microbiome)
  n<-1
  while(n<2 ){
  res_cv <- crossval_o2m_adjR2(X, Y, 1:4, 0:4, 0:4, nr_folds = 3)
  res_cv_min_mse <- res_cv[which.min(res_cv[,1]),]
  n<-as.numeric(res_cv_min_mse[2])
  }
  
  nx <- as.numeric(res_cv_min_mse[3])
  ny <- as.numeric(res_cv_min_mse[4])
  
  res <- o2m2(X =X,Y = Y,n = n,nx = nx,ny = ny)
  
  print(c(n,nx,ny))

Group <- variables_in_bacteria$GROUP
Group2 <- variables_in_bacteria$OBESE
Tt<-data.frame(res$Tt)
colnames(Tt)<-paste0("jointX_",paste0("comp",1:length(colnames(Tt))))
U<-data.frame(res$U)
colnames(U)<-paste0("jointY_",paste0("comp",1:length(colnames(U))))
T_Y<-data.frame(res$T_Yosc)
colnames(T_Y)<-paste0("OrthX_"
                      ,paste0("comp",1:length(colnames(T_Y))))
U_X <- data.frame(res$U_Xosc)
colnames(U_X)<-paste0("OrthY_",
                      paste0("comp",1:length(colnames(U_X))))


## Firstly let's compute the joint variantes.

p1<- ggplot(Tt,aes(jointX_comp1,jointX_comp2))+theme_article() +
     geom_hline(yintercept = 0, color = "gray70") +
     geom_vline(xintercept = 0, color = "gray70") +
     geom_point(aes(color = Group,shape=Group2), alpha = 0.55, size = 3) +
     coord_cartesian(xlim = c(min(Tt[,1]),max(Tt[,1]))) +
     scale_fill_discrete(name = "Group")


      grafico1<- p1 + 
     labs(x = c(paste("Joint comp 1",round(100*res$R2Xcorr,2),"%")),
          y="Joint comp 2") +  
     ggtitle(paste("Metabolome",sep=" "))+ 
     theme(plot.title = element_text(hjust = 0.5,size=10),legend.position = "none",axis.title=element_text(size=9)
           ) +
     scale_color_manual(values=1:3)

p2<- ggplot(U,aes(jointY_comp1,jointY_comp2))+theme_article() +
     geom_hline(yintercept = 0, color = "gray70") +
     geom_vline(xintercept = 0, color = "gray70") +
     geom_point(aes(color = Group,shape=Group2), alpha = 0.55, size = 3) +
     coord_cartesian(xlim = c(min(U[,1]),max(U[,1]))) +
     scale_fill_discrete(name = "Group")


      grafico2<- p2 + 
     labs(x = c(paste("Joint comp 1",round(100*res$R2Ycorr,2),"%")),
          y="Joint comp 2") +  
     ggtitle(paste("Microbiome",sep=" "))+ 
     theme(plot.title = element_text(hjust = 0.5,size=10),legend.position = "none"
           ,axis.title=element_text(size=9)) +
     scale_color_manual(values=1:3)

## Now let-s compute joint between
      
datos <- data.frame(cbind(Tt,U))
p3<- ggplot(datos,aes(jointX_comp1,jointY_comp2))+theme_article() +
     geom_hline(yintercept = 0, color = "gray70") +
     geom_vline(xintercept = 0, color = "gray70") +
     geom_point(aes(color = Group,shape=Group2), alpha = 0.55, size = 3) +
     coord_cartesian(xlim = c(min(datos[,1]),max(datos[,1]))) +
     scale_fill_discrete(name = "Group")


      grafico3<- p3 + 
     labs(x = c(paste("Joint comp 1 Metabolome",round(100*res$R2Xcorr,2),"%")),
          y=c(paste("Joint comp 2 Micrbiome",round(100*res$R2Ycorr,2),"%"))) +  
     ggtitle(paste("Microbiome-Metabolome",sep=" "))+ 
     theme(plot.title = element_text(hjust = 0.5,size=10),legend.position = "none"
           ,axis.title=element_text(size=9)) +
     scale_color_manual(values=1:3)


##let's compute thre joint and orthogonal between 
      
      
datos <- data.frame(cbind(Tt,T_Y))
p4<- ggplot(datos,aes(jointX_comp1,OrthX_comp1))+theme_article() +
     geom_hline(yintercept = 0, color = "gray70") +
     geom_vline(xintercept = 0, color = "gray70") +
     geom_point(aes(color = Group,shape=Group2), alpha = 0.55, size = 3) +
     coord_cartesian(xlim = c(min(datos[,1]),max(datos[,1]))) +
     scale_fill_discrete(name = "Group")


      grafico4<- p4 + 
     labs(x = c(paste("Joint comp 1",round(100*res$R2Xcorr,2),"%")),
        y=c(paste("Orthogonal comp 1",round(100*res$R2X_YO,2),"%"))) +  
     ggtitle(paste("Metabolome",sep=" "))+ 
     theme(plot.title = element_text(hjust = 0.5,size=10),legend.position = "none"
           ,axis.title=element_text(size=9)) +
     scale_color_manual(values=1:3)

datos <- data.frame(cbind(U,U_X))
p5<- ggplot(datos,aes(jointY_comp1,OrthY_comp1))+theme_article() +
     geom_hline(yintercept = 0, color = "gray70") +
     geom_vline(xintercept = 0, color = "gray70") +
     geom_point(aes(color = Group,shape=Group2), alpha = 0.55, size = 3) +
     coord_cartesian(xlim = c(min(datos[,1]),max(datos[,1]))) +
     scale_fill_discrete(name = "Group")


      grafico5<- p5 + 
     labs(x = c(paste("Joint comp 1",round(100*res$R2Ycorr,2),"%")),
          y=c(paste("Orthogonal comp 1",round(100*res$R2Y_XO,2),"%"))) +  
     ggtitle(paste("Microbiome-Metabolome",sep=" "))+ 
     theme(plot.title = element_text(hjust = 0.5,size=10),legend.position = "none"
           ,axis.title=element_text(size=9)) +
     scale_color_manual(values=1:3)

## Now between orthogonal.
      
datos <- data.frame(cbind(T_Y,U_X))
p6<- ggplot(datos,aes(OrthX_comp1,OrthY_comp1))+theme_article() +
     geom_hline(yintercept = 0, color = "gray70") +
     geom_vline(xintercept = 0, color = "gray70") +
     geom_point(aes(color = Group,shape=Group2), alpha = 0.55, size = 3) +
     coord_cartesian(xlim = c(min(datos[,1]),max(datos[,1]))) +
     scale_fill_discrete(name = "Group")


      grafico6<- p6 + 
     labs(x = c(paste("Orthogonal Metabolome comp 1",round(100*res$R2X_YO,2),"%")),
          y=c(paste("Orthogonal Microbiome comp 1",round(100*res$R2Y_XO,2),"%"))) +  
     ggtitle(paste("Microbiome-Metabolome",sep=" "))+ 
     theme(plot.title = element_text(hjust = 0.5,size=10),legend.position = "none",axis.title=element_text(size=9)) +
     scale_color_manual(values=1:3)


o2pl2.plot <-ggarrange(grafico1,
grafico2,
grafico3,
grafico4,
grafico5,
grafico6,common.legend = T,legend="bottom")




annotate_figure(o2pl2.plot, top = text_grob("Metabolome-Microbiome (phylum) Integration: OPLS2", 
               color = "black", face = "bold", size = 14))
```


```{r}


  datos <- list(metabolome = scale(metabolome.basal,scale=T),
              microbiome = scale(genus.clr,scale=T))
  X<-scale(datos$metabolome)
  Y<-scale(datos$microbiome)
  n<-1
  while(n<2){
  res_cv <- crossval_o2m_adjR2(X, Y, 1:4, 0:4, 0:4, nr_folds = 3)
  res_cv_min_mse <- res_cv[which.min(res_cv[,1]),]
  n<-as.numeric(res_cv_min_mse[2])
  }
  
  nx <- as.numeric(res_cv_min_mse[3])
  ny <- as.numeric(res_cv_min_mse[4])
  
  res <- o2m2(X =X,Y = Y,n = n,nx = nx,ny = ny)
  
  

Group <- variables_in_bacteria$GROUP
Group2 <- variables_in_bacteria$OBESE
Tt<-data.frame(res$Tt)
colnames(Tt)<-paste0("jointX_",paste0("comp",1:length(colnames(Tt))))
U<-data.frame(res$U)
colnames(U)<-paste0("jointY_",paste0("comp",1:length(colnames(U))))
T_Y<-data.frame(res$T_Yosc)
colnames(T_Y)<-paste0("OrthX_"
                      ,paste0("comp",1:length(colnames(T_Y))))
U_X <- data.frame(res$U_Xosc)
colnames(U_X)<-paste0("OrthY_",
                      paste0("comp",1:length(colnames(U_X))))


## Firstly let's compute the joint variantes.

p1<- ggplot(Tt,aes(jointX_comp1,jointX_comp2))+theme_article() +
     geom_hline(yintercept = 0, color = "gray70") +
     geom_vline(xintercept = 0, color = "gray70") +
     geom_point(aes(color = Group,shape=Group2), alpha = 0.55, size = 3) +
     coord_cartesian(xlim = c(min(Tt[,1]),max(Tt[,1]))) +
     scale_fill_discrete(name = "Group")


      grafico1<- p1 + 
     labs(x = c(paste("Joint comp 1",round(100*res$R2Xcorr,2),"%")),
          y="Joint comp 2") +  
     ggtitle(paste("Metabolome",sep=" "))+ 
     theme(plot.title = element_text(hjust = 0.5,size=10),legend.position = "none",axis.title=element_text(size=9)
           ) +
     scale_color_manual(values=1:3)

p2<- ggplot(U,aes(jointY_comp1,jointY_comp2))+theme_article() +
     geom_hline(yintercept = 0, color = "gray70") +
     geom_vline(xintercept = 0, color = "gray70") +
     geom_point(aes(color = Group,shape=Group2), alpha = 0.55, size = 3) +
     coord_cartesian(xlim = c(min(U[,1]),max(U[,1]))) +
     scale_fill_discrete(name = "Group")


      grafico2<- p2 + 
     labs(x = c(paste("Joint comp 1",round(100*res$R2Ycorr,2),"%")),
          y="Joint comp 2") +  
     ggtitle(paste("Microbiome",sep=" "))+ 
     theme(plot.title = element_text(hjust = 0.5,size=10),legend.position = "none"
           ,axis.title=element_text(size=9)) +
     scale_color_manual(values=1:3)

## Now let-s compute joint between
      
datos <- data.frame(cbind(Tt,U))
p3<- ggplot(datos,aes(jointX_comp1,jointY_comp2))+theme_article() +
     geom_hline(yintercept = 0, color = "gray70") +
     geom_vline(xintercept = 0, color = "gray70") +
     geom_point(aes(color = Group,shape=Group2), alpha = 0.55, size = 3) +
     coord_cartesian(xlim = c(min(datos[,1]),max(datos[,1]))) +
     scale_fill_discrete(name = "Group")


      grafico3<- p3 + 
     labs(x = c(paste("Joint comp 1 Metabolome",round(100*res$R2Xcorr,2),"%")),
          y=c(paste("Joint comp 2 Micrbiome",round(100*res$R2Ycorr,2),"%"))) +  
     ggtitle(paste("Microbiome-Metabolome",sep=" "))+ 
     theme(plot.title = element_text(hjust = 0.5,size=10),legend.position = "none"
           ,axis.title=element_text(size=9)) +
     scale_color_manual(values=1:3)


##let's compute thre joint and orthogonal between 
      
      
datos <- data.frame(cbind(Tt,T_Y))
p4<- ggplot(datos,aes(jointX_comp1,OrthX_comp1))+theme_article() +
     geom_hline(yintercept = 0, color = "gray70") +
     geom_vline(xintercept = 0, color = "gray70") +
     geom_point(aes(color = Group,shape=Group2), alpha = 0.55, size = 3) +
     coord_cartesian(xlim = c(min(datos[,1]),max(datos[,1]))) +
     scale_fill_discrete(name = "Group")


      grafico4<- p4 + 
     labs(x = c(paste("Joint comp 1",round(100*res$R2Xcorr,2),"%")),
        y=c(paste("Orthogonal comp 1",round(100*res$R2X_YO,2),"%"))) +  
     ggtitle(paste("Metabolome",sep=" "))+ 
     theme(plot.title = element_text(hjust = 0.5,size=10),legend.position = "none"
           ,axis.title=element_text(size=9)) +
     scale_color_manual(values=1:3)

datos <- data.frame(cbind(U,U_X))
p5<- ggplot(datos,aes(jointY_comp1,OrthY_comp1))+theme_article() +
     geom_hline(yintercept = 0, color = "gray70") +
     geom_vline(xintercept = 0, color = "gray70") +
     geom_point(aes(color = Group,shape=Group2), alpha = 0.55, size = 3) +
     coord_cartesian(xlim = c(min(datos[,1]),max(datos[,1]))) +
     scale_fill_discrete(name = "Group")


      grafico5<- p5 + 
     labs(x = c(paste("Joint comp 1",round(100*res$R2Ycorr,2),"%")),
          y=c(paste("Orthogonal comp 1",round(100*res$R2Y_XO,2),"%"))) +  
     ggtitle(paste("Microbiome-Metabolome",sep=" "))+ 
     theme(plot.title = element_text(hjust = 0.5,size=10),legend.position = "none"
           ,axis.title=element_text(size=9)) +
     scale_color_manual(values=1:3)

## Now between orthogonal.
      
datos <- data.frame(cbind(T_Y,U_X))
p6<- ggplot(datos,aes(OrthX_comp1,OrthY_comp1))+theme_article() +
     geom_hline(yintercept = 0, color = "gray70") +
     geom_vline(xintercept = 0, color = "gray70") +
     geom_point(aes(color = Group,shape=Group2), alpha = 0.55, size = 3) +
     coord_cartesian(xlim = c(min(datos[,1]),max(datos[,1]))) +
     scale_fill_discrete(name = "Group")


      grafico6<- p6 + 
     labs(x = c(paste("Orthogonal Metabolome comp 1",round(100*res$R2X_YO,2),"%")),
          y=c(paste("Orthogonal Microbiome comp 1",round(100*res$R2Y_XO,2),"%"))) +  
     ggtitle(paste("Microbiome-Metabolome",sep=" "))+ 
     theme(plot.title = element_text(hjust = 0.5,size=10),legend.position = "none",axis.title=element_text(size=9)) +
     scale_color_manual(values=1:3)


o2pl2.plot <-ggarrange(grafico1,
grafico2,
grafico3,
grafico4,
grafico5,
grafico6,common.legend = T,legend="bottom")

annotate_figure(o2pl2.plot, top = text_grob("Metabolome-Microbiome (Genus) Integration: OPLS2", 
               color = "black", face = "bold", size = 14))
```

## DIABLO

<!-- ### Phylum -->


<!-- #### interaccion -->




<!-- We are going to keep all variables since we do not have the power. -->


<!-- ```{r} -->
<!-- datos <- list(metabolome = metabolome.basal, -->
<!--               microbiome = phylum.clr) -->
<!-- res1.pls.met_micro <- mixOmics::pls(datos$metabolome,datos$microbiome,ncomp=1) -->
<!-- (rho<-cor(res1.pls.met_micro$variates$X,res1.pls.met_micro$variates$Y)) -->

<!-- design = matrix(rho, ncol = length(datos), nrow = length(datos), -->
<!--                 dimnames = list(names(datos), names(datos))) -->
<!-- diag(design) = 0 -->
<!-- design -->

<!-- diablo.integro.interaccion<- block.splsda(datos,Y=interaccion, ncomp = 5, design = design) -->

<!-- set.seed(55) # For reproducibility, remove for your analyses -->
<!-- perf.diablo.integro.interaccion = mixOmics::perf(diablo.integro.interaccion, validation = 'Mfold', folds = 10, nrepeat = 5) -->

<!-- #perf.diablo.tcga$error.rate  # Lists the different types of error rates -->

<!-- # Plot of the error rates based on weighted vote -->
<!-- plot(perf.diablo.integro.interaccion) -->

<!-- (ncomp.interaccion <- perf.diablo.integro.interaccion$choice.ncomp$WeightedVote["Overall.BER", "centroids.dist"]) -->
<!-- sgccda.res_met_gen.interaccion = block.splsda(X = datos, Y = interaccion, ncomp = ncomp.interaccion, design = design) -->
<!-- ``` -->


<!-- ```{r} -->
<!-- plotDiablo(sgccda.res_met_gen.interaccion, ncomp = 1) -->
<!-- plotDiablo(sgccda.res_met_gen.interaccion, ncomp = 2) -->
<!-- plotDiablo(sgccda.res_met_gen.interaccion, ncomp = 3) -->
<!-- plotDiablo(sgccda.res_met_gen.interaccion, ncomp = 4) -->


<!-- #  -->
<!-- # plotIndiv(sgccda.res_met_gen.interaccion, ind.names = FALSE, legend = TRUE, title = 'DIABLO') -->

<!-- ``` -->

<!-- SCORE PLOT -->

<!-- ```{r} -->
<!-- Group <- variables_in_bacteria$GROUP -->
<!-- Group2 <- variables_in_bacteria$OBESE -->
<!-- X<-sgccda.res_met_gen.interaccion$variates$metabolome -->
<!-- colnames(X)<-paste0("met",colnames(X)) -->
<!-- Y<-sgccda.res_met_gen.interaccion$variates$microbiome -->
<!-- colnames(Y)<-paste0("micro",colnames(Y)) -->
<!-- datos <- data.frame(cbind(X,Y)) -->
<!-- str(datos) -->
<!-- p1 <- ggplot(datos,aes(metcomp1,metcomp2))+theme_article() + -->
<!--      geom_hline(yintercept = 0, color = "gray70") + -->
<!--      geom_vline(xintercept = 0, color = "gray70") + -->
<!--      geom_point(aes(color = Group,shape=Group2), alpha = 0.55, size = 3) + -->
<!--      coord_cartesian(xlim = c(min(datos[,1]),max(datos[,1]))) + -->
<!--      scale_fill_discrete(name = "Group") -->


<!--       grafico1<- p1 +  -->
<!--      labs(x = c(paste("PC1 Met",round(100*sgccda.res_met_gen.interaccion$prop_expl_var$metabolome[1],2),"%")), -->
<!--           y=c(paste("PC2 Met",round(100*sgccda.res_met_gen.interaccion$prop_expl_var$metabolome[2],2),"%"))) +   -->
<!--      ggtitle(paste("Metabolome",sep=" "))+  -->
<!--      theme(plot.title = element_text(hjust = 0.5),legend.position = "none") + -->
<!--      scale_color_manual(values=1:3) -->

<!-- p2 <- ggplot(datos,aes(microcomp1,microcomp2))+theme_article() + -->
<!--      geom_hline(yintercept = 0, color = "gray70") + -->
<!--      geom_vline(xintercept = 0, color = "gray70") + -->
<!--      geom_point(aes(color = Group,shape=Group2), alpha = 0.55, size = 3) + -->
<!--      coord_cartesian(xlim = c(min(datos[,1]),max(datos[,1]))) + -->
<!--      scale_fill_discrete(name = "Group") -->


<!--       grafico2<- p2 +  -->
<!--      labs(x = c(paste("PC1 Micro",round(100*sgccda.res_met_gen.interaccion$prop_expl_var$microbiome[1],2),"%")), -->
<!--           y=c(paste("PC2 Micro",round(100*sgccda.res_met_gen.interaccion$prop_expl_var$microbiome[2],2),"%"))) +   -->
<!--      ggtitle(paste("Microbiome",sep=" "))+  -->
<!--      theme(plot.title = element_text(hjust = 0.5),legend.position = "none") + -->
<!--      scale_color_manual(values=1:3) -->

<!-- p3 <- ggplot(datos,aes(metcomp1,microcomp1))+theme_article() + -->
<!--      geom_hline(yintercept = 0, color = "gray70") + -->
<!--      geom_vline(xintercept = 0, color = "gray70") + -->
<!--      geom_point(aes(color = Group,shape=Group2), alpha = 0.55, size = 3) + -->
<!--      coord_cartesian(xlim = c(min(datos[,1]),max(datos[,1]))) + -->
<!--      scale_fill_discrete(name = "Group") -->


<!--       grafico3<- p3 +  labs(x = c(paste("PC1 Met",round(100*sgccda.res_met_gen.interaccion$prop_expl_var$metabolome[1],2),"%")), -->
<!--           y=c(paste("PC1 Micro", -->
<!--                     round(100*sgccda.res_met_gen.interaccion$prop_expl_var$microbiome[1],2),"%"))) +   -->
<!--      ggtitle(paste("Metabolome-Microbiome",sep=" "))+  -->
<!--      theme(plot.title = element_text(hjust = 0.5),legend.position = "none") + -->
<!--      scale_color_manual(values=1:3) -->


<!-- p4 <- ggplot(datos,aes(metcomp1,microcomp2))+theme_article() + -->
<!--      geom_hline(yintercept = 0, color = "gray70") + -->
<!--      geom_vline(xintercept = 0, color = "gray70") + -->
<!--      geom_point(aes(color = Group,shape=Group2), alpha = 0.55, size = 3) + -->
<!--      coord_cartesian(xlim = c(min(datos[,1]),max(datos[,1]))) + -->
<!--      scale_fill_discrete(name = "Group") -->


<!--       grafico4<- p4 + -->
<!--      labs(x = c(paste("PC1 Meta",round(100*sgccda.res_met_gen.interaccion$prop_expl_var$metabolome[1],2),"%")), -->
<!--           y=c(paste("PC2 Micro",round(100*sgccda.res_met_gen.interaccion$prop_expl_var$microbiome[2],2),"%"))) +   -->
<!--      ggtitle(paste("Metabolome-Microbiome",sep=" "))+  -->
<!--      theme(plot.title = element_text(hjust = 0.5),legend.position = "none") + -->
<!--      scale_color_manual(values=1:3)      -->

<!-- p<-ggarrange(grafico1,grafico2,grafico3,grafico4,common.legend = T,nrow=2,ncol=2,legend="bottom") -->
<!-- annotate_figure(p, top = text_grob("Metabolome-Microbiome (phylum). DIABLO",  -->
<!--                color = "black", face = "bold", size = 14)) -->
<!-- ``` -->


<!-- ```{r} -->
<!-- p<-plotLoadings(sgccda.res_met_gen.interaccion,plot=F,contrib = "max") -->
<!-- p -->
<!-- ``` -->

<!-- LOADIGNS PLOT. -->


<!-- ```{r} -->
<!-- X <- data.frame(sgccda.res_met_gen.interaccion$loadings$metabolome) -->
<!-- Y <- data.frame(sgccda.res_met_gen.interaccion$loadings$microbiome) -->
<!-- # colnames(X) <-paste0("met",colnames(X)) -->
<!-- # colnames(Y) <- paste0("micro",colnames(Y)) -->
<!-- plot1 <- ggplot() +  -->
<!--     geom_point(data = X,aes(comp1,comp2),label=rownames(X),color="blue") +  -->
<!--   geom_text_repel(data=X,aes(comp1,comp2,label=rownames(X)),segment.size = 0.25, size = 3)+ -->
<!--     geom_point(data = Y,aes(comp1,comp2),color='black')+  -->
<!--   geom_text_repel(data=Y,aes(comp1,comp2,label=rownames(Y)),segment.size = 0.25, size = 5)+ggtitle("Loadings Plot") -->
<!-- plot1 -->
<!-- ``` -->



<!-- ```{r} -->

<!-- met_prop <- sgccda.res_met_gen.interaccion$prop_expl_var$metabolome -->
<!-- mic_prop <- sgccda.res_met_gen.interaccion$prop_expl_var$microbiome -->
<!-- var.exp <- 100*data.frame(met=met_prop,mic=mic_prop) -->
<!-- var.exp$comps <-rownames(var.exp) -->


<!-- p3<- ggplot(data=var.exp, aes(x=comps, y=met)) +  -->
<!--     geom_bar(stat="identity",col="black",fill="darkblue")+ -->
<!--     theme_article()+ -->
<!--   labs(y="Variation explained by Metabolome Data %",x="")+ -->
<!--   theme(axis.text=element_text(size=12,color = "black"))+coord_cartesian(ylim = c(-0,40))  -->

<!-- p4<- ggplot(data=var.exp, aes(x=comps, y=mic)) +  -->
<!--     geom_bar(stat="identity",col="black",fill="darkblue")+ -->
<!--     theme_article()+ -->
<!--   labs(y="Variation explained by Microbiome Data %",x="")+ -->
<!--   theme(axis.text=element_text(size=12,color = "black"))+coord_cartesian(ylim = c(-0,40))  -->



<!-- var.expl.plot <-ggarrange(p3,p4) -->
<!-- annotate_figure(var.expl.plot, top = text_grob("Explained Variation by Block",  -->
<!--                color = "black", face = "bold", size = 14)) -->
<!-- ``` -->


<!-- ```{r} -->
<!-- fn.contrib <- function(p,grupcon1,grupcon2){ -->

<!--   p.obj <-p[p[,"GroupContrib"]==grupcon1 & p[,paste0("Contrib.",grupcon2)]==T,] -->
<!--   p.obj$variable <- rownames(p.obj) -->
<!--   p.obj$variable<-factor(p.obj$variable, -->
<!--                          levels=p.obj$variable[order(p.obj$importance)]) -->
<!--   grafico <- ggplot(data=p.obj, aes(x=variable, y=importance)) +  -->
<!--     geom_bar(stat="identity",col="black",fill="blue") + coord_flip()+ -->
<!--     theme_article()+ggtitle(paste(c(unlist(strsplit(grupcon2,"[.]"))),collapse = " "))+theme(axis.text=element_text(size=8,color = "black")) -->
<!--   return(grafico) -->
<!-- } -->

<!-- p<-plotLoadings(sgccda.res_met_gen.interaccion,contrib = "max",block=1,plot=F,ndisplay = 10) -->
<!-- q<-plotLoadings(sgccda.res_met_gen.interaccion,contrib = "max",block=2,plot=F,ndisplay = 10) -->

<!-- (grupcon1. <- sort(unique(p$GroupContrib))) -->
<!-- (grupcon2. <- sort(colnames(p)[grep("^[cig]",invert = T,ignore.case = T,colnames(p))])) -->

<!-- grupos.con <-cbind(grupcon1.,grupcon2.) -->

<!-- aux1 <- list() -->
<!-- aux2 <- list() -->
<!-- for(i in 1:2){ -->

<!--   aux1[[i]]<-fn.contrib(p,grupcon1 = grupos.con[i,1],grupcon2 = grupos.con[i,2]) -->
<!--   aux2[[i]]<-fn.contrib(q,grupcon1 = grupos.con[i,1],grupcon2 = grupos.con[i,2]) -->
<!-- } -->

<!-- plot_female <- ggarrange(aux1[[1]],aux1[[2]],aux2[[1]],aux2[[2]]) -->
<!-- annotate_figure(plot_female, top = text_grob("Metabolome-Microbiome: Variable contributions: FEMALE",  -->
<!--                color = "black", face = "bold", size = 14)) -->


<!-- for(i in 3:4){ -->

<!--   aux1[[i]]<-fn.contrib(p,grupcon1 = grupos.con[i,1],grupcon2 = grupos.con[i,2]) -->
<!--   aux2[[i]]<-fn.contrib(q,grupcon1 = grupos.con[i,1],grupcon2 = grupos.con[i,2]) -->
<!-- } -->

<!-- plot_male <- ggarrange(aux1[[3]],aux1[[4]],aux2[[3]],aux2[[4]]) -->
<!-- annotate_figure(plot_male, top = text_grob("Metabolome-Microbiome: Variable contributions: MALE",  -->
<!--                color = "black", face = "bold", size = 14)) -->


<!-- for(i in 5:6){ -->

<!--   aux1[[i]]<-fn.contrib(p,grupcon1 = grupos.con[i,1],grupcon2 = grupos.con[i,2]) -->
<!--   aux2[[i]]<-fn.contrib(q,grupcon1 = grupos.con[i,1],grupcon2 = grupos.con[i,2]) -->
<!-- } -->

<!-- plot_pcos <- ggarrange(aux1[[5]],aux1[[6]],aux2[[5]],aux2[[6]]) -->
<!-- annotate_figure(plot_pcos, top = text_grob("Metabolome-Microbiome: Variable contributions: PCOS",  -->
<!--                color = "black", face = "bold", size = 14)) -->
<!-- ``` -->


<!-- ```{r} -->
<!-- plot_pcos <- ggarrange(aux1[[1]],aux2[[1]],aux1[[6]],aux2[[6]]) -->
<!-- annotate_figure(plot_pcos, top = text_grob("Metabolome-Microbiome: Variable contributions: \n Non-obese females and Obese PCOS ",  -->
<!--                color = "black", face = "bold", size = 14)) -->


<!-- ``` -->



<!-- ```{r} -->
<!-- p<-mixOmics::circosPlot(sgccda.res_met_gen.interaccion,cutoff=0.7,size.variables=0.5,showIntraLinks=F) -->
<!-- ``` -->


<!-- ```{r} -->

<!-- ``` -->


### Genera


#### interaccion




We are going to keep all variables since we do not have the power.


```{r}
datos <- list(metabolome = metabolome.basal,
              microbiome = genus.clr)
res1.pls.met_micro <- mixOmics::pls(datos$metabolome,datos$microbiome,ncomp=1)
(rho<-cor(res1.pls.met_micro$variates$X,res1.pls.met_micro$variates$Y))

design = matrix(rho, ncol = length(datos), nrow = length(datos),
                dimnames = list(names(datos), names(datos)))
diag(design) = 0
design

diablo.integro.interaccion<- block.splsda(datos,Y=interaccion, ncomp = 5, design = design)

set.seed(55) # For reproducibility, remove for your analyses
perf.diablo.integro.interaccion = mixOmics::perf(diablo.integro.interaccion, validation = 'Mfold', folds = 10, nrepeat = 5)

#perf.diablo.tcga$error.rate  # Lists the different types of error rates

# Plot of the error rates based on weighted vote
plot(perf.diablo.integro.interaccion)

(ncomp.interaccion <- perf.diablo.integro.interaccion$choice.ncomp$WeightedVote["Overall.BER", "centroids.dist"])
sgccda.res_met_gen.interaccion = block.splsda(X = datos, Y = interaccion, ncomp = ncomp.interaccion, design = design)

plotDiablo(sgccda.res_met_gen.interaccion, ncomp = 1)
plotDiablo(sgccda.res_met_gen.interaccion, ncomp = 2)
plotDiablo(sgccda.res_met_gen.interaccion, ncomp = 3)
plotDiablo(sgccda.res_met_gen.interaccion, ncomp = 4)
# plotDiablo(sgccda.res_met_gen.interaccion, ncomp = 5)


# 
# plotIndiv(sgccda.res_met_gen.interaccion, ind.names = FALSE, legend = TRUE, title = 'DIABLO')

```

SCORE PLOT

```{r}
Group <- variables_in_bacteria$GROUP
Group2 <- variables_in_bacteria$OBESE
X<-sgccda.res_met_gen.interaccion$variates$metabolome
colnames(X)<-paste0("met",colnames(X))
Y<-sgccda.res_met_gen.interaccion$variates$microbiome
colnames(Y)<-paste0("micro",colnames(Y))
datos <- data.frame(cbind(X,Y))
str(datos)
p1 <- ggplot(datos,aes(metcomp1,metcomp3,label=rownames(datos)))+theme_article() +
     geom_hline(yintercept = 0, color = "gray70") +
     geom_vline(xintercept = 0, color = "gray70") + geom_text_repel(size=1.5)+
     geom_point(aes(color = Group,shape=Group2), alpha = 0.55, size = 3) +
     coord_cartesian(xlim = c(min(datos[,1]),max(datos[,1]))) +
     scale_fill_discrete(name = "Group")


      grafico1<- p1 + 
     labs(x = c(paste("PC1 Met",round(100*sgccda.res_met_gen.interaccion$prop_expl_var$metabolome[1],2),"%")),
          y=c(paste("PC3 Met",round(100*sgccda.res_met_gen.interaccion$prop_expl_var$metabolome[3],2),"%"))) +  
     ggtitle(paste("Metabolome",sep=" "))+ 
     theme(plot.title = element_text(hjust = 0.5),legend.position = "none") +
     scale_color_manual(values=1:3)
      
p2 <- ggplot(datos,aes(microcomp1,microcomp4))+theme_article() +
     geom_hline(yintercept = 0, color = "gray70") +
     geom_vline(xintercept = 0, color = "gray70") +
     geom_point(aes(color = Group,shape=Group2), alpha = 0.55, size = 3) +
     coord_cartesian(xlim = c(-5,5)) +
     scale_fill_discrete(name = "Group")


      grafico2<- p2 + 
     labs(x = c(paste("PC1 Micro",round(100*sgccda.res_met_gen.interaccion$prop_expl_var$microbiome[1],2),"%")),
          y=c(paste("PC4 Micro",round(100*sgccda.res_met_gen.interaccion$prop_expl_var$microbiome[4],2),"%"))) +  
     ggtitle(paste("Microbiome",sep=" "))+ 
     theme(plot.title = element_text(hjust = 0.5),legend.position = "none") +
     scale_color_manual(values=1:3)
      
p3 <- ggplot(datos,aes(metcomp3,microcomp4))+theme_article() +
     geom_hline(yintercept = 0, color = "gray70") +
     geom_vline(xintercept = 0, color = "gray70") +
     geom_point(aes(color = Group,shape=Group2), alpha = 0.55, size = 3) +
     coord_cartesian(xlim = c(-5,5.5)) +
     scale_fill_discrete(name = "Group")


      grafico3<- p3 +  labs(x = c(paste("PC3 Met",round(100*sgccda.res_met_gen.interaccion$prop_expl_var$metabolome[3],2),"%")),
          y=c(paste("PC4 Micro",
                    round(100*sgccda.res_met_gen.interaccion$prop_expl_var$microbiome[4],2),"%"))) +  
     ggtitle(paste("Metabolome-Microbiome",sep=" "))+ 
     theme(plot.title = element_text(hjust = 0.5),legend.position = "none") +
     scale_color_manual(values=1:3)
      

p4 <- ggplot(datos,aes(metcomp1,microcomp4))+theme_article() +
     geom_hline(yintercept = 0, color = "gray70") +
     geom_vline(xintercept = 0, color = "gray70") +
     geom_point(aes(color = Group,shape=Group2), alpha = 0.55, size = 3) +
     coord_cartesian(xlim = c(min(datos[,1]),max(datos[,1]))) +
     scale_fill_discrete(name = "Group")


      grafico4<- p4 +
     labs(x = c(paste("PC1 Meta",round(100*sgccda.res_met_gen.interaccion$prop_expl_var$metabolome[1],2),"%")),
          y=c(paste("PC4 Micro",round(100*sgccda.res_met_gen.interaccion$prop_expl_var$microbiome[4],2),"%"))) +  
     ggtitle(paste("Metabolome-Microbiome",sep=" "))+ 
     theme(plot.title = element_text(hjust = 0.5),legend.position = "none") +
     scale_color_manual(values=1:3)     
      
p<-ggarrange(grafico1,grafico2,grafico3,grafico4,common.legend = T,ncol=2,nrow=2,legend="bottom")
annotate_figure(p, top = text_grob("Metabolome-Microbiome (Genera). DIABLO", 
               color = "black", face = "bold", size = 14))
```






```{r}
p<-plotLoadings(sgccda.res_met_gen.interaccion,plot=F,contrib = "max")
p
```

LOADIGNS PLOT.


```{r}
X <- data.frame(sgccda.res_met_gen.interaccion$loadings$metabolome)
Y <- data.frame(sgccda.res_met_gen.interaccion$loadings$microbiome)
# colnames(X) <-paste0("met",colnames(X))
# colnames(Y) <- paste0("micro",colnames(Y))
plot1 <- ggplot() + 
    geom_point(data = X,aes(comp1,comp2),label=rownames(X),color="blue") + 
  geom_text_repel(data=X,aes(comp1,comp2,label=rownames(X)),segment.size = 0.25, size = 2)+
    geom_point(data = Y,aes(comp1,comp2),color='black')+ 
  geom_text_repel(data=Y,aes(comp1,comp2,label=rownames(Y)),segment.size = 0.25, size = 3)+ggtitle("Loadings Plot")
plot1
```



```{r}

met_prop <- sgccda.res_met_gen.interaccion$prop_expl_var$metabolome
mic_prop <- sgccda.res_met_gen.interaccion$prop_expl_var$microbiome
var.exp <- 100*data.frame(met=met_prop,mic=mic_prop)
var.exp$comps <-rownames(var.exp)


p3<- ggplot(data=var.exp, aes(x=comps, y=met)) + 
    geom_bar(stat="identity",col="black",fill="darkblue")+
    theme_article()+
  labs(y="Variation explained by Metabolome Data %",x="")+
  theme(axis.text=element_text(size=12,color = "black"))+coord_cartesian(ylim = c(-0,40)) 

p4<- ggplot(data=var.exp, aes(x=comps, y=mic)) + 
    geom_bar(stat="identity",col="black",fill="darkblue")+
    theme_article()+
  labs(y="Variation explained by Microbiome Data %",x="")+
  theme(axis.text=element_text(size=12,color = "black"))+coord_cartesian(ylim = c(-0,40)) 



var.expl.plot <-ggarrange(p3,p4)
annotate_figure(var.expl.plot, top = text_grob("Explained Variation by Block", 
               color = "black", face = "bold", size = 14))
```


```{r}
fn.contrib <- function(p,grupcon1,grupcon2){
  
  p.obj <-p[p[,"GroupContrib"]==grupcon1 & p[,paste0("Contrib.",grupcon2)]==T,]
  if(dim(p.obj)[1]>10){
    
    p.obj<-p.obj[1:10,]
    
  }
  p.obj$variable <- rownames(p.obj)
  p.obj$variable<-factor(p.obj$variable,
                         levels=p.obj$variable[order(p.obj$importance)])
  grafico <- ggplot(data=p.obj, aes(x=variable, y=importance)) + 
    geom_bar(stat="identity",col="black",fill="blue") + coord_flip()+
    theme_article()+ggtitle(paste(c(unlist(strsplit(grupcon2,"[.]"))),collapse = " "))+theme(axis.text=element_text(size=8,color = "black"),plot.title=element_text(size=9))+labs(x="",y="")
  return(grafico)
}

p<-plotLoadings(sgccda.res_met_gen.interaccion,contrib = "max",block=1,plot=F,ndisplay = 50)
q<-plotLoadings(sgccda.res_met_gen.interaccion,contrib = "max",block=2,plot=F,ndisplay = 50)

(grupcon1. <- sort(unique(p$GroupContrib)))
(grupcon2. <- sort(colnames(p)[grep("^[cig]",invert = T,ignore.case = T,colnames(p))]))

grupos.con <-cbind(grupcon1.,grupcon2.)

aux1 <- list()
aux2 <- list()
for(i in 1:2){
  
  aux1[[i]]<-fn.contrib(p,grupcon1 = grupos.con[i,1],grupcon2 = grupos.con[i,2])
  aux2[[i]]<-fn.contrib(q,grupcon1 = grupos.con[i,1],grupcon2 = grupos.con[i,2])
}

plot_female <- ggarrange(aux1[[1]],aux1[[2]],aux2[[1]],aux2[[2]])
annotate_figure(plot_female, top = text_grob("Metabolome-Microbiome: Variable contributions: FEMALE", 
               color = "black", face = "bold", size = 14))


for(i in 3:4){
  
  aux1[[i]]<-fn.contrib(p,grupcon1 = grupos.con[i,1],grupcon2 = grupos.con[i,2])
  aux2[[i]]<-fn.contrib(q,grupcon1 = grupos.con[i,1],grupcon2 = grupos.con[i,2])
}

plot_male <- ggarrange(aux1[[3]],aux1[[4]],aux2[[3]],aux2[[4]])
annotate_figure(plot_male, top = text_grob("Metabolome-Microbiome: Variable contributions: MALE", 
               color = "black", face = "bold", size = 14))


for(i in 5:6){
  
  aux1[[i]]<-fn.contrib(p,grupcon1 = grupos.con[i,1],grupcon2 = grupos.con[i,2])
  aux2[[i]]<-fn.contrib(q,grupcon1 = grupos.con[i,1],grupcon2 = grupos.con[i,2])
}

plot_pcos <- ggarrange(aux1[[5]],aux1[[6]],aux2[[5]],aux2[[6]])
annotate_figure(plot_pcos, top = text_grob("Metabolome-Microbiome: Variable contributions: PCOS", 
               color = "black", face = "bold", size = 14))
```



```{r}
p<-mixOmics::circosPlot(sgccda.res_met_gen.interaccion,cutoff=0.5,size.variables=0.9,showIntraLinks=F)
```

```{r}

```




```{r}
mat <- cimDiablo(sgccda.res_met_gen.interaccion,dist.method=c("euclidean","correlation"))$mat
variables_in_bacteria$interaccion <- with(variables_in_bacteria,interaction(OBESE,GROUP))
pcos.obe <- mat[variables_in_bacteria[variables_in_bacteria$interaccion=="Obese.PCOS","Paciente"],]

```


```{r}
# barplot(colMeans(pcosmat[,apply(abs(pcosmat)>2.7, 2, any)]),las=3,cex.names = 0.7,ylim=c(-0.7,1.5),col="steelblue",main="\n Mean correlation between variables \n and \n Obese PCOS women")
```


```{r}
mat <- cimDiablo(sgccda.res_met_gen.interaccion,dist.method=c("euclidean","correlation"))$mat
variables_in_bacteria$interaccion <- with(variables_in_bacteria,interaction(OBESE,GROUP))
pcos.obe <- mat[variables_in_bacteria[variables_in_bacteria$interaccion=="No Obese.PCOS","Paciente"],]
pcosmat <- cim(pcos.obe,dist.method=c("euclidean","correlation"))$mat
pcosmat.mean<-colMeans(pcosmat)
barplot(pcosmat.mean[abs(pcosmat.mean)>0.5],las=2,cex.names = 0.5)

cim(pcosmat[,apply(abs(pcosmat)>2.7, 2, any)],keysize = c(1,1),keysize.label = 1,margins=c(7,7),title="Euclidean Distance: PCOS lean women \n and Pearson Correlation between variables",cutoff=0.9)

```




# TOTAL INTEGRATION

<!-- ## Blocks with Phykum data transformed -->


<!-- Firstly let's investigate the relationship between blocks. -->

<!-- ```{r} -->

<!-- datos <- list(clinical_data = Clin, -->
<!--               IP =IP.basal, -->
<!--               metabolome = metabolome.basal, -->
<!--               microbiome = phylum.clr) -->

<!-- res1.pls.met_micro <- mixOmics::pls(datos$metabolome,datos$microbiome,ncomp=1) -->
<!-- (rho_met_micro <- cor(res1.pls.met_micro$variates$X,res1.pls.met_micro$variates$Y)) -->

<!-- res1.pls.met_IP <- mixOmics::pls(datos$IP,datos$metabolome,ncomp = 1) -->
<!-- (rho_met_ip <- cor(res1.pls.met_IP$variates$X,res1.pls.met_IP$variates$Y)) -->

<!-- res1.pls.met_clin <- mixOmics::pls(datos$metabolome,datos$clinical_data,ncomp=1) -->
<!-- (rho_pls_met_clin <- cor(res1.pls.met_clin$variates$X,res1.pls.met_clin$variates$Y)) -->

<!-- res1.pls_micro_clin <- mixOmics::pls(datos$microbiome,datos$clinical_data,ncomp=1) -->
<!-- (rho_pls_micro_clin <- cor(res1.pls_micro_clin$variates$X,res1.pls_micro_clin$variates$Y)) -->

<!-- res1.pls_micro_IP <- mixOmics::pls(datos$microbiome,datos$IP,ncomp = 1) -->
<!-- (rho_pls_micro_IP <- cor(res1.pls_micro_IP$variates$X,res1.pls_micro_IP$variates$Y)) -->

<!-- res1.pls_IP_clin <- mixOmics::pls(datos$IP,datos$clinical_data,ncomp = 1) -->
<!-- (rho_pls_IP_clin <- cor(res1.pls_IP_clin$variates$X,res1.pls_IP_clin$variates$Y)) -->

<!-- design =matrix(c(0,rho_pls_IP_clin,rho_pls_met_clin,rho_pls_micro_clin, -->
<!--          rho_pls_IP_clin,0,rho_met_ip,rho_pls_micro_IP, -->
<!--          rho_pls_met_clin,rho_met_ip,0,rho_met_micro, -->
<!--          rho_pls_micro_clin,rho_pls_micro_IP,rho_met_micro,0),ncol = 4,dimnames = list(names(datos),names(datos))) -->
<!-- design -->
<!-- ``` -->

<!-- Now let's observe the optimal number of components. -->

<!-- ```{r} -->
<!-- names(interaccion)<-variables_in_bacteria$Paciente -->
<!-- sgccda.res_total_1 = block.splsda(X = datos, Y=interaccion, ncomp = 7, -->
<!--                            design = design) -->

<!-- set.seed(123) # for reproducibility, only when the `cpus' argument is not used -->
<!-- # this code takes a couple of min to run -->
<!-- perf.diablo_toltal_1 = mixOmics::perf(sgccda.res_total_1, validation = 'Mfold', folds = 5, nrepeat = 3) -->

<!-- #perf.diablo  # lists the different outputs -->
<!-- plot(perf.diablo_toltal_1) -->
<!-- ``` -->


<!-- ```{r} -->
<!-- perf.diablo_toltal_1$choice.ncomp$WeightedVote -->
<!-- (ncomp = perf.diablo_toltal_1$choice.ncomp$WeightedVote["Overall.BER", "centroids.dist"]) -->

<!-- ``` -->

<!-- ```{r} -->

<!-- sgccda.res_genus = block.splsda(X = datos, Y = interaccion, ncomp = ncomp, design = design) -->
<!-- ``` -->



<!-- ```{r} -->
<!-- plotDiablo(sgccda.res_genus, ncomp = 5) -->

<!-- ``` -->


<!-- ```{r} -->
<!-- plotIndiv(sgccda.res_genus, ind.names = FALSE, legend = TRUE, title = 'DIABLO',study="global") -->

<!-- ``` -->


<!-- SCORE PLOT -->


<!-- ```{r} -->
<!-- Group <- variables_in_bacteria$GROUP -->
<!-- Group2 <- variables_in_bacteria$OBESE -->
<!-- X<-data.frame(sgccda.res_genus$variates$clinical_data) -->
<!-- colnames(X)<-paste0("C_",colnames(X)) -->
<!-- Y<-data.frame(sgccda.res_genus$variates$IP) -->
<!-- colnames(Y)<-paste0("IP_",colnames(Y)) -->
<!-- Z <- data.frame(sgccda.res_genus$variates$metabolome) -->
<!-- colnames(Z) <- paste0("Met_",colnames(Z)) -->
<!-- W <- data.frame(sgccda.res_genus$variates$microbiome) -->
<!-- colnames(W) <- paste0("Micro_",colnames(W)) -->

<!-- p1 <- ggplot(X,aes(C_comp1,C_comp2))+theme_article() + -->
<!--      geom_hline(yintercept = 0, color = "gray70") + -->
<!--      geom_vline(xintercept = 0, color = "gray70") + -->
<!--      geom_point(aes(color = Group,shape=Group2), alpha = 0.55, size = 3) + -->
<!--      coord_cartesian(xlim = c(min(X[,1]),max(X[,1]))) + -->
<!--      scale_fill_discrete(name = "Group") -->


<!--       grafico1<- p1 +  -->
<!--      labs(x = c(paste("PC1 Cinic",round(100*sgccda.res_genus$prop_expl_var$clinical_data[1],2),"%")), -->
<!--           y=c(paste("PC2 Clinic",round(100*sgccda.res_genus$prop_expl_var$clinical_data[2],2),"%"))) +   -->
<!--      ggtitle(paste("Clinical Data",sep=" "))+  -->
<!--      theme(plot.title = element_text(hjust = 0.5),legend.position = "none") + -->
<!--      scale_color_manual(values=1:3) -->

<!-- p2 <- ggplot(Y,aes(IP_comp1,IP_comp2))+theme_article() + -->
<!--      geom_hline(yintercept = 0, color = "gray70") + -->
<!--      geom_vline(xintercept = 0, color = "gray70") + -->
<!--      geom_point(aes(color = Group,shape=Group2), alpha = 0.55, size = 3) + -->
<!--      coord_cartesian(xlim = c(min(Y[,1]),max(Y[,1]))) + -->
<!--      scale_fill_discrete(name = "Group") -->


<!--       grafico2<- p2 +  -->
<!--      labs(x = c(paste("PC1 IP",round(100*sgccda.res_genus$prop_expl_var$IP[1],2),"%")), -->
<!--           y=c(paste("PC2 IP",round(100*sgccda.res_genus$prop_expl_var$IP[2],2),"%"))) +   -->
<!--      ggtitle(paste("IP data",sep=" "))+  -->
<!--      theme(plot.title = element_text(hjust = 0.5),legend.position = "none") + -->
<!--      scale_color_manual(values=1:3) -->

<!-- p3 <- ggplot(Z,aes(Met_comp1,Met_comp2))+theme_article() + -->
<!--      geom_hline(yintercept = 0, color = "gray70") + -->
<!--      geom_vline(xintercept = 0, color = "gray70") + -->
<!--      geom_point(aes(color = Group,shape=Group2), alpha = 0.55, size = 3) + -->
<!--      coord_cartesian(xlim = c(min(Z[,1]),max(Z[,1]))) + -->
<!--      scale_fill_discrete(name = "Group") -->


<!--       grafico3<- p3 +  labs(x = c(paste("PC1 Metabolome",round(100*sgccda.res_genus$prop_expl_var$metabolome[1],2),"%")), -->
<!--           y=c(paste("PC3 Metabolome", -->
<!--                     round(100*sgccda.res_genus$prop_expl_var$metabolome[3],2),"%"))) +   -->
<!--      ggtitle(paste("Metabolome data",sep=" "))+  -->
<!--      theme(plot.title = element_text(hjust = 0.5),legend.position = "none") + -->
<!--      scale_color_manual(values=1:3) -->


<!-- p4 <- ggplot(W,aes(Micro_comp1,Micro_comp2))+theme_article() + -->
<!--      geom_hline(yintercept = 0, color = "gray70") + -->
<!--      geom_vline(xintercept = 0, color = "gray70") + -->
<!--      geom_point(aes(color = Group,shape=Group2), alpha = 0.55, size = 3) + -->
<!--      coord_cartesian(xlim = c(min(W[,1]),max(W[,1]))) + -->
<!--      scale_fill_discrete(name = "Group") -->


<!--       grafico4<- p4 + -->
<!--      labs(x = c(paste("PC1 Microbiome",round(100*sgccda.res_genus$prop_expl_var$microbiome[1],2),"%")), -->
<!--           y=c(paste("PC2 MIcrobiome",round(100*sgccda.res_genus$prop_expl_var$microbiome[2],2),"%"))) +   -->
<!--      ggtitle(paste("Microbiome data",sep=" "))+  -->
<!--      theme(plot.title = element_text(hjust = 0.5),legend.position = "none") + -->
<!--      scale_color_manual(values=1:3)      -->

<!-- p<-ggarrange(grafico1,grafico2,grafico3,grafico4,common.legend = T,nrow=2,ncol=2,legend="bottom") -->
<!-- annotate_figure(p, top = text_grob("Basal Integration with Phylum: DIABLO",  -->
<!--                color = "black", face = "bold", size = 14)) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- (p<-plotLoadings(sgccda.res_genus,plot=F,contrib = "min",comp = 1)) -->
<!-- ``` -->





<!-- ```{r} -->
<!-- p<-plotLoadings(sgccda.res_genus,contrib = "max",block=1,plot=F,method="mean",comp=1) -->
<!-- q<-plotLoadings(sgccda.res_genus,contrib = "max",block=2,plot=F,method="mean",comp=1) -->
<!-- r<-plotLoadings(sgccda.res_genus,contrib = "max",block=3,plot=F,method="mean",comp=1) -->
<!-- s<-plotLoadings(sgccda.res_genus,contrib = "max",block=4,plot=F,method="mean",comp=1) -->

<!-- (grupcon1. <- sort(unique(p$GroupContrib))) -->
<!-- (grupcon2. <- sort(colnames(p)[grep("^[cig]",invert = T,ignore.case = T,colnames(p))])) -->

<!-- grupos.con <-cbind(grupcon1.,grupcon2.) -->

<!-- lista_loads <- list(p,q,r,s) -->
<!-- aux1 <- vector(mode = "list",length=4) -->
<!-- block.name <-c("Clinical","IP","Metabolome","Microbiome") -->
<!-- for(i in 1:length(lista_loads)){ -->

<!--   aux1[[i]]<-fn.contrib(lista_loads[[i]], -->
<!--                         grupcon1 = grupos.con[1,1], -->
<!--                         grupcon2 = grupos.con[1,2])+labs(x=block.name[i]) -->
<!-- } -->

<!-- plot_female <- ggarrange(aux1[[1]],aux1[[2]],aux1[[3]],aux1[[4]]) -->
<!-- annotate_figure(plot_female, top = text_grob("All blocks-Variable contributions",  -->
<!--                color = "black", face = "bold", size = 14)) -->

<!-- aux2 <- vector(mode = "list",length=4) -->
<!-- for(i in 1:length(lista_loads)){ -->

<!--   aux2[[i]]<-fn.contrib(lista_loads[[i]], -->
<!--                         grupcon1 = grupos.con[2,1], -->
<!--                         grupcon2 = grupos.con[2,2])+labs(x=block.name[i]) -->
<!-- } -->

<!-- plot_female_obese <- ggarrange(aux2[[1]],aux2[[2]],aux2[[3]],aux2[[4]]) -->
<!-- annotate_figure(plot_female_obese, top = text_grob("All blocks-Variable contributions",  -->
<!--                color = "black", face = "bold", size = 14)) -->


<!-- aux3 <- vector(mode = "list",length=4) -->
<!-- for(i in 1:length(lista_loads)){ -->

<!--   aux3[[i]]<-fn.contrib(lista_loads[[i]], -->
<!--                         grupcon1 = grupos.con[3,1], -->
<!--                         grupcon2 = grupos.con[3,2])+labs(x=block.name[i]) -->
<!-- } -->

<!-- plot_male <- ggarrange(aux3[[1]],aux3[[2]],aux3[[3]],aux3[[4]]) -->
<!-- annotate_figure(plot_male, top = text_grob("All blocks-Variable contributions",  -->
<!--                color = "black", face = "bold", size = 14)) -->





<!-- aux4 <- vector(mode = "list",length=4) -->
<!-- for(i in 1:length(lista_loads)){ -->

<!--   aux4[[i]]<-fn.contrib(lista_loads[[i]], -->
<!--                         grupcon1 = grupos.con[4,1], -->
<!--                         grupcon2 = grupos.con[4,2])+labs(x=block.name[i]) -->
<!-- } -->

<!-- plot_male_obese <- ggarrange(aux4[[1]],aux4[[2]],aux4[[3]],aux4[[4]]) -->
<!-- annotate_figure(plot_male_obese, top = text_grob("All blocks-Variable contributions",  -->
<!--                color = "black", face = "bold", size = 14)) -->


<!-- aux5 <- vector(mode = "list",length=4) -->
<!-- for(i in 1:length(lista_loads)){ -->

<!--   aux5[[i]]<-fn.contrib(lista_loads[[i]], -->
<!--                         grupcon1 = grupos.con[5,1], -->
<!--                         grupcon2 = grupos.con[5,2])+labs(x=block.name[i]) -->
<!-- } -->

<!-- plot_pcos <- ggarrange(aux5[[1]],aux5[[2]],aux5[[3]],aux5[[4]]) -->
<!-- annotate_figure(plot_pcos, top = text_grob("All blocks-Variable contributions",  -->
<!--                color = "black", face = "bold", size = 14)) -->

<!-- aux6 <- vector(mode = "list",length=4) -->
<!-- for(i in 1:length(lista_loads)){ -->

<!--   aux6[[i]]<-fn.contrib(lista_loads[[i]], -->
<!--                         grupcon1 = grupos.con[6,1], -->
<!--                         grupcon2 = grupos.con[6,2])+labs(x=block.name[i]) -->
<!-- } -->

<!-- plot_pcos_obese <- ggarrange(aux6[[1]],aux6[[2]],aux6[[3]],aux6[[4]]) -->
<!-- annotate_figure(plot_pcos_obese, top = text_grob("All blocks-Variable contributions",  -->
<!--                color = "black", face = "bold", size = 14)) -->



<!-- ``` -->



<!-- ```{r} -->
<!-- c_prop<-sgccda.res_genus$prop_expl_var$clinical_data -->
<!-- ip_prop <- sgccda.res_genus$prop_expl_var$IP -->
<!-- met_prop <- sgccda.res_genus$prop_expl_var$metabolome -->
<!-- mic_prop <- sgccda.res_genus$prop_expl_var$microbiome -->
<!-- Y_prop<-sgccda.res_genus$prop_expl_var$Y -->
<!-- var.exp <- 100*data.frame(clinical=c_prop,ip=ip_prop,met=met_prop,mic=mic_prop,Y=Y_prop) -->
<!-- var.exp$comps <-rownames(var.exp) -->
<!-- p1<- ggplot(data=var.exp, aes(x=comps, y=clinical)) +  -->
<!--     geom_bar(stat="identity",col="black",fill="darkblue")+ -->
<!--     theme_article()+ -->
<!--   labs(y="Variation explained by Clinical Data %",x="")+ -->
<!--   theme(axis.text=element_text(size=12,color = "black"))+coord_cartesian(ylim = c(-0,35))  -->

<!-- p2<- ggplot(data=var.exp, aes(x=comps, y=ip)) +  -->
<!--     geom_bar(stat="identity",col="black",fill="darkblue")+ -->
<!--     theme_article()+ -->
<!--   labs(y="Variation explained by IP Data %",x="")+ -->
<!--   theme(axis.text=element_text(size=12,color = "black"))+coord_cartesian(ylim = c(-0,35))  -->

<!-- p3<- ggplot(data=var.exp, aes(x=comps, y=met)) +  -->
<!--     geom_bar(stat="identity",col="black",fill="darkblue")+ -->
<!--     theme_article()+ -->
<!--   labs(y="Variation explained by Metabolome Data %",x="")+ -->
<!--   theme(axis.text=element_text(size=12,color = "black"))+coord_cartesian(ylim = c(-0,35))  -->

<!-- p4<- ggplot(data=var.exp, aes(x=comps, y=mic)) +  -->
<!--     geom_bar(stat="identity",col="black",fill="darkblue")+ -->
<!--     theme_article()+ -->
<!--   labs(y="Variation explained by Microbiome Data %",x="")+ -->
<!--   theme(axis.text=element_text(size=12,color = "black"))+coord_cartesian(ylim = c(-0,35))  -->

<!-- p5<- ggplot(data=var.exp, aes(x=comps, y=Y)) +  -->
<!--     geom_bar(stat="identity",col="black",fill="darkblue")+ -->
<!--     theme_article()+ -->
<!--   labs(y="Variation explained by thre response %",x="")+ -->
<!--   theme(axis.text=element_text(size=12,color = "black"))+coord_cartesian(ylim = c(-0,35))  -->

<!-- var.expl.plot <-ggarrange(p1,p2,p3,p4) -->
<!-- annotate_figure(var.expl.plot, top = text_grob("Explained Variation by Block",  -->
<!--                color = "black", face = "bold", size = 14)) -->
<!-- ``` -->



<!-- ```{r} -->
<!-- X <- data.frame(sgccda.res_genus$loadings$clinical_data) -->
<!-- Y <- data.frame(sgccda.res_genus$loadings$IP) -->
<!-- Z <- data.frame(sgccda.res_genus$loadings$metabolome) -->
<!-- W <- data.frame(sgccda.res_genus$loadings$microbiome) -->
<!-- # colnames(X) <-paste0("met",colnames(X)) -->
<!-- # colnames(Y) <- paste0("micro",colnames(Y)) -->
<!-- plot1 <- ggplot() +  -->
<!--     geom_point(data = X,aes(comp1,comp2),label=rownames(X),color="blue") +  -->
<!--   geom_text_repel(data=X,aes(comp1,comp2, -->
<!--                              label=rownames(X)), -->
<!--                   segment.size = 0.25, size = 2)+coord_cartesian(xlim = -->
<!--                                                           c(-0.4,0.4), -->
<!--                                                           ylim= c(-0.4,0.4))+theme_article()+geom_hline(yintercept = 0, color = "gray70") + -->
<!--      geom_vline(xintercept = 0, color = "gray70") +labs(x="")+ggtitle("Clinical") -->


<!-- plot2 <- ggplot()+geom_point(data = Y,aes(comp1,comp2),color='blue')+  -->
<!--   geom_text_repel(data=Y,aes(comp1,comp2,label=rownames(Y)), -->
<!--                   segment.size = 0.25, size = 3)+coord_cartesian(xlim = -->
<!--                                                           c(-0.5,0.5), -->
<!--                                                           ylim= c(-0.5,0.5))+theme_article()+geom_hline(yintercept = 0, color = "gray70") + -->
<!--      geom_vline(xintercept = 0, color = "gray70") + labs(x="",y="")+ggtitle("IP") -->
<!-- plot3 <- ggplot()+geom_point(data = Z,aes(comp1,comp3),color='blue')+  -->
<!--   geom_text_repel(data=Z,aes(comp1,comp2,label=rownames(Z)), -->
<!--                   segment.size = 0.2, size = 1.5)+coord_cartesian(xlim = -->
<!--                                                           c(-0.2,0.2), -->
<!--                                                           ylim= c(-0.3,0.3))+theme_article()+geom_hline(yintercept = 0, color = "gray70") + -->
<!--      geom_vline(xintercept = 0, color = "gray70") +ggtitle("Metabolome") -->
<!-- plot4 <- ggplot()+geom_point(data = W,aes(comp1,comp2),color='blue')+  -->
<!--   geom_text_repel(data=W,aes(comp1,comp2,label=rownames(W)), -->
<!--                   segment.size = 0.25, size = 3)+coord_cartesian(xlim = -->
<!--                                                           c(-0.5,0.5), -->
<!--                                                           ylim= c(-0.5,0.5))+theme_article()+geom_hline(yintercept = 0, color = "gray70") + -->
<!--      geom_vline(xintercept = 0, color = "gray70") + labs(y="")+ggtitle("Microbiome") -->
<!-- loadsplot <- ggarrange(plot1,plot2,plot3,plot4) -->

<!-- annotate_figure(loadsplot, top = text_grob("Loadings Plot",  -->
<!--                color = "black", face = "bold", size = 14)) -->
<!-- ``` -->



<!-- ```{r} -->

<!-- X<-data.frame(sgccda.res_genus$variates$clinical_data) -->
<!-- colnames(X)<-paste0("C_",colnames(X)) -->
<!-- Y<-data.frame(sgccda.res_genus$variates$IP) -->
<!-- colnames(Y)<-paste0("IP_",colnames(Y)) -->
<!-- Z <- data.frame(sgccda.res_genus$variates$metabolome) -->
<!-- colnames(Z) <- paste0("Met_",colnames(Z)) -->
<!-- W <- data.frame(sgccda.res_genus$variates$microbiome) -->
<!-- colnames(W) <- paste0("Micro_",colnames(W)) -->

<!-- datos_comb1 <- data.frame(c(X,Y)) -->

<!-- p5<- ggplot(datos_comb1,aes(C_comp2,IP_comp1))+theme_article() + -->
<!--      geom_hline(yintercept = 0, color = "gray70") + -->
<!--      geom_vline(xintercept = 0, color = "gray70") + -->
<!--      geom_point(aes(color = Group,shape=Group2), alpha = 0.55, size = 3) + -->
<!--      coord_cartesian(xlim = c(min(datos_comb1[,1]),max(datos_comb1[,1]))) + -->
<!--      scale_fill_discrete(name = "Group")+ -->
<!--      labs(x = c(paste("PC2 Clinical", -->
<!--                       round(100*sgccda.res_genus$prop_expl_var$clinical_data[2],2),"%")), y=c(paste("PC1 IP",round(100*sgccda.res_genus$prop_expl_var$IP[1],2),"%"))) + -->
<!--      ggtitle(paste("Clinical-IP ",sep=" "))+ -->
<!--      theme(plot.title = element_text(hjust = 0.5),legend.position = "none") + -->
<!--      scale_color_manual(values=1:3) -->

<!-- datos_comb1 <- data.frame(c(X,Z)) -->

<!-- p6<- ggplot(datos_comb1,aes(C_comp2,Met_comp1))+theme_article() + -->
<!--      geom_hline(yintercept = 0, color = "gray70") + -->
<!--      geom_vline(xintercept = 0, color = "gray70") + -->
<!--      geom_point(aes(color = Group,shape=Group2), alpha = 0.55, size = 3) + -->
<!--      coord_cartesian(xlim = c(min(datos_comb1[,1]),max(datos_comb1[,1]))) + -->
<!--      scale_fill_discrete(name = "Group")+ -->
<!--      labs(x = c(paste("PC2 Clinical",round(100*sgccda.res_genus$prop_expl_var$clinical_data[2],2),"%")), -->
<!--           y=c(paste("PC1 Metabolome",round(100*sgccda.res_genus$prop_expl_var$metabolome[1],2),"%"))) + -->
<!--      ggtitle(paste("Clinical-Metabolome",sep=" "))+ -->
<!--      theme(plot.title = element_text(hjust = 0.5),legend.position = "none") + -->
<!--      scale_color_manual(values=1:3) -->


<!-- p<-ggarrange(p5,p6,common.legend = T,nrow=1,ncol=2,legend="bottom") -->
<!-- annotate_figure(p, top = text_grob("Interaction Plots",  -->
<!--                color = "black", face = "bold", size = 14)) -->
<!-- ``` -->









## Blocks with generam data transformed


Firstly let's investigate the relationship between blocks.

```{r}

datos <- list(clinical_data = Clin,
              IP =IP.basal,
              metabolome = metabolome.basal,
              microbiome = genus.clr)

res1.pls.met_micro <- mixOmics::pls(datos$metabolome,datos$microbiome,ncomp=1)
(rho_met_micro <- cor(res1.pls.met_micro$variates$X,res1.pls.met_micro$variates$Y))

res1.pls.met_IP <- mixOmics::pls(datos$IP,datos$metabolome,ncomp = 1)
(rho_met_ip <- cor(res1.pls.met_IP$variates$X,res1.pls.met_IP$variates$Y))

res1.pls.met_clin <- mixOmics::pls(datos$metabolome,datos$clinical_data,ncomp=1)
(rho_pls_met_clin <- cor(res1.pls.met_clin$variates$X,res1.pls.met_clin$variates$Y))

res1.pls_micro_clin <- mixOmics::pls(datos$microbiome,datos$clinical_data,ncomp=1)
(rho_pls_micro_clin <- cor(res1.pls_micro_clin$variates$X,res1.pls_micro_clin$variates$Y))

res1.pls_micro_IP <- mixOmics::pls(datos$microbiome,datos$IP,ncomp = 1)
(rho_pls_micro_IP <- cor(res1.pls_micro_IP$variates$X,res1.pls_micro_IP$variates$Y))

res1.pls_IP_clin <- mixOmics::pls(datos$IP,datos$clinical_data,ncomp = 1)
(rho_pls_IP_clin <- cor(res1.pls_IP_clin$variates$X,res1.pls_IP_clin$variates$Y))

design =matrix(c(0,rho_pls_IP_clin,rho_pls_met_clin,rho_pls_micro_clin,
         rho_pls_IP_clin,0,rho_met_ip,rho_pls_micro_IP,
         rho_pls_met_clin,rho_met_ip,0,rho_met_micro,
         rho_pls_micro_clin,rho_pls_micro_IP,rho_met_micro,0),ncol = 4,dimnames = list(names(datos),names(datos)))
design
```

Now let's observe the optimal number of components.

```{r}
names(interaccion)<-variables_in_bacteria$Paciente
sgccda.res_total_1 = block.splsda(X = datos, Y=interaccion, ncomp = 7,
                           design = design)

set.seed(123) # for reproducibility, only when the `cpus' argument is not used
# this code takes a couple of min to run
perf.diablo_toltal_1 = mixOmics::perf(sgccda.res_total_1, validation = 'Mfold', folds = 5, nrepeat = 3)

#perf.diablo  # lists the different outputs
plot(perf.diablo_toltal_1)
```


```{r}
perf.diablo_toltal_1$choice.ncomp$WeightedVote
(ncomp = perf.diablo_toltal_1$choice.ncomp$WeightedVote["Overall.BER", "centroids.dist"])

```

```{r}

sgccda.res_genus = block.splsda(X = datos, Y = interaccion, ncomp = ncomp, design = design)
```



```{r}
plotDiablo(sgccda.res_genus, ncomp = 1)

```





```{r}
plotIndiv(sgccda.res_genus, ind.names = FALSE, legend = TRUE, title = 'DIABLO',study="global")

```


SCORE PLOT


```{r}
Group <- variables_in_bacteria$GROUP
Group2 <- variables_in_bacteria$OBESE
X<-data.frame(sgccda.res_genus$variates$clinical_data)
colnames(X)<-paste0("C_",colnames(X))
Y<-data.frame(sgccda.res_genus$variates$IP)
colnames(Y)<-paste0("IP_",colnames(Y))
Z <- data.frame(sgccda.res_genus$variates$metabolome)
colnames(Z) <- paste0("Met_",colnames(Z))
W <- data.frame(sgccda.res_genus$variates$microbiome)
colnames(W) <- paste0("Micro_",colnames(W))

p1 <- ggplot(X,aes(C_comp1,C_comp2))+theme_article() +
     geom_hline(yintercept = 0, color = "gray70") +
     geom_vline(xintercept = 0, color = "gray70") +
     geom_point(aes(color = Group,shape=Group2), alpha = 0.55, size = 3) +
     coord_cartesian(xlim = c(min(X[,1]),max(X[,1]))) +
     scale_fill_discrete(name = "Group")


      grafico1<- p1 + 
     labs(x = c(paste("PC1 Cinic",round(100*sgccda.res_genus$prop_expl_var$clinical_data[1],2),"%")),
          y=c(paste("PC2 Clinic",round(100*sgccda.res_genus$prop_expl_var$clinical_data[2],2),"%"))) +  
     ggtitle(paste("Clinical Data",sep=" "))+ 
     theme(plot.title = element_text(hjust = 0.5),legend.position = "none") +
     scale_color_manual(values=1:3)
      
p2 <- ggplot(Y,aes(IP_comp1,IP_comp2))+theme_article() +
     geom_hline(yintercept = 0, color = "gray70") +
     geom_vline(xintercept = 0, color = "gray70") +
     geom_point(aes(color = Group,shape=Group2), alpha = 0.55, size = 3) +
     coord_cartesian(xlim = c(min(Y[,1]),max(Y[,1]))) +
     scale_fill_discrete(name = "Group")


      grafico2<- p2 + 
     labs(x = c(paste("PC1 IP",round(100*sgccda.res_genus$prop_expl_var$IP[1],2),"%")),
          y=c(paste("PC2 IP",round(100*sgccda.res_genus$prop_expl_var$IP[2],2),"%"))) +  
     ggtitle(paste("IP data",sep=" "))+ 
     theme(plot.title = element_text(hjust = 0.5),legend.position = "none") +
     scale_color_manual(values=1:3)
      
p3 <- ggplot(Z,aes(Met_comp1,Met_comp2))+theme_article() +
     geom_hline(yintercept = 0, color = "gray70") +
     geom_vline(xintercept = 0, color = "gray70") +
     geom_point(aes(color = Group,shape=Group2), alpha = 0.55, size = 3) +
     coord_cartesian(xlim = c(min(Z[,1]),max(Z[,1]))) +
     scale_fill_discrete(name = "Group")


      grafico3<- p3 +  labs(x = c(paste("PC1 Metabolome",round(100*sgccda.res_genus$prop_expl_var$metabolome[1],2),"%")),
          y=c(paste("PC3 Metabolome",
                    round(100*sgccda.res_genus$prop_expl_var$metabolome[3],2),"%"))) +  
     ggtitle(paste("Metabolome data",sep=" "))+ 
     theme(plot.title = element_text(hjust = 0.5),legend.position = "none") +
     scale_color_manual(values=1:3)
      

p4 <- ggplot(W,aes(Micro_comp1,Micro_comp2))+theme_article() +
     geom_hline(yintercept = 0, color = "gray70") +
     geom_vline(xintercept = 0, color = "gray70") +
     geom_point(aes(color = Group,shape=Group2), alpha = 0.55, size = 3) +
     coord_cartesian(xlim = c(min(W[,1]),max(W[,1]))) +
     scale_fill_discrete(name = "Group")


      grafico4<- p4 +
     labs(x = c(paste("PC1 Microbiome",round(100*sgccda.res_genus$prop_expl_var$microbiome[1],2),"%")),
          y=c(paste("PC2 MIcrobiome",round(100*sgccda.res_genus$prop_expl_var$microbiome[2],2),"%"))) +  
     ggtitle(paste("Microbiome data",sep=" "))+ 
     theme(plot.title = element_text(hjust = 0.5),legend.position = "none") +
     scale_color_manual(values=1:3)     
      
p<-ggarrange(grafico1,grafico2,grafico3,grafico4,common.legend = T,nrow=2,ncol=2,legend="bottom")
annotate_figure(p, top = text_grob("Basal Integration with Genera: DIABLO", 
               color = "black", face = "bold", size = 14))
```

```{r}
(p<-plotLoadings(sgccda.res_genus,plot=F,contrib = "min",comp = 1))
```



```{r,fig.height=12,fig.width=12}
fn.contrib <- function(p,grupcon1,grupcon2){
  p$variables <-rownames(p)
  p.obj <-p[p[,"GroupContrib"]==grupcon1 & p[,paste0("Contrib.",grupcon2)]==T,c("variables","importance")]

  return(p.obj)
}
mindis <- 100
p<-plotLoadings(sgccda.res_genus,contrib = "max",block=1,plot=F,ndisplay = mindis,comp=1)
q<-plotLoadings(sgccda.res_genus,contrib = "max",block=2,plot=F,ndisplay = mindis,comp = 1)
r<-plotLoadings(sgccda.res_genus,contrib = "max",block=3,plot=F,ndisplay = mindis,comp = 1)
s<-plotLoadings(sgccda.res_genus,contrib = "max",block=4,plot=F,ndisplay = mindis,comp = 1)


(grupcon1. <- sort(unique(p$GroupContrib)))
(grupcon2. <- sort(colnames(p)[grep("^[cig]",invert = T,ignore.case = T,colnames(p))]))

grupos.con <-cbind(grupcon1.,grupcon2.)
aux1<-vector(mode="list",length=6);names(aux1)<-grupcon1.
aux2 <-vector(mode="list",length=6);names(aux2)<-grupcon1.
aux3 <-vector(mode="list",length=6);names(aux3)<-grupcon1.
aux4 <-vector(mode="list",length=6);names(aux4)<-grupcon1.

  for(i in 1:6){
  
  aux1[[i]]<-fn.contrib(p,grupcon1 = grupos.con[i,1],grupcon2 = grupos.con[i,2])
  aux2[[i]]<-fn.contrib(q,grupcon1 = grupos.con[i,1],grupcon2 = grupos.con[i,2])
  aux3[[i]]<-fn.contrib(r,grupcon1 = grupos.con[i,1],grupcon2 = grupos.con[i,2])
  aux4[[i]]<-fn.contrib(s,grupcon1 = grupos.con[i,1],grupcon2 = grupos.con[i,2])

  }


fn.exportmat <- function(Z,grupo,variables){
  Z<-as.data.frame(Z)
  Z.sub<-Z[rownames(Z)%in% grupo,variables]
  if(is.null(dim(Z.sub))){
    
    Z.sub<-as.data.frame(Z.sub)
    rownames(Z.sub)<-rownames(Z)[rownames(Z)%in% grupo]
    Z.sub$pacientes <- rownames(Z.sub)
    colnames(Z.sub)<-c(variables,"pacientes")
  }else{
    Z.sub<-as.data.frame(Z.sub)
  }
  
  return(Z.sub)
  
  
}

grupos <- unique(variables_in_bacteria$interaccion)
z <- data.frame(cimDiablo(sgccda.res_genus)$mat)
list_comp1 <- vector(mode="list",length = 6)
names(list_comp1)<-grupos
aux.tmp<-list(aux1,aux2,aux3,aux4)
for(l in 1:length(list_comp1)){
  list.temp<-vector(mode="list",length=4)
  sujetos <- variables_in_bacteria[variables_in_bacteria$interaccion==grupos[l],"Paciente"]
  for(b in 1:4){
    
    variables <-aux.tmp[[b]][[l]][,"variables"]
    variables<-variables[!is.na(variables)]
    variables<-variables[variables %in% colnames(z)]
    list.temp[[b]]<-fn.exportmat(z,sujetos,variables)
  }
list_comp1[[l]]<-list.temp
}

## Control Females
ctrl.females.1 <-(do.call(bind_cols,list_comp1$`No Obese.Female`))
ctrl.females.1<-as.matrix(ctrl.females.1[,grep("pacientes",colnames(ctrl.females.1),invert = T)])
cim(ctrl.females.1)

p_format <- function(x, ndp=3)
{
  out <- format(round(as.numeric(x),ndp),ns=ndp,scientific=F,just="none")
  ifelse(out<=0.05,"*", "")
}
# Plot

# Get positions & plot formatted p-values
pval <- psych::corr.test(ctrl.females.1, adjust="none")$p
diag(pval)<-1
w<-apply(pval<0.05, 1, any)
pval<-pval[w,w]
pos <- expand.grid(1:ncol(pval), ncol(pval):1)
# lower tri
micor<-cor(ctrl.females.1)
cim(ctrl.females.1,title="Non obese control females")
corrplot::corrplot(micor[w,w])
mtext("Non obese control females", at=2.5, line=-0.5, cex=2)

text(pos, p_format(pval),col = "white")
# text(pos, p_format(pval))

# Obese Females
ctrl.females.obese.1 <-(do.call(bind_cols,list_comp1$Obese.Female))
ctrl.females.obese.1<-as.matrix(ctrl.females.obese.1[,grep("pacientes",colnames(ctrl.females.obese.1),
                                             invert = T)])
cim(ctrl.females.obese.1,title="Obese control females")

p_format <- function(x, ndp=3)
{
  out <- format(round(as.numeric(x),ndp),ns=ndp,scientific=F,just="none")
  ifelse(out<=0.05,"*", "")
}
# Plot

# Get positions & plot formatted p-values
pval <- psych::corr.test(ctrl.females.obese.1, adjust="none")$p
diag(pval)<-1
w<-apply(pval<0.05, 1, any)
pval<-pval[w,w]
pos <- expand.grid(1:ncol(pval), ncol(pval):1)
# lower tri
micor<-cor(ctrl.females.obese.1)

corrplot::corrplot(micor[w,w],title="Obese control females")
mtext("Obese control females", at=2.5, line=-0.5, cex=2)

text(pos, p_format(pval),col = "white")


# Male
ctrl.males.1 <-(do.call(bind_cols,list_comp1$`No Obese.Male`))
ctrl.males.1<-as.matrix(ctrl.males.1[,grep("pacientes",colnames(ctrl.males.1),
                                             invert = T)])
cim(ctrl.males.1,title="Non obese control males")

p_format <- function(x, ndp=3)
{
  out <- format(round(as.numeric(x),ndp),ns=ndp,scientific=F,just="none")
  ifelse(out<=0.05,"*", "")
}
# Plot

# Get positions & plot formatted p-values
pval <- psych::corr.test(ctrl.males.1, adjust="none")$p
diag(pval)<-1
w<-apply(pval<0.05, 1, any)
pval<-pval[w,w]
pos <- expand.grid(1:ncol(pval), ncol(pval):1)
# lower tri
micor<-cor(ctrl.males.1)

corrplot::corrplot(micor[w,w])
mtext("Non obese control males", at=2.5, line=-0.5, cex=2)

text(pos, p_format(pval),col = "white")

# Male OBese
ctrl.males.obese.1 <-(do.call(bind_cols,list_comp1$Obese.Male))
ctrl.males.obese.1<-as.matrix(ctrl.males.obese.1[,grep("pacientes",colnames(ctrl.males.obese.1),
                                             invert = T)])
cim(ctrl.males.obese.1,title="Obese control males")

p_format <- function(x, ndp=3)
{
  out <- format(round(as.numeric(x),ndp),ns=ndp,scientific=F,just="none")
  ifelse(out<=0.05,"*", "")
}
# Plot

# Get positions & plot formatted p-values
pval <- psych::corr.test(ctrl.males.obese.1, adjust="none")$p
diag(pval)<-1
w<-apply(pval<0.005, 1, any)
pval<-pval[w,w]
pos <- expand.grid(1:ncol(pval), ncol(pval):1)
# lower tri
micor<-cor(ctrl.males.obese.1)

corrplot::corrplot(micor[w,w])
mtext("Obese control males", at=2.5, line=-0.5, cex=2)

text(pos, p_format(pval),col = "white")

# pcos
  pcos.1 <-(do.call(bind_cols,list_comp1$`No Obese.PCOS`))
pcos.1<-as.matrix(pcos.1[,grep("pacientes",colnames(pcos.1),
                                             invert = T)])
cim(pcos.1,title="Non obese PCOS females")

p_format <- function(x, ndp=3)
{
  out <- format(round(as.numeric(x),ndp),ns=ndp,scientific=F,just="none")
  ifelse(out<=0.05,"*", "")
}
# Plot

# Get positions & plot formatted p-values
pval <- psych::corr.test(pcos.1, adjust="none")$p
diag(pval)<-1
w<-apply(pval<0.05, 1, any)
pval<-pval[w,w]
pos <- expand.grid(1:ncol(pval), ncol(pval):1)
# lower tri
micor<-cor(pcos.1)

corrplot::corrplot(micor[w,w])
mtext("Non obese PCOS females", at=2.5, line=-0.5, cex=2)

text(pos, p_format(pval),col = "white")


# pcos obese
  pcos.obese.1 <-(do.call(bind_cols,list_comp1$Obese.PCOS))
pcos.obese.1<-as.matrix(pcos.obese.1[,grep("pacientes",colnames(pcos.obese.1),
                                             invert = T)])
cim(pcos.obese.1,title="obese PCOS females")

p_format <- function(x, ndp=3)
{
  out <- format(round(as.numeric(x),ndp),ns=ndp,scientific=F,just="none")
  ifelse(out<=0.05,"*", "")
}
# Plot

# Get positions & plot formatted p-values
pval <- psych::corr.test(pcos.obese.1, adjust="none")$p
diag(pval)<-1
w<-apply(pval<0.05, 1, any)
pval<-pval[w,w]
pos <- expand.grid(1:ncol(pval), ncol(pval):1)
# lower tri
micor<-cor(pcos.obese.1)

corrplot::corrplot(micor[w,w])
mtext("obese PCOS females", at=2.5, line=-0.5, cex=2)
text(pos, p_format(pval),col = "white")
```


No hay variables entre la interseccion de los diferentes grupos 
```{r}
Reduce(base::intersect, list(colnames(ctrl.females),colnames(ctrl.females.obese),colnames(ctrl.males),
          colnames(ctrl.males.obese),colnames(pcos),colnames(pcos.obese)))
```
Vemos por sexo

Mujeres no hay variables en la interseccion entre controles femeninos y pcos

```{r}
Reduce(base::intersect, list(colnames(ctrl.females),colnames(ctrl.females.obese),colnames(pcos),colnames(pcos.obese)))
```
Entre hombres tampoco hay variables en comun
```{r}
Reduce(base::intersect, list(colnames(ctrl.males),colnames(ctrl.males.obese)))
```
Vemos ahora entre grupo obesos, tampoco hya variables en comun

```{r}
Reduce(base::intersect, list(colnames(ctrl.males.obese),colnames(ctrl.females.obese),colnames(pcos.obese)))
```
Vemos ahora entre delgados

```{r}
Reduce(base::intersect, list(colnames(ctrl.males),colnames(ctrl.females),colnames(pcos)))
```

Ahora vemos los controles por separado, entre hombres no hay variables enc omun
```{r}
Reduce(base::intersect, list(colnames(ctrl.males.obese),colnames(ctrl.males)))
```
Entre mujeres control si hay variables en comun
```{r}
Reduce(base::intersect, list(colnames(ctrl.females.obese),colnames(ctrl.females)))

```

#Mujeres control sanas-PCOS delgadas
```{r}
Reduce(base::intersect, list(colnames(pcos),colnames(ctrl.females)))

```
# Mujeres control obessas-PCOS delgadas
```{r}
Reduce(base::intersect, list(colnames(pcos),colnames(ctrl.females.obese)))

```
#hombres sanos PCOS delfadas
```{r}
Reduce(base::intersect, list(colnames(pcos),colnames(ctrl.males)))

```
#hombres obesos PCOS delfadas
```{r}
Reduce(base::intersect, list(colnames(pcos),colnames(ctrl.males.obese)))

```


#Mujeres control sanas-PCOS obesas
```{r}
Reduce(base::intersect, list(colnames(pcos.obese),colnames(ctrl.females)))

```
# Mujeres control obessas-PCOS obese
```{r}
Reduce(base::intersect, list(colnames(pcos.obese),colnames(ctrl.females.obese)))

```
#hombres sanos PCOS obese
```{r}
Reduce(base::intersect, list(colnames(pcos.obese),colnames(ctrl.males)))

```
#hombres obesos PCOS obese
```{r}
Reduce(base::intersect, list(colnames(pcos.obese),colnames(ctrl.males.obese)))

```

```{r,fig.height=9,fig.width=9}
fn.contrib <- function(p,grupcon1,grupcon2){
  p$variables <-rownames(p)
  p.obj <-p[p[,"GroupContrib"]==grupcon1 & p[,paste0("Contrib.",grupcon2)]==T,c("variables","importance")]

  return(p.obj)
}
mindis <- 100
p<-plotLoadings(sgccda.res_genus,contrib = "max",block=1,plot=F,ndisplay = mindis,comp=2)
q<-plotLoadings(sgccda.res_genus,contrib = "max",block=2,plot=F,ndisplay = mindis,comp = 2)
r<-plotLoadings(sgccda.res_genus,contrib = "max",block=3,plot=F,ndisplay = mindis,comp = 2)
s<-plotLoadings(sgccda.res_genus,contrib = "max",block=4,plot=F,ndisplay = mindis,comp = 2)


(grupcon1. <- sort(unique(p$GroupContrib)))
(grupcon2. <- sort(colnames(p)[grep("^[cig]",invert = T,ignore.case = T,colnames(p))]))

grupos.con <-cbind(grupcon1.,grupcon2.)
aux1<-vector(mode="list",length=6);names(aux1)<-grupcon1.
aux2 <-vector(mode="list",length=6);names(aux2)<-grupcon1.
aux3 <-vector(mode="list",length=6);names(aux3)<-grupcon1.
aux4 <-vector(mode="list",length=6);names(aux4)<-grupcon1.

  for(i in 1:6){
  
  aux1[[i]]<-fn.contrib(p,grupcon1 = grupos.con[i,1],grupcon2 = grupos.con[i,2])
  aux2[[i]]<-fn.contrib(q,grupcon1 = grupos.con[i,1],grupcon2 = grupos.con[i,2])
  aux3[[i]]<-fn.contrib(r,grupcon1 = grupos.con[i,1],grupcon2 = grupos.con[i,2])
  aux4[[i]]<-fn.contrib(s,grupcon1 = grupos.con[i,1],grupcon2 = grupos.con[i,2])

  }


fn.exportmat <- function(Z,grupo,variables){
  Z<-as.data.frame(Z)
  Z.sub<-Z[rownames(Z)%in% grupo,variables]
  if(is.null(dim(Z.sub))){
    
    Z.sub<-as.data.frame(Z.sub)
    rownames(Z.sub)<-rownames(Z)[rownames(Z)%in% grupo]
    Z.sub$pacientes <- rownames(Z.sub)
    colnames(Z.sub)<-c(variables,"pacientes")
  }else{
    Z.sub<-as.data.frame(Z.sub)
  }
  
  return(Z.sub)
  
  
}

grupos <- unique(variables_in_bacteria$interaccion)
z <- data.frame(cimDiablo(sgccda.res_genus)$mat)
list_comp1 <- vector(mode="list",length = 6)
names(list_comp1)<-grupos
aux.tmp<-list(aux1,aux2,aux3,aux4)
for(l in 1:length(list_comp1)){
  list.temp<-vector(mode="list",length=4)
  sujetos <- variables_in_bacteria[variables_in_bacteria$interaccion==grupos[l],"Paciente"]
  for(b in 1:4){
    
    variables <-aux.tmp[[b]][[l]][,"variables"]
    variables<-variables[!is.na(variables)]
    variables<-variables[variables %in% colnames(z)]
    list.temp[[b]]<-fn.exportmat(z,sujetos,variables)
  }
list_comp1[[l]]<-list.temp
}

## Control Females
ctrl.females.2 <-(do.call(bind_cols,list_comp1$`No Obese.Female`))
ctrl.females.2<-as.matrix(ctrl.females.2[,grep("pacientes",colnames(ctrl.females.2),invert = T)])
cim(ctrl.females.2)

p_format <- function(x, ndp=3)
{
  out <- format(round(as.numeric(x),ndp),ns=ndp,scientific=F,just="none")
  ifelse(out<=0.05,"*", "")
}
# Plot

# Get positions & plot formatted p-values
pval <- psych::corr.test(ctrl.females.2, adjust="none")$p
diag(pval)<-1
w<-apply(pval<0.05, 1, any)
pval<-pval[w,w]
pos <- expand.grid(1:ncol(pval), ncol(pval):1)
# lower tri
micor<-cor(ctrl.females.2)

corrplot::corrplot(micor[w,w])
text(pos, p_format(pval),col = "white")
# text(pos, p_format(pval))

# Obese Females
ctrl.females.obese.2 <-(do.call(bind_cols,list_comp1$Obese.Female))
ctrl.females.obese.2<-as.matrix(ctrl.females.obese.2[,grep("pacientes",colnames(ctrl.females.obese.2),
                                             invert = T)])
cim(ctrl.females.obese.2)

p_format <- function(x, ndp=3)
{
  out <- format(round(as.numeric(x),ndp),ns=ndp,scientific=F,just="none")
  ifelse(out<=0.05,"*", "")
}
# Plot

# Get positions & plot formatted p-values
pval <- psych::corr.test(ctrl.females.obese.2, adjust="none")$p
diag(pval)<-1
w<-apply(pval<0.05, 1, any)
pval<-pval[w,w]
pos <- expand.grid(1:ncol(pval), ncol(pval):1)
# lower tri
micor<-cor(ctrl.females.obese.2)

corrplot::corrplot(micor[w,w])
text(pos, p_format(pval),col = "white")


# Male
ctrl.males.2 <-(do.call(bind_cols,list_comp1$`No Obese.Male`))
ctrl.males.2<-as.matrix(ctrl.males.2[,grep("pacientes",colnames(ctrl.males.2),
                                             invert = T)])
cim(ctrl.males.2)

p_format <- function(x, ndp=3)
{
  out <- format(round(as.numeric(x),ndp),ns=ndp,scientific=F,just="none")
  ifelse(out<=0.05,"*", "")
}
# Plot

# Get positions & plot formatted p-values
pval <- psych::corr.test(ctrl.males.2, adjust="none")$p
diag(pval)<-1
w<-apply(pval<0.05, 1, any)
pval<-pval[w,w]
pos <- expand.grid(1:ncol(pval), ncol(pval):1)
# lower tri
micor<-cor(ctrl.males.2)

corrplot::corrplot(micor[w,w])
text(pos, p_format(pval),col = "white")

# Male OBese
ctrl.males.obese.2 <-(do.call(bind_cols,list_comp1$Obese.Male))
ctrl.males.obese.2<-as.matrix(ctrl.males.obese.2[,grep("pacientes",colnames(ctrl.males.obese.2),
                                             invert = T)])
cim(ctrl.males.obese.2)

p_format <- function(x, ndp=3)
{
  out <- format(round(as.numeric(x),ndp),ns=ndp,scientific=F,just="none")
  ifelse(out<=0.05,"*", "")
}
# Plot

# Get positions & plot formatted p-values
pval <- psych::corr.test(ctrl.males.obese.2, adjust="none")$p
diag(pval)<-1
w<-apply(pval<0.005, 1, any)
pval<-pval[w,w]
pos <- expand.grid(1:ncol(pval), ncol(pval):1)
# lower tri
micor<-cor(ctrl.males.obese.2)

corrplot::corrplot(micor[w,w])
text(pos, p_format(pval),col = "white")

# pcos
  pcos.2 <-(do.call(bind_cols,list_comp1$`No Obese.PCOS`))
pcos.2<-as.matrix(pcos.2[,grep("pacientes",colnames(pcos.2),
                                             invert = T)])
cim(pcos.2)

p_format <- function(x, ndp=3)
{
  out <- format(round(as.numeric(x),ndp),ns=ndp,scientific=F,just="none")
  ifelse(out<=0.05,"*", "")
}
# Plot

# Get positions & plot formatted p-values
pval <- psych::corr.test(pcos.2, adjust="none")$p
diag(pval)<-1
w<-apply(pval<0.05, 1, any)
pval<-pval[w,w]
pos <- expand.grid(1:ncol(pval), ncol(pval):1)
# lower tri
micor<-cor(pcos.2)

corrplot::corrplot(micor[w,w])
text(pos, p_format(pval),col = "white")


# pcos obese
  pcos.obese.2 <-(do.call(bind_cols,list_comp1$Obese.PCOS))
pcos.obese.2<-as.matrix(pcos.obese.2[,grep("pacientes",colnames(pcos.obese.2),
                                             invert = T)])
cim(pcos.obese.2)

p_format <- function(x, ndp=3)
{
  out <- format(round(as.numeric(x),ndp),ns=ndp,scientific=F,just="none")
  ifelse(out<=0.05,"*", "")
}
# Plot

# Get positions & plot formatted p-values
pval <- psych::corr.test(pcos.obese.2, adjust="none")$p
diag(pval)<-1
w<-apply(pval<0.05, 1, any)
pval<-pval[w,w]
pos <- expand.grid(1:ncol(pval), ncol(pval):1)
# lower tri
micor<-cor(pcos.obese.2)

corrplot::corrplot(micor[w,w])
text(pos, p_format(pval),col = "white")
```




```{r}
sujetos.comp <- list(pcos1=pcos.1,pcos2=pcos.2,
                     pcoso1=pcos.obese.1,pcoso2=pcos.obese.2,
                     females1=ctrl.females.1,females2=ctrl.females.2,
                     femaleso1=ctrl.females.obese.1,femaleso2=ctrl.females.obese.2,
                     males1=ctrl.males.1,males2=ctrl.males.2,
                     maleso1=ctrl.males.obese.1,maleso2=ctrl.males.obese.2)
names(sujetos.comp)

Reduce(base::intersect, list(colnames(sujetos.comp$pcos1),colnames(sujetos.comp$pcos2)))

```



<!-- ```{r} -->
<!-- p<-plotLoadings(sgccda.res_genus,contrib = "max",block=1,plot=F,method="mean",comp=1,ndisplay = 70) -->
<!-- q<-plotLoadings(sgccda.res_genus,contrib = "max",block=2,plot=F,method="mean",comp=1,ndisplay = 70) -->
<!-- r<-plotLoadings(sgccda.res_genus,contrib = "max",block=3,plot=F,method="mean",comp=1,ndisplay = 70) -->
<!-- s<-plotLoadings(sgccda.res_genus,contrib = "max",block=4,plot=F,method="mean",comp=1.,ndisplay = 70) -->

<!-- (grupcon1. <- sort(unique(p$GroupContrib))) -->
<!-- (grupcon2. <- sort(colnames(p)[grep("^[cig]",invert = T,ignore.case = T,colnames(p))])) -->

<!-- grupos.con <-cbind(grupcon1.,grupcon2.) -->

<!-- lista_loads <- list(p,q,r,s) -->
<!-- aux1 <- vector(mode = "list",length=4) -->
<!-- block.name <-c("Clinical","IP","Metabolome","Microbiome") -->
<!-- for(i in 1:length(lista_loads)){ -->

<!--   aux1[[i]]<-fn.contrib(lista_loads[[i]], -->
<!--                         grupcon1 = grupos.con[1,1], -->
<!--                         grupcon2 = grupos.con[1,2])+labs(x=block.name[i]) -->
<!-- } -->

<!-- plot_female <- ggarrange(aux1[[1]],aux1[[2]],aux1[[3]],aux1[[4]]) -->
<!-- annotate_figure(plot_female, top = text_grob("All blocks-Variable contributions",  -->
<!--                color = "black", face = "bold", size = 14)) -->

<!-- aux2 <- vector(mode = "list",length=4) -->
<!-- for(i in 1:length(lista_loads)){ -->

<!--   aux2[[i]]<-fn.contrib(lista_loads[[i]], -->
<!--                         grupcon1 = grupos.con[2,1], -->
<!--                         grupcon2 = grupos.con[2,2])+labs(x=block.name[i]) -->
<!-- } -->

<!-- plot_female_obese <- ggarrange(aux2[[1]],aux2[[2]],aux2[[3]],aux2[[4]]) -->
<!-- annotate_figure(plot_female_obese, top = text_grob("All blocks-Variable contributions",  -->
<!--                color = "black", face = "bold", size = 14)) -->


<!-- aux3 <- vector(mode = "list",length=4) -->
<!-- for(i in 1:length(lista_loads)){ -->

<!--   aux3[[i]]<-fn.contrib(lista_loads[[i]], -->
<!--                         grupcon1 = grupos.con[3,1], -->
<!--                         grupcon2 = grupos.con[3,2])+labs(x=block.name[i]) -->
<!-- } -->

<!-- plot_male <- ggarrange(aux3[[1]],aux3[[2]],aux3[[3]],aux3[[4]]) -->
<!-- annotate_figure(plot_male, top = text_grob("All blocks-Variable contributions",  -->
<!--                color = "black", face = "bold", size = 14)) -->





<!-- aux4 <- vector(mode = "list",length=4) -->
<!-- for(i in 1:length(lista_loads)){ -->

<!--   aux4[[i]]<-fn.contrib(lista_loads[[i]], -->
<!--                         grupcon1 = grupos.con[4,1], -->
<!--                         grupcon2 = grupos.con[4,2])+labs(x=block.name[i]) -->
<!-- } -->

<!-- plot_male_obese <- ggarrange(aux4[[1]],aux4[[2]],aux4[[3]],aux4[[4]]) -->
<!-- annotate_figure(plot_male_obese, top = text_grob("All blocks-Variable contributions",  -->
<!--                color = "black", face = "bold", size = 14)) -->


<!-- aux5 <- vector(mode = "list",length=4) -->
<!-- for(i in 1:length(lista_loads)){ -->

<!--   aux5[[i]]<-fn.contrib(lista_loads[[i]], -->
<!--                         grupcon1 = grupos.con[5,1], -->
<!--                         grupcon2 = grupos.con[5,2])+labs(x=block.name[i]) -->
<!-- } -->

<!-- plot_pcos <- ggarrange(aux5[[1]],aux5[[2]],aux5[[3]],aux5[[4]]) -->
<!-- annotate_figure(plot_pcos, top = text_grob("All blocks-Variable contributions",  -->
<!--                color = "black", face = "bold", size = 14)) -->

<!-- aux6 <- vector(mode = "list",length=4) -->
<!-- for(i in 1:length(lista_loads)){ -->

<!--   aux6[[i]]<-fn.contrib(lista_loads[[i]], -->
<!--                         grupcon1 = grupos.con[6,1], -->
<!--                         grupcon2 = grupos.con[6,2])+labs(x=block.name[i]) -->
<!-- } -->

<!-- plot_pcos_obese <- ggarrange(aux6[[1]],aux6[[2]],aux6[[3]],aux6[[4]]) -->
<!-- annotate_figure(plot_pcos_obese, top = text_grob("All blocks-Variable contributions",  -->
<!--                color = "black", face = "bold", size = 14)) -->



<!-- ``` -->



<!-- ```{r} -->
<!-- c_prop<-sgccda.res_genus$prop_expl_var$clinical_data -->
<!-- ip_prop <- sgccda.res_genus$prop_expl_var$IP -->
<!-- met_prop <- sgccda.res_genus$prop_expl_var$metabolome -->
<!-- mic_prop <- sgccda.res_genus$prop_expl_var$microbiome -->
<!-- Y_prop<-sgccda.res_genus$prop_expl_var$Y -->
<!-- var.exp <- 100*data.frame(clinical=c_prop,ip=ip_prop,met=met_prop,mic=mic_prop,Y=Y_prop) -->
<!-- var.exp$comps <-rownames(var.exp) -->
<!-- p1<- ggplot(data=var.exp, aes(x=comps, y=clinical)) +  -->
<!--     geom_bar(stat="identity",col="black",fill="darkblue")+ -->
<!--     theme_article()+ -->
<!--   labs(y="Clinical Data",x="")+ -->
<!--   theme(axis.text=element_text(size=12,color = "black"))+coord_cartesian(ylim = c(-0,35))  -->

<!-- p2<- ggplot(data=var.exp, aes(x=comps, y=ip)) +  -->
<!--     geom_bar(stat="identity",col="black",fill="darkblue")+ -->
<!--     theme_article()+ -->
<!--   labs(y="IP Data",x="")+ -->
<!--   theme(axis.text=element_text(size=12,color = "black"))+coord_cartesian(ylim = c(-0,35))  -->

<!-- p3<- ggplot(data=var.exp, aes(x=comps, y=met)) +  -->
<!--     geom_bar(stat="identity",col="black",fill="darkblue")+ -->
<!--     theme_article()+ -->
<!--   labs(y="Metabolome Data",x="")+ -->
<!--   theme(axis.text=element_text(size=12,color = "black"))+coord_cartesian(ylim = c(-0,35))  -->

<!-- p4<- ggplot(data=var.exp, aes(x=comps, y=mic)) +  -->
<!--     geom_bar(stat="identity",col="black",fill="darkblue")+ -->
<!--     theme_article()+ -->
<!--   labs(y="Microbiome Data",x="")+ -->
<!--   theme(axis.text=element_text(size=12,color = "black"))+coord_cartesian(ylim = c(-0,35))  -->



<!-- var.expl.plot <-ggarrange(p1,p2,p3,p4) -->
<!-- annotate_figure(var.expl.plot, top = text_grob("Explained Variation by Block (%)",  -->
<!--                color = "black", face = "bold", size = 14)) -->
<!-- ``` -->


<!-- ```{r} -->

<!-- c_prop<-sgccda.res_genus$prop_expl_var$clinical_data -->
<!-- ip_prop <- sgccda.res_genus$prop_expl_var$IP -->
<!-- met_prop <- sgccda.res_genus$prop_expl_var$metabolome -->
<!-- mic_prop <- sgccda.res_genus$prop_expl_var$microbiome -->
<!-- Y_prop<-sgccda.res_genus$prop_expl_var$Y -->
<!-- round(rbind(c_prop,ip_prop,met_prop,mic_prop,Y_prop),2) -->
<!-- ``` -->



<!-- ```{r} -->
<!-- X <- data.frame(sgccda.res_genus$loadings$clinical_data) -->
<!-- Y <- data.frame(sgccda.res_genus$loadings$IP) -->
<!-- Z <- data.frame(sgccda.res_genus$loadings$metabolome) -->
<!-- W <- data.frame(sgccda.res_genus$loadings$microbiome) -->
<!-- # colnames(X) <-paste0("met",colnames(X)) -->
<!-- # colnames(Y) <- paste0("micro",colnames(Y)) -->
<!-- plot1 <- ggplot() +  -->
<!--     geom_point(data = X,aes(comp1,comp2),label=rownames(X),color="blue") +  -->
<!--   geom_text_repel(data=X,aes(comp1,comp2, -->
<!--                              label=rownames(X)), -->
<!--                   segment.size = 0.25, size = 2)+coord_cartesian(xlim = -->
<!--                                                           c(-0.4,0.4), -->
<!--                                                           ylim= c(-0.4,0.4))+theme_article()+geom_hline(yintercept = 0, color = "gray70") + -->
<!--      geom_vline(xintercept = 0, color = "gray70") +labs(x="")+ggtitle("Clinical") -->


<!-- plot2 <- ggplot()+geom_point(data = Y,aes(comp1,comp2),color='blue')+  -->
<!--   geom_text_repel(data=Y,aes(comp1,comp2,label=rownames(Y)), -->
<!--                   segment.size = 0.25, size = 3)+coord_cartesian(xlim = -->
<!--                                                           c(-0.5,0.5), -->
<!--                                                           ylim= c(-0.5,0.5))+theme_article()+geom_hline(yintercept = 0, color = "gray70") + -->
<!--      geom_vline(xintercept = 0, color = "gray70") + labs(x="",y="")+ggtitle("IP") -->
<!-- plot3 <- ggplot()+geom_point(data = Z,aes(comp1,comp2),color='blue')+  -->
<!--   geom_text_repel(data=Z,aes(comp1,comp2,label=rownames(Z)), -->
<!--                   segment.size = 0.1, size =2)+coord_cartesian(xlim = -->
<!--                                                           c(-0.2,0.2), -->
<!--                                                           ylim= c(-0.3,0.3))+theme_article()+geom_hline(yintercept = 0, color = "gray70") + -->
<!--      geom_vline(xintercept = 0, color = "gray70") +ggtitle("Metabolome") -->
<!-- plot4 <- ggplot()+geom_point(data = W,aes(comp1,comp2),color='blue')+  -->
<!--   geom_text_repel(data=W,aes(comp1,comp2,label=rownames(W)), -->
<!--                   segment.size = 0.1, size = 3)+coord_cartesian(xlim = -->
<!--                                                           c(-0.3,0.3), -->
<!--                                                           ylim= c(-0.3,0.3))+theme_article()+geom_hline(yintercept = 0, color = "gray70") + -->
<!--      geom_vline(xintercept = 0, color = "gray70") + labs(y="")+ggtitle("Microbiome") -->
<!-- loadsplot <- ggarrange(plot1,plot2,plot3,plot4) -->

<!-- annotate_figure(loadsplot, top = text_grob("Loadings Plot",  -->
<!--                color = "black", face = "bold", size = 14)) -->
<!-- ``` -->



<!-- ```{r} -->
<!-- X<-data.frame(sgccda.res_genus$variates$clinical_data) -->
<!-- colnames(X)<-paste0("C_",colnames(X)) -->
<!-- Y<-data.frame(sgccda.res_genus$variates$IP) -->
<!-- colnames(Y)<-paste0("IP_",colnames(Y)) -->
<!-- Z <- data.frame(sgccda.res_genus$variates$metabolome) -->
<!-- colnames(Z) <- paste0("Met_",colnames(Z)) -->
<!-- W <- data.frame(sgccda.res_genus$variates$microbiome) -->
<!-- colnames(W) <- paste0("Micro_",colnames(W)) -->




<!-- datos_comb0 <- data.frame(c(X,W)) -->

<!-- p1<- ggplot(datos_comb0,aes(C_comp2,Micro_comp1))+theme_article() + -->
<!--      geom_hline(yintercept = 0, color = "gray70") + -->
<!--      geom_vline(xintercept = 0, color = "gray70") + -->
<!--      geom_point(aes(color = Group,shape=Group2), alpha = 0.55, size = 3) + -->
<!--      coord_cartesian(xlim = c(min(datos_comb0[,2]),max(datos_comb0[,1]))) + -->
<!--      scale_fill_discrete(name = "Group")+ -->
<!--      labs(x = c(paste("PC2 Clinical", -->
<!--                       round(100*sgccda.res_genus$prop_expl_var$clinical_data[2],2),"%")), y=c(paste("PC1 Micro",round(100*sgccda.res_genus$prop_expl_var$microbiome[1],2),"%"))) + -->
<!--      ggtitle(paste("Clinical-Microbiome ",sep=" "))+ -->
<!--      theme(plot.title = element_text(hjust = 0.5),legend.position = "none") + -->
<!--      scale_color_manual(values=1:3) -->




<!-- datos_comb1 <- data.frame(c(Y,Z)) -->

<!-- p2<- ggplot(datos_comb1,aes(IP_comp2,Met_comp1))+theme_article() + -->
<!--      geom_hline(yintercept = 0, color = "gray70") + -->
<!--      geom_vline(xintercept = 0, color = "gray70") + -->
<!--      geom_point(aes(color = Group,shape=Group2), alpha = 0.55, size = 3) + -->
<!--      coord_cartesian(xlim = c(min(datos_comb1[,2]),max(datos_comb1[,2]))) + -->
<!--      scale_fill_discrete(name = "Group")+ -->
<!--      labs(x = c(paste("PC2 IP", -->
<!--                       round(100*sgccda.res_genus$prop_expl_var$IP[2],2),"%")), y=c(paste("PC1 Metabolome",round(100*sgccda.res_genus$prop_expl_var$metabolome[1],2),"%"))) + -->
<!--      ggtitle(paste("IP-Metabolome ",sep=" "))+ -->
<!--      theme(plot.title = element_text(hjust = 0.5),legend.position = "none") + -->
<!--      scale_color_manual(values=1:3) -->
<!-- datos_comb1 <- data.frame(c(Y,W)) -->

<!-- p3<- ggplot(datos_comb1,aes(IP_comp1,Micro_comp2,label=variables_in_bacteria$Paciente))+theme_article() + -->
<!--      geom_hline(yintercept = 0, color = "gray70") + -->
<!--      geom_vline(xintercept = 0, color = "gray70") + -->
<!--      geom_point(aes(color = Group,shape=Group2), alpha = 0.55, size = 3) + -->
<!--      coord_cartesian(xlim = c(min(datos_comb1[,1]),max(datos_comb1[,1]))) + -->
<!--      scale_fill_discrete(name = "Group")+ -->
<!--      labs(x = c(paste("PC 1 IP",round(100*sgccda.res_genus$prop_expl_var$IP[1],2),"%")), -->
<!--           y=c(paste("PC2 Microbiome",round(100*sgccda.res_genus$prop_expl_var$microbiome[2],2),"%"))) + -->
<!--      ggtitle(paste("IP-Microbiome",sep=" "))+ -->
<!--      theme(plot.title = element_text(hjust = 0.5),legend.position = "none") + -->
<!--      scale_color_manual(values=1:3) -->


<!-- datos_comb1 <- data.frame(c(W,Z)) -->

<!-- p4<- ggplot(datos_comb1,aes(Met_comp2,Micro_comp1,label=variables_in_bacteria$Paciente))+theme_article() + -->
<!--      geom_hline(yintercept = 0, color = "gray70") + -->
<!--      geom_vline(xintercept = 0, color = "gray70") + -->
<!--      geom_point(aes(color = Group,shape=Group2), alpha = 0.55, size = 3) + -->
<!--      coord_cartesian(xlim = c(min(datos_comb1[,1]),max(datos_comb1[,1]))) + -->
<!--      scale_fill_discrete(name = "Group")+ -->
<!--      labs(x = c(paste("PC2 Metabolome",round(100*sgccda.res_genus$prop_expl_var$metabolome[2],2),"%")), -->
<!--           y=c(paste("PC1 Microbiome",round(100*sgccda.res_genus$prop_expl_var$microbiome[1],2),"%"))) + -->
<!--      ggtitle(paste("Metabolome-MIcrobiome",sep=" "))+ -->
<!--      theme(plot.title = element_text(hjust = 0.5),legend.position = "none") + -->
<!--      scale_color_manual(values=1:3) -->

<!-- datos_comb1 <- data.frame(c(X,Y)) -->

<!-- p5<- ggplot(datos_comb1,aes(C_comp2,IP_comp1,label=variables_in_bacteria$Paciente))+theme_article() + -->
<!--      geom_hline(yintercept = 0, color = "gray70") + -->
<!--      geom_vline(xintercept = 0, color = "gray70") + -->
<!--      geom_point(aes(color = Group,shape=Group2), alpha = 0.55, size = 3) + -->
<!--      coord_cartesian(xlim = c(min(datos_comb1[,1]),max(datos_comb1[,1]))) + -->
<!--      scale_fill_discrete(name = "Group")+ -->
<!--      labs(x = c(paste("PC2 Clinical",round(100*sgccda.res_genus$prop_expl_var$clinical_data[2],2),"%")), -->
<!--           y=c(paste("PC1 IP",round(100*sgccda.res_genus$prop_expl_var$IP[1],2),"%"))) + -->
<!--      ggtitle(paste("IP-Clincal",sep=" "))+ -->
<!--      theme(plot.title = element_text(hjust = 0.5),legend.position = "none") + -->
<!--      scale_color_manual(values=1:3) -->


<!-- datos_comb1 <- data.frame(c(X,Z)) -->

<!-- p6<- ggplot(datos_comb1,aes(y=C_comp2,x=Met_comp1,label=variables_in_bacteria$Paciente))+theme_article() + -->
<!--      geom_hline(yintercept = 0, color = "gray70") + -->
<!--      geom_vline(xintercept = 0, color = "gray70") + -->
<!--      geom_point(aes(color = Group,shape=Group2), alpha = 0.55, size = 3) + -->
<!--      coord_cartesian(xlim = c(min(datos_comb1[,2]),max(datos_comb1[,1]))) + -->
<!--      scale_fill_discrete(name = "Group")+ -->
<!--      labs(x = c(paste("PC1 Microbiome",round(100*sgccda.res_genus$prop_expl_var$metabolome[2],2),"%")), -->
<!--           y=c(paste("PC2 Microbiome",round(100*sgccda.res_genus$prop_expl_var$microbiome[1],2),"%"))) + -->
<!--      ggtitle(paste("Clinical-Metabolome",sep=" "))+ -->
<!--      theme(plot.title = element_text(hjust = 0.5),legend.position = "none") + -->
<!--      scale_color_manual(values=1:3) -->

<!-- p6 -->
<!-- datos_comb1 <- data.frame(c(Y,W)) -->



<!-- datos_comb1 <- data.frame(c(X,Z)) -->

<!-- p6<- ggplot(datos_comb1,aes(y=C_comp2,x=Met_comp1,label=variables_in_bacteria$Paciente))+theme_article() + -->
<!--      geom_hline(yintercept = 0, color = "gray70") + -->
<!--      geom_vline(xintercept = 0, color = "gray70") + -->
<!--      geom_point(aes(color = Group,shape=Group2), alpha = 0.55, size = 3) + -->
<!--      coord_cartesian(xlim =  c(min(datos_comb1[,2]),max(datos_comb1[,1]))) + -->
<!--      scale_fill_discrete(name = "Group")+ -->
<!--      labs(x = c(paste("PC1 Microbiome",round(100*sgccda.res_genus$prop_expl_var$metabolome[2],2),"%")), -->
<!--           y=c(paste("PC2 Microbiome",round(100*sgccda.res_genus$prop_expl_var$microbiome[1],2),"%"))) + -->
<!--      ggtitle(paste("Clinical-Metabolome",sep=" "))+ -->
<!--      theme(plot.title = element_text(hjust = 0.5),legend.position = "none") + -->
<!--      scale_color_manual(values=1:3) -->





<!-- pttal <- ggarrange(p1,p2,p3,common.legend = T,legend = "bottom",nrow=1) -->
<!-- annotate_figure(pttal, top = text_grob("Interaction Plot",  -->
<!--                color = "black", face = "bold", size = 14)) -->
<!-- pttal3 <- ggarrange(p4,p5,p6,common.legend = T,legend = "bottom",nrow=1) -->
<!-- annotate_figure(pttal3, top = text_grob("Interaction Plot",  -->
<!--                color = "black", face = "bold", size = 14)) -->


<!-- ``` -->

<!-- ```{r,fig.height=9,fig.width=9} -->
<!-- p<-mixOmics::circosPlot(sgccda.res_genus,cutoff=0.6,size.variables=0.7,showIntraLinks=F) -->
<!-- ``` -->

<!-- ```{r,fig.width=7,fig.height=7} -->
<!-- mat <- cimDiablo(sgccda.res_genus,dist.method=c("euclidean","correlation"),size.legend = 0.6)$mat -->
<!-- variables_in_bacteria$interaccion <- with(variables_in_bacteria,interaction(OBESE,GROUP)) -->
<!-- pcos.obe <- mat[variables_in_bacteria[variables_in_bacteria$interaccion=="Obese.PCOS","Paciente"],] -->
<!-- ``` -->


<!-- ```{r} -->
<!-- library(reshape2) -->
<!-- mat.males <- data.frame(mat[rownames(mat) %in% variables_in_bacteria[variables_in_bacteria$interaccion=="No Obese.Male","Paciente"],]) -->
<!-- w<- apply(mat.males, 2, function(x) sum(abs(x)>1.2)>3) -->
<!-- sub.males <-mat.males[,w] -->

<!-- sub.males$subjects <- rownames(mat.males) -->
<!-- mat.males_melt <- melt(sub.males) -->
<!-- p1<-ggplot(data=mat.males_melt, -->
<!--        aes(x=variable, y=subjects, fill=value)) + geom_tile() + -->
<!--        geom_text(aes(label=round(value,1)), color='white',size=3) + theme_bw()+theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+ggtitle("Euclidean distance bwteen healthy males subjects\n and correlation between variables") -->


<!-- mat.males.obese <- data.frame(mat[rownames(mat) %in% variables_in_bacteria[variables_in_bacteria$interaccion=="Obese.Male","Paciente"],]) -->
<!-- w<- apply(mat.males.obese, 2, function(x) sum(abs(x)>1.2)>3) -->
<!-- sub.males.obese <-mat.males.obese[,w] -->

<!-- sub.males.obese$subjects <- rownames(mat.males.obese) -->
<!-- mat.males_melt.obese <- melt(sub.males.obese) -->

<!-- p2<-ggplot(data=mat.males_melt.obese, -->
<!--        aes(x=variable, y=subjects, fill=value)) + geom_tile() + -->
<!--        geom_text(aes(label=round(value,1)), color='white') + theme_bw()+theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+ggtitle("Euclidean distance bwteen obese males subjects\n and correlation between variables") -->



<!-- mat.females <- data.frame(mat[rownames(mat) %in% variables_in_bacteria[variables_in_bacteria$interaccion=="No Obese.Female","Paciente"],]) -->
<!-- w<- apply(mat.females, 2, function(x) sum(abs(x)>1.2)>5) -->
<!-- sub.females <-mat.females[,w] -->

<!-- sub.females$subjects <- rownames(sub.females) -->
<!-- mat.females_melt <- melt(sub.females) -->

<!-- p3<-ggplot(data=mat.females_melt, -->
<!--        aes(x=variable, y=subjects, fill=value)) + geom_tile() + -->
<!--        geom_text(aes(label=round(value,1)), color='white',size=2.5) + theme_bw()+theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+ggtitle("Euclidean distance bwteen healthy females subjects\n and correlation between variables") -->

<!-- p3 -->


<!-- mat.females.obese <- data.frame(mat[rownames(mat) %in% variables_in_bacteria[variables_in_bacteria$interaccion=="Obese.Female","Paciente"],]) -->
<!-- w<- apply(mat.females.obese, 2, function(x) sum(abs(x)>1.2)>3) -->
<!-- sub.females.obese <-mat.females.obese[,w] -->

<!-- sub.females.obese$subjects <- rownames(sub.females.obese) -->
<!-- mat.females_melt.obese <- melt(sub.females.obese) -->

<!-- p4<-ggplot(data=mat.females_melt.obese, -->
<!--        aes(x=variable, y=subjects, fill=value)) + geom_tile() + -->
<!--        geom_text(aes(label=round(value,1)), color='white',size=2.5) + theme_bw()+theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+ggtitle("Euclidean distance bwteen obese females subjects\n and correlation between variables") -->





<!-- mat.females.pcos <- data.frame(mat[rownames(mat) %in% variables_in_bacteria[variables_in_bacteria$interaccion=="No Obese.PCOS","Paciente"],]) -->
<!-- w<- apply(mat.females.pcos, 2, function(x) sum(abs(x)>1.2)>2) -->
<!-- sub.females.pcos <-mat.females.pcos[,w] -->

<!-- sub.females.pcos$subjects <- rownames(sub.females.pcos) -->
<!-- mat.females_melt.pcos<- melt(sub.females.pcos) -->

<!-- p5<-ggplot(data=mat.females_melt.pcos, -->
<!--        aes(x=variable, y=subjects, fill=value)) + geom_tile() + -->
<!--        geom_text(aes(label=round(value,1)), color='white',size=2) + theme_bw()+theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+ggtitle("Euclidean distance bwteen non obese PCOS females subjects\n and correlation between variables") -->




<!-- mat.females.pcos.obese <- data.frame(mat[rownames(mat) %in% variables_in_bacteria[variables_in_bacteria$interaccion=="Obese.PCOS","Paciente"],]) -->
<!-- w<- apply(mat.females.pcos.obese, 2, function(x) sum(abs(x)>1.1)>3) -->
<!-- sub.females.pcos.obese <-mat.females.pcos.obese[,w] -->

<!-- sub.females.pcos.obese$subjects <- rownames(sub.females.pcos.obese) -->
<!-- mat.females_melt.pcos.obese<- melt(sub.females.pcos.obese) -->

<!-- p6<-ggplot(data=mat.females_melt.pcos.obese, -->
<!--        aes(x=variable, y=subjects, fill=value)) + geom_tile() + -->
<!--        geom_text(aes(label=round(value,1)), color='white',size=2) + theme_bw()+theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+ggtitle("Euclidean distance bwteen  obese PCOS females subjects\n and correlation between variables") -->

<!-- p1 -->
<!-- p2 -->
<!-- p3 -->
<!-- p4 -->
<!-- p5 -->
<!-- p6 -->

<!-- ``` -->

<!-- ```{r} -->

<!-- ``` -->



<!-- ```{r} -->
<!-- par(mfrow=c(2,2)) -->
<!-- barplot(colMeans(mat.males)[abs(colMeans(mat.males))>0.8],las=2,cex.names = 0.7,col="steelblue",main="Males Heatlhy") -->

<!-- barplot(colMeans(mat.males.obese)[abs(colMeans(mat.males.obese))>0.8],las=2,cex.names = 0.7,col="steelblue",main="Males Obese") -->


<!-- barplot(colMeans(mat.females)[abs(colMeans(mat.females))>1],las=2,cex.names = 0.7,col="steelblue",main="heatlhy females") -->

<!-- barplot(colMeans(mat.females.obese -->
<!-- )[abs(colMeans(mat.females.obese -->
<!-- ))>0.8],las=2,cex.names = 0.7,col="steelblue",main="obese females") -->

<!-- pcos <- data.frame(colMeans(mat.females.pcos)[abs(colMeans(mat.females.pcos))>0.55]) -->
<!-- pcos$variables <- rownames(pcos) -->
<!-- colnames(pcos)<-c("cantidad","variables") -->

<!-- ggplot(pcos, aes(x=variables, y=cantidad)) +  -->
<!--   geom_bar(stat = "identity")+theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+labs(x="",y="")+ggtitle("non obese PCOS") -->


<!-- pcos.obese <- data.frame(colMeans(mat.females.pcos.obese)[abs(colMeans(mat.females.pcos.obese))>0.6]) -->
<!-- pcos.obese$variables <- rownames(pcos.obese) -->
<!-- colnames(pcos.obese)<-c("cantidad","variables") -->

<!-- ggplot(pcos.obese, aes(x=variables, y=cantidad)) +  -->
<!--   geom_bar(stat = "identity")+theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+labs(x="",y="")+ggtitle("obese PCOS") -->

<!-- ``` -->

<!-- ```{r,fig.height=9,fig.width=9} -->
<!-- p<-mixOmics::circosPlot(sgccda.res_genus,cutoff=0.6,size.variables=0.7,showIntraLinks=F) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- p.tmp <- p[,grep("clinical$",colnames(p),invert = F)] -->
<!-- p.clin <- p.tmp[grep("_[GLP0]$",rownames(p.tmp),invert = T),] -->

<!-- w<-apply(p.clin, 2, function(x) sum(abs(x)>0.4)>10) -->
<!-- csa <-p.clin[,w] -->
<!-- w2 <- apply(csa, 1, function(x) sum(abs(x)>0.4)>10) -->
<!-- csa2 <-data.frame(csa[w2,]) -->

<!-- csa2$subjects <- rownames(csa2) -->
<!-- csa2.melt<- melt(csa2) -->


<!-- ggplot(data=csa2.melt, -->
<!--        aes(x=variable, y=subjects, fill=value)) + geom_tile()  + theme_bw()+theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+ggtitle("General correlation between clinical variables and other blocks") -->

<!-- ``` -->


<!-- ```{r} -->
<!-- p.tmp <- p -->
<!-- p.tmp <- p.tmp[grep("_[GLP]0$",rownames(p.tmp),invert = T),] -->
<!-- p.clin <- p.tmp[grep("_clinical$",rownames(p.tmp),invert = T),] -->
<!-- p.clin <- p.clin[grep("_0$",rownames(p.clin),invert = T),] -->

<!-- w<-apply(p.clin, 1, function(x) sum(abs(x)>0.7)>1) -->
<!-- csa <-p.clin[w,] -->
<!-- csa -->
<!-- # csa2 <-data.frame(csa[w2,]) -->
<!-- #  -->
<!-- # csa2$subjects <- rownames(csa2) -->
<!-- # csa2.melt<- melt(csa2) -->
<!-- #  -->
<!-- #  -->
<!-- # ggplot(data=csa2.melt, -->
<!-- #        aes(x=variable, y=subjects, fill=value)) + geom_tile()  + theme_bw()+theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+ggtitle("General correlation between clinical variables and other blocks") -->
<!-- ``` -->

