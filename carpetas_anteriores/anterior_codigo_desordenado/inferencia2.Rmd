---
title: Integration of omics and clinical data of the hormonal, metabolic, inflammatory,
  and oxidative response in the different macronutrients of the diet
author: "Edmond Geraud"
subtitle: '`r params$subtitulo`'
date: '`r format(Sys.Date(),"%e de %B, %Y")`' 
output:
  prettydoc::html_pretty:
    theme: cayman
    highlight: github
    toc: true
  html_document:
    toc: true
    toc_depth: 2
header-includes:
  - \usepackage[english]{babel}
params:
  
  file_IP: Integromics_IPmarkers.xlsx
  file_metabolome: Integromics_Metabolome.xlsx
  file_general: Integromics_1.xlsx
  file_microbiota : integromics_microbiota.xlsx
  folder.data: ../../datos
  subtitulo: FINAL RESULTS
geometry: margin=2cm
---
```{r setup, include=FALSE}
require(knitr)
# include this code chunk as-is to set options
opts_chunk$set(comment = NA, prompt = TRUE, tidy = T, 
               fig.width = 7, fig.height = 7,echo = TRUE, 
               message = FALSE, warning = FALSE, cache=TRUE, fig_caption = TRUE)
Sys.setlocale("LC_TIME", "C")
```

## Load the libraries

```{r libraries}

list.of.packages <- c("xlsx","kableExtra","dplyr","ggplot2","egg","cowplot","patchwork","gridExtra","UsingR","car","lattice","ggpubr","ggbreak","GGally","reshape2","ggcorrplot","corrplot","rela","ggrepel","factoextra","chemometrics","sparsepca","vegan","ca","ade4","pls","OmicsPLS")
new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])] ## check for packages not installed 
if(length(new.packages)) install.packages(new.packages) ## install packages if necessary
res<-unlist(lapply(list.of.packages, require,character.only = T)) ## load packages needed for the session
# if(any(res==F)){
  list.of.packages[which(res==F)]  ## show those package if you have troubles to install.


list.of.bioc.packages <- c("phyloseq","pcaMethods","ropls","mixOmics","limma","DESeq2")
new.packages.bioc <- list.of.packages[!(list.of.bioc.packages %in% installed.packages()[,"Package"])]
if(length(new.packages.bioc)) BiocManager::install(new.packages.bioc)
res.bioc <- unlist(lapply(list.of.bioc.packages, require,character.only = T)) 
if(any(res.bioc==F)){
  list.of.packages[which(res.bioc==F)]  ## show those package if you have troubles to install.
}
```
# Funciones
```{r functions}


proces_bacteria <- function(datos,tipo){

  Order <- bacteria_phylum.abs$Order
  variables_in_bacteria <- general_data[general_data$Orden %in% Order , ]
  Sample<-variables_in_bacteria$Paciente


  if(tipo=="genera"){

    Order <- Order

    X <- datos[-1,-1]
    X<-apply(X,2,as.numeric)
    colnames(X) <- datos[1,2:ncol(datos)]
    rownames(X) <- Sample
    X.rel <- 100*X/rowSums(X)


  } else if(tipo=="phylum"){

    X <- datos[,-c(1:2)]
    colnames(X) <- colnames(datos)[3:ncol(datos)]
    rownames(X) <- Sample
    X.rel<-100*X/rowSums(X)
  }

  GROUP <-variables_in_bacteria$GROUP
  SEX <- variables_in_bacteria$SEX
  OBESE<- variables_in_bacteria$OBESE

  X<-as.data.frame(X)
  X.rel<-as.data.frame(X.rel)

  X$GROUP<-GROUP
  X$SEX<-SEX
  X$OBESE<-OBESE


  X.rel$GROUP<-GROUP
  X.rel$SEX<-SEX
  X.rel$OBESE<-OBESE

  return(list(abs=X,rel=X.rel))

}


low.count.removal = function(
                        data, # OTU count data frame of size n (sample) x p (OTU)
                        percent=0.01 # cutoff chosen
                        ){
    keep.otu = which(colSums(data)*100/(sum(colSums(data))) > percent)
    data.filter = data[,keep.otu]
    return(list(data.filter = data.filter, keep.otu = keep.otu))
}

low.count.removal.counts = function(
                        data, # OTU count data frame of size n (sample) x p (OTU)
                        abundance=10 # cutoff chosen
                        ){
    keep.otu <- which(colSums(data)>abundance)
    data.filter <-data[,keep.otu]
    return(list(data.filter = data.filter, keep.otu = keep.otu))
}

relative.fn <-function(data){
  
  return(100*data/rowSums(data))
  
}


common.bacteria <- function(datos_i,datos.comunes){
  

  ## retorna los indices con las variables comunes

  interaccion <- interaction(datos.comunes$GROUP,datos.comunes$OBESE)
  datos.comunes$interaccion <- interaccion
  grupo <-levels(interaccion)
  w<-vector(mode="list",length=6)
  names(w)<-levels(interaccion)
  for(i in 1:6){
   w[[names(w)[i]]]<-which(apply(as.matrix(datos_i[
    rownames(datos_i)%in%
      datos.comunes[datos.comunes$interaccion==grupo[i],"Paciente"],]),2,function(x) sum(x)==0))
  }

  w2<-vector(mode="list",length=6)
  names(w2)<-levels(interaccion)
  for(i in 1:6){
   w2[[names(w2)[i]]]<-which(apply(as.matrix(datos_i[
    rownames(datos_i)%in%
      datos.comunes[datos.comunes$interaccion==grupo[i],"Paciente"],]),2,function(x) sum(x)>0))
    }

  w3<-lapply(w2, names)
  common_variables <-Reduce(intersect,x = w3)

  return(common_variables)
}

fn.densidad <- function(datos,fctr){
  column_var=c("interaccion","variable","value")
  columnas <- colnames(datos)
  filas <- rownames(datos)
  X<-data.frame(apply(datos, 2, as.numeric))
  colnames(X)<-columnas
  rownames(X)<-filas
  X$fctr<-fctr
  X.melt <- melt(X)
  colnames(X.melt)<-column_var
  p<-ggplot(data=X.melt,aes(x=value,color=interaccion))+geom_density()
  
  return(p)
}

fn.boxplot<-function(datos,fctr){
  column_var=c("interaccion","variable","value")
  columnas <- colnames(datos)
  filas <- rownames(datos)
  X<-data.frame(apply(datos, 2, as.numeric))
  colnames(X)<-columnas
  rownames(X)<-filas
  X$fctr<-fctr
  X.melt <- melt(X)
  colnames(X.melt)<-column_var
  
  p<-ggplot(X.melt,aes(x=interaccion,y=value,fill=interaccion))+geom_boxplot()+theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
  return(p)
}


graphPCA.methods <- function(datos,datos.common,varianzas){
  
  
  sujetos <-as.data.frame(datos)
  sexo<-datos.common$GROUP
  obesidad<-datos.common$OBESE
  colnames(sujetos)<-c("PC1","PC2")
  p1<-ggplot(sujetos,aes(x=PC1, y=PC2)) +
     geom_hline(yintercept = 0, color = "gray70") +
     geom_vline(xintercept = 0, color = "gray70") +
     geom_point(aes(color = sexo,shape=obesidad,fill=obesidad), alpha = 0.55, size = 3) +
     coord_cartesian(xlim = c(min(sujetos[,1]),max(sujetos[,1]))) +
     scale_color_manual(values=c("black","red","green"))+scale_shape_manual(values=c(17,15))+xlab(paste("PC1",round(varianzas[1],2),"%"))+ylab(paste("PC2",round(varianzas[2],2),"%"))
  return(p1)
}
graphPCA.methods2 <- function(datos,datos.common,varianzas){
  
  
  sujetos <-as.data.frame(datos)
  sexo<-datos.common$GROUP
  obesidad<-datos.common$OBESE
  colnames(sujetos)<-c("PC1","PC2")
  p1<-ggplot(sujetos,aes(x=PC1, y=PC2)) +
     geom_hline(yintercept = 0, color = "gray70") +
     geom_vline(xintercept = 0, color = "gray70") +
     geom_point(aes(color = obesidad,shape=sexo,fill=obesidad), alpha = 0.55, size = 3) +
     coord_cartesian(xlim = c(min(sujetos[,1]),max(sujetos[,1]))) +
     scale_color_manual(values=c("black","red"))+scale_shape_manual(values=c(17,15,14))+xlab(paste("PC1",round(varianzas[1],2),"%"))+ylab(paste("PC2",round(varianzas[2],2),"%"))
  return(p1)
}

```


# Cargamos los datos

## Datos clinicos

```{r}
general_data <- read.xlsx(file.path(params$folder.data,params$file_general),sheetIndex =1)
general_data$SEX <- factor(general_data$SEX, levels = c(0, 2), labels = c("Female", "Male"))
general_data$OBESE <- factor(general_data$OBESE, levels = c(0, 1), labels = c("No Obese", "Obese"))
general_data$GROUP <- factor(general_data$GROUP, levels = c(0, 1, 2), labels = c("Female",  "PCOS", "Male"))


```


## Datos IP

```{r}

IP_file<-file.path(params$folder.data,file=params$file_IP) ## file path of the data
IP.tmp<-read.xlsx(IP_file,sheetIndex = 1)
IP<-IP.tmp[,-7] # remove the missin values column
IP$SEX <- factor(IP$SEX,levels=c(0,2),labels = c("Female","Male"))
IP$OBESE <- factor(IP$OBESE,levels=c(0,1),labels = c("No Obese","Obese"))
IP$GROUP <- factor(IP$GROUP,levels=c(0,1,2),labels = c("Female","PCOS","Male"))

```

## Datos Metaboloma

```{r}
metabolome_file<-file.path(params$folder.data,file=params$file_metabolome) ## file path of the data
metabolome.tmp<-read.xlsx(metabolome_file,sheetIndex = 1) # read the data
metabolites_name <- read.xlsx(metabolome_file,sheetIndex = 2)$Metabolitos # read the names of the metabolites
any(is.na(metabolome.tmp)) # there is a row of missing values.
metabolome<-metabolome.tmp[-nrow(metabolome.tmp),] ## remove the missing value row
metabolome$GROUP<-general_data$GROUP ## add GROUP variable 
metabolome$OBESE <- general_data$OBESE ## add OBESE variables.

```


## Datos microbioma

```{r}
bacteria_phylum.abs <- as.data.frame(read.xlsx(file.path(params$folder.data,params$file_microbiota), sheetIndex = 1))
bacteria_genera.abs <- as.data.frame(t(read.xlsx(file.path(params$folder.data,params$file_microbiota), sheetIndex = 3)))
phylum.list <- proces_bacteria(bacteria_phylum.abs,tipo="phylum")
genera.list <- proces_bacteria(bacteria_genera.abs,tipo="genera")

phylum.abs <- phylum.list$abs;phylum.rel<-phylum.list$rel
genera.abs <- genera.list$abs;genera.rel<-genera.list$rel

```

# Preparando los datos para la integracion
```{r}
variables_in_bacteria <- general_data[general_data$Orden %in% bacteria_phylum.abs$Order, ]

```

## Datos Clinicos
**NOTE we are going to include also on both levels of integration body measures**
We exclude ISI because it is measured after the load of glucose, the mean values, to exclude redundancy of the data, ant the postprandial levels. 


```{r}
sujetos <- variables_in_bacteria$Paciente
Clin.tmp <- variables_in_bacteria[,-c(1,2,3,4,5)] # get rid off orden, paciente, sex, group and obese
auc_clin <- colnames(Clin.tmp)[grep("AUC",colnames(Clin.tmp))]
mean_basal_clin<-colnames(Clin.tmp)[grep("_B$",colnames(Clin.tmp))]
sog <- colnames(Clin.tmp)[grep("^SO[GLP]",colnames(Clin.tmp))]
variables_clin <- colnames(Clin.tmp)
testosterona <-colnames(Clin.tmp)[grep("TEST",colnames(Clin.tmp))]
interr<-colnames(Clin.tmp)[grep("interaccion",colnames(Clin.tmp))]
ratio <- colnames(Clin.tmp)[grep("Ratio",colnames(Clin.tmp))]
w<-c(which(variables_clin %in% auc_clin),which(variables_clin %in% mean_basal_clin),which(variables_clin %in% sog),which(variables_clin %in% testosterona),
which(variables_clin %in% interr),which(variables_clin %in% ratio))
Clin <- Clin.tmp[,-w] 
rownames(Clin) <- sujetos
colnames(Clin)
```


## Datos IP
```{r}
IP.tmp <- IP[IP$Paciente %in% variables_in_bacteria$Paciente,]
redundant_variables <- c("Orden","Paciente","SEX","GROUP","OBESE","BMI")
variables_ip <- colnames(IP.tmp)
auc_ip <- variables_ip[grep("AUC",variables_ip)]
mean_ip <- variables_ip[grep("_0$",variables_ip)]
w <- c(which(variables_ip %in% redundant_variables),which(variables_ip %in% auc_ip),which(variables_ip %in% mean_ip))
IP.basal <- IP.tmp[,-w]
rownames(IP.basal) <- sujetos

```

## Metabolome data (37)

```{r}
metabolome.basal.tmp <- metabolome[metabolome$Order %in% variables_in_bacteria$Orden,]
redundant_data_meta <- c("Order","Sample","GROUP","OBESE")
variables_meta <- colnames(metabolome.basal.tmp)
mean_meta <- variables_meta[grep("_[GLP]0$",variables_meta)]
auc_meta <- variables_meta[grep("AU[CG]",variables_meta)]
w <- c(which(variables_meta %in% redundant_data_meta),which(variables_meta %in% mean_meta),which(variables_meta %in% auc_meta))
metabolome.basal_mean <- metabolome.basal.tmp[,-w]
rownames(metabolome.basal_mean) <- sujetos
colnames(metabolome.basal_mean)
```
## Datos microbioma

### Datos genero

```{r}

genera.abs.tmp <- genera.abs
redundant_data_ph <- c("GROUP","SEX","OBESE")
genus.tmp.tmp <- genera.abs.tmp[,-c(ncol(genera.abs.tmp)-2,ncol(genera.abs.tmp)-1,ncol(genera.abs.tmp))]
genus <- genus.tmp.tmp[,colSums(genus.tmp.tmp)>0]
rownames(genus) <- sujetos
## removal of genus unidentified

genus<-genus[,-grep("^ud-",colnames(genus))]

common_genus <-common.bacteria(genus,variables_in_bacteria)

genus<-genus[,common_genus]
genus.abs <- low.count.removal.counts(genus,10)$data.filter

```

# Datos que necesitamos

```{r}

pacientes <- variables_in_bacteria$Paciente
grupo<-variables_in_bacteria$GROUP
obesidad <- factor(gsub(" ",".",variables_in_bacteria$OBESE))
interaccion<-factor(paste(obesidad,grupo,sep="_"))
datos.common <- variables_in_bacteria[,c("GROUP","OBESE","Paciente")]
columnData <- data.frame(interaccion=interaccion)
rownames(columnData) <- pacientes

```

# Descriptiva

## Metaboloma

```{r}
met37<-t(metabolome.basal_mean)
met37_norm <- met37/rowSums(met37)
met37_log <- t(apply(met37_norm,1,log))
X<-(voom(met37_norm,normalize.method = "quantile")$E)
p1<-fn.densidad((t(X)),interaccion)
p2<-fn.boxplot(t(X),interaccion)
pcx <- prcomp(t(X),scale=F,center=T)
varianzas <- 100*(pcx$sdev^2/sum(pcx$sdev^2))
p3<-graphPCA.methods(pcx$x,datos.common,varianzas)+ggtitle("PCA")

U3 <- pcx$x
apply(U3, 2, function(x) which( abs(x - mean(x)) > (6 * sd(x)) ))



pcx.cor <- princomp(x=cor((X),method = "spearman"),cor=T)
varianzas <- 100*(pcx.cor$sdev^2/sum(pcx.cor$sdev^2))
p4<-graphPCA.methods(pcx.cor$scores[,1:2],datos.common,varianzas)+ggtitle("PCA spearman")

plsda.met <- plsda(t(X),interaccion,scale = T)
p5<-graphPCA.methods(plsda.met$variates$X,datos.common,varianzas)+ggtitle("PLS-DA")

p7 <-graphPCA.methods2(pcx$x,datos.common,varianzas)+ggtitle("PCA")

euc <- vegdist(t(X),method = "euclidean")
points<-cmdscale(euc)
p6<-graphPCA.methods(points,datos.common,varianzas)+ggtitle("MDS")
ggarrange(p1,p2,p3,p7,
          common.legend = T)
ggarrange(p3,p4,p5,p6,ncol=2,nrow=2,common.legend = T)
ggarrange(p3,p7)
(res<-adonis2(euc~obesidad*grupo))

```




```{r}
fviz_pca_var(pcx)
```

```{r}
fviz_eig(pcx, addlabels = TRUE, ylim = c(0, 50))

```
```{r}
var.pca <- get_pca_var(pcx)
corrplot::corrplot(var.pca$cos2, is.corr=FALSE)
```
```{r}
fviz_contrib(pcx, choice = "var", axes = 1, top = 10)
```
```{r}
fviz_contrib(pcx, choice = "var", axes = 2, top = 10)
```

## Microbioma

Segun la guia del paper que me dio Susana, tenemos 2 opciones

```{r}
genera.abs.tmp <- genera.abs
redundant_data_ph <- c("GROUP","SEX","OBESE")
genus.tmp.tmp <- genera.abs.tmp[,-c(ncol(genera.abs.tmp)-2,ncol(genera.abs.tmp)-1,ncol(genera.abs.tmp))]
genus <- genus.tmp.tmp[,colSums(genus.tmp.tmp)>0]
rownames(genus) <- sujetos
## removal of genus unidentified

genus<-genus[,-grep("^ud-",colnames(genus))]

common_genus <-common.bacteria(genus,variables_in_bacteria)

genus<-genus[,common_genus]
genus.abs <- low.count.removal.counts(genus,10)$data.filter
library(zCompositions)
# genus.imput <-cmultRepl(X = (genus.abs),label = 0,output = "p-counts")
# genus.G <-(logratio.transfo(t(genus.imput),logratio = "CLR"))

genus.imput <-cmultRepl(X = (genus.abs),label = 0,output = "p-counts")

G <-matrix(t(logratio.transfo(t(genus.imput),logratio = "CLR")),ncol=ncol(genus.abs),nrow(genus.abs))

X<-t(G)
rownames(X) <- colnames(genus.abs)
colnames(X) <- rownames(genus.abs)
p1<-fn.densidad(t((X)),interaccion)
p2<-fn.boxplot(t(X),interaccion)
pcx <- prcomp(t(X),scale=F,center=T)

varianzas <- 100*(pcx$sdev^2/sum(pcx$sdev^2))
p3<-graphPCA.methods(pcx$x,datos.common,varianzas)+ggtitle("PCA")

U3 <- pcx$x
apply(U3, 2, function(x) which( abs(x - mean(x)) > (6 * sd(x)) ))



pcx.cor <- princomp(x=cor((X),method = "spearman"),cor=T)
varianzas <- 100*(pcx.cor$sdev^2/sum(pcx.cor$sdev^2))
p4<-graphPCA.methods(pcx.cor$scores[,1:2],datos.common,varianzas)+ggtitle("PCA spearman")

plsda.met <- plsda(t(X),interaccion,scale = T)
p5<-graphPCA.methods(plsda.met$variates$X,datos.common,varianzas)+ggtitle("PLS-DA")


euc <- vegdist(t(X),method = "euclidean")
points<-cmdscale(euc)
p6<-graphPCA.methods(points,datos.common,varianzas)+ggtitle("MDS")
ggarrange(p1,p2,ncol=2,common.legend = T)
ggarrange(p3,p4,p5,p6,ncol=2,nrow=2,common.legend = T)

(res<-adonis2(t(X)~obesidad*grupo,method = "euclidean"))
(res<-adonis2(plsda.met$X~obesidad*grupo,method = "euclidean"))
```



```{r}
varianzas <- 100*(pcx$sdev^2/sum(pcx$sdev^2))

p3<-graphPCA.methods(pcx$x,datos.common,varianzas)+ggtitle("PCA")
p4<-graphPCA.methods2(pcx$x,datos.common,varianzas)+ggtitle("PCA")
ggarrange(p3,p4,common.legend = T)
```



```{r}
fviz_eig(pcx, addlabels = TRUE, ylim = c(0, 50))

```
```{r}
var.pca <- get_pca_var(pcx)
corrplot::corrplot(var.pca$cos2, is.corr=FALSE)
```
```{r}
fviz_contrib(pcx, choice = "var", axes = 1, top = 10)
```
```{r}
fviz_contrib(pcx, choice = "var", axes = 2, top = 10)
```
## integracion



```{r}
library(ALDEx2)
library(MOFA2)
G.clr <- aldex.clr(t(genus.abs),conds=interaccion)
metaboloma<-(voom(met37_norm,normalize.method = "quantile")$E)

mc.all <- getMonteCarloInstances(G.clr)
mc.intstances <-numMCInstances(G.clr)
list.trained2 <- vector("list",length = 128)
list.adonis <- vector("list",length = 128)
  for (mc.i in 1:mc.intstances){

    t.input <- sapply(mc.all, function(y) {
      y[, mc.i]
    })
    
    colnames(t.input) <- pacientes
    rownames(t.input) <- colnames(genus.abs)
    datos <- list(metaboloma=(metaboloma),microbioma=(t.input))
    MOFAobject <-create_mofa_from_matrix(datos)
    samples_metadata(MOFAobject)<- data.frame(sample=pacientes,obesidad=(obesidad),grupo=(grupo),edad=Clin$EDAD,BMI=Clin$BMI,WC=Clin$WC,WHR=Clin$WHR,SHGB=Clin$SHBG,hsCRP=Clin$hsCRP,TE2=Clin$Total_ESTR,E2=Clin$Free_ESTRA,obesidad=as.numeric(obesidad),grupo=as.numeric(grupo),edad=Clin$EDAD,BMI=Clin$BMI,WC=Clin$WC,WHR=Clin$WHR,SHGB=Clin$SHBG,hsCRP=Clin$hsCRP,TE2=Clin$Total_ESTR,E2=Clin$Free_ESTRA,CD14=IP$CD14_basalmean[IP$Paciente %in% variables_in_bacteria$Paciente],LBP=IP$LBP_basalmean[IP$Paciente %in% variables_in_bacteria$Paciente],GLP2=IP$GLP2_basalmean[IP$Paciente %in% variables_in_bacteria$Paciente],Zonulin=IP$Zonulin_basalmean[IP$Paciente %in% variables_in_bacteria$Paciente],Succinate=IP$Succin_basalmea[IP$Paciente %in% variables_in_bacteria$Paciente],SEX=IP$SEX[IP$Paciente %in% variables_in_bacteria$Paciente],interaccion=interaction(variables_in_bacteria$OBESE,variables_in_bacteria$GROUP))
    rownames(samples_metadata(MOFAobject))<-pacientes
       data_opts <- get_default_data_options(MOFAobject)
       data_opts$scale_views <-T
 model_opts <- get_default_model_options(MOFAobject)
 
train_opts <- get_default_training_options(MOFAobject)
  MOFAobject <- prepare_mofa(
  object = MOFAobject,
  data_options = data_opts,
  model_options = model_opts,
  training_options = train_opts
)
outfile <- file.path(getwd(),"model.hdf5")
reticulate::use_python("/usr/bin/python3")

  MOFAobject.trained <- run_mofa(MOFAobject, outfile,use_basilisk = F)
MOFAobject.trained@covariates<-data.frame(obesidad=as.numeric(obesidad),grupo=as.numeric(grupo),edad=Clin$EDAD,BMI=Clin$BMI,WC=Clin$WC,WHR=Clin$WHR,SHGB=Clin$SHBG,hsCRP=Clin$hsCRP,TE2=Clin$Total_ESTR,E2=Clin$Free_ESTRA,CD14=IP$CD14_basalmean[IP$Paciente %in% variables_in_bacteria$Paciente],LBP=IP$LBP_basalmean[IP$Paciente %in% variables_in_bacteria$Paciente],GLP2=IP$GLP2_basalmean[IP$Paciente %in% variables_in_bacteria$Paciente],Zonulin=IP$Zonulin_basalmean[IP$Paciente %in% variables_in_bacteria$Paciente],Succinate=IP$Succin_basalmea[IP$Paciente %in% variables_in_bacteria$Paciente],SEX=IP$SEX[IP$Paciente %in% variables_in_bacteria$Paciente],interaccion=interaction(variables_in_bacteria$OBESE,variables_in_bacteria$GROUP))

model <- MOFAobject.trained
factors <- get_factors(model, as.data.frame = T,scale = F)

weights <- rbind(get_weights(model,as.data.frame=T,scale=F,views="metaboloma"),
                 get_weights(model,as.data.frame=T,scale=F,views="microbioma"))
                 
factores.recast <-as.data.frame(reshape2::recast(data=factors,sample~factor))
rownames(factores.recast) <- factores.recast$sample
factores.recast <- factores.recast[,-1]
weights.recast <-as.data.frame(reshape2::recast(data=weights,feature~factor))
rownames(weights.recast) <- weights.recast$feature
weights.recast <- weights.recast[,-1]
weights.recast$views <- c(rep("metabooloma",37),rep("microbioma",94))
Y <-(as.matrix(factores.recast) %*% t(weights.recast[,-ncol(weights.recast)]))
rownames(Y) <- pacientes
colnames(Y) <- rownames(weights.recast)
res <-adonis2(Y ~ obesidad*grupo,method="euclidean")
list.adonis[[mc.i]] <- res
  list.trained2[[mc.i]]<- MOFAobject.trained
  
  
  
  
  }

```



```{r}
model <- list.trained2[[which.max(unlist(lapply(list.trained2,function(x) get_elbo(x))))]]
```


```{r}
head(model@cache$variance_explained$r2_total[[1]]) # group 1/
```
```{r}

head(model@cache$variance_explained$r2_total[[1]]) # group 1/


plot_variance_explained(model, x="view", y="factor")

```
```{r}
plot_factor_cor(model)

```

```{r}
correlate_factors_with_covariates(model,
  covariates = c("obesidad","grupo","edad","BMI","WC","WHR","SHGB","hsCRP","TE2","E2","SEX","LBP","GLP2","Zonulin","Succinate","interaccion"),
  plot="log_pval"
)
```
```{r}
plot_factor(model, 
  factor = 1,
  color_by = "grupo",
  shape_by = "obesidad",add_violin = F
)
```

```{r}
p1<-plot_factor(model, 
  factors = c(1,6,3), 
  color_by = "grupo",
  shape_by = "obesidad",
  add_violin = TRUE,
  dodge = TRUE
)
p1
```
```{r}
p1<-plot_factor(model, 
  factors = c(1:3), 
  color_by = "grupo",
  shape_by = "obesidad",
  add_violin = TRUE,
  dodge = TRUE
)
p1
```

## inspeccion metaboloma
```{r}
plot_top_weights(model, view = "metaboloma", factors = c(1))

```


```{r}
p<-p1
datos.gg<-p$data
datos.gg$interaccion<-interaction(p$data$color_by,p$data$shape_by)
datos.gg$interaccion <- factor(datos.gg$interaccion,levels=c("Female.No.Obese","Female.Obese",
                                  "Male.No.Obese","Male.Obese",
                                  "PCOS.No.Obese","PCOS.Obese"))
ggstatsplot::ggbetweenstats(datos.gg[datos.gg$factor=="Factor1",],y=value,x=interaccion,type="np")
```

```{r}
plot_factors(model, 
  factors = c(1,3,5),
  color_by = "obesidad",
  shape_by = "grupo",
  dot_size = 3
)
```



## Inspection metaboloma

```{r}
plot_weights(model,
 view = "metaboloma",
 factor = 1,
 nfeatures = 10,     # Top number of features to highlight
 scale = T        # Scale weights from -1 to 1
)

```




```{r}
plot_top_weights(model,
 view = "metaboloma",
 factor = 1,
 nfeatures = 10,     # Top number of features to highlight
 scale = T           # Scale weights from -1 to 1
)

```


```{r}
plot_top_weights(model,
 view = "microbioma",
 factor = 4:5,
 nfeatures = 10,     # Top number of features to highlight
 scale = T           # Scale weights from -1 to 1
)

```

## En general


```{r}
factors <- get_factors(model, as.data.frame = T,scale = F)

weights <- rbind(get_weights(model,as.data.frame=T,scale=F,views="metaboloma"),
                 get_weights(model,as.data.frame=T,scale=F,views="microbioma"))
                 
factores.recast <-as.data.frame(reshape2::recast(data=factors,sample~factor))
rownames(factores.recast) <- factores.recast$sample
factores.recast <- factores.recast[,-1]
weights.recast <-as.data.frame(reshape2::recast(data=weights,feature~factor))
rownames(weights.recast) <- weights.recast$feature
weights.recast <- weights.recast[,-1]
weights.recast$views <- c(rep("metabooloma",37),rep("microbioma",94))
```
### PLSDA
```{r}
Y <-(as.matrix(factores.recast) %*% t(weights.recast[,-ncol(weights.recast)]))
rownames(Y) <- pacientes
colnames(Y) <- rownames(weights.recast)
plsda.int <- plsda(Y,grupo)
p1<-graphPCA.methods2(plsda.int$variates$X,datos.common,varianzas=c(plsda.int$prop_expl_var$X[1],plsda.int$prop_expl_var$X[2]))+ggtitle("PLS-DA - obesidad")
plsda.int <- plsda(Y,obesidad)

p2 <-graphPCA.methods(plsda.int$variates$X,datos.common,varianzas=c(plsda.int$prop_expl_var$X[1],plsda.int$prop_expl_var$X[2]))+ggtitle("PLS-DA - grupo")

plsda.int <- plsda(Y,interaccion)

p3 <-graphPCA.methods(plsda.int$variates$X,datos.common,varianzas=c(plsda.int$prop_expl_var$X[1],plsda.int$prop_expl_var$X[2]))+ggtitle("PLS-DA - interaccion")

pcx <- prcomp((Y),scale=F,center=T)
varianzas <- 100*(pcx$sdev^2/sum(pcx$sdev^2))
p4 <-graphPCA.methods2(pcx$x,datos.common,varianzas)+ggtitle("PCA")

ggarrange(p2,p3,common.legend = T)
ggarrange(p1,p4,common.legend = T)

```



```{r}
Y <-(as.matrix(factores.recast) %*% t(weights.recast[,-ncol(weights.recast)]))

datos <- as.data.frame(Y)
grupo<-variables_in_bacteria$GROUP
obesidad <- factor(gsub(" ",".",variables_in_bacteria$OBESE))
interaccion<-factor(paste(obesidad,grupo,sep="_"))

adonis2(Y ~ obesidad*grupo,method="euclidean")
```


```{r}
datos$grupo <- grupo
datos$obesidad <- obesidad
datos$interaccion <- interaccion
datos$sexo <- variables_in_bacteria$SEX

FEMALES <- datos[datos$sexo=="Female",-c(135,134,133,132)]
MALES <- datos[datos$sexo=="Male",-c(135,134,133,132)]

#### gruposde interes
females <- datos[datos$grupo=="Female",-c(135,134,133,132)]
males <- datos[datos$grupo=="Male",-c(135,134,133,132)]
pcos <- datos[datos$grupo=="PCOS",-c(135,134,133,132)]
obesos <- datos[datos$obesidad=="Obese",-c(135,134,133,132)]
No.Obesos <- datos[datos$obesidad=="No.Obese",-c(135,134,133,132)]
#### interacciones
females.no.obese <- datos[datos$interaccion=="No.Obese_Female",-c(135,134,133,132)]
females.obese <- datos[datos$interaccion=="Obese_Female",-c(135,134,133,132)]
males.no.obese <-  datos[datos$interaccion=="No.Obese_Male",-c(135,134,133,132)]
males.obese <-  datos[datos$interaccion=="Obese_Male",-c(135,134,133,132)]
pcos.no.obese <- datos[datos$interaccion=="No.Obese_PCOS",-c(135,134,133,132)]
pcos.obese <- datos[datos$interaccion=="Obese_PCOS",-c(135,134,133,132)]

grupo<-variables_in_bacteria$GROUP
obesidad <- factor(gsub(" ",".",variables_in_bacteria$OBESE))
interaccion<-factor(paste(obesidad,grupo,sep="_"))
sexo <- variables_in_bacteria$SEX
(combinaciones.interaccion <- matrix(c(levels(interaccion)[1:3],levels(interaccion)[4:6]),ncol=2,nrow = 3))
combinaciones.grupo <- t(combn(levels(grupo),2))
combinaciones.obesos <- t(combn(levels(obesidad),2))
combinaciones.sexos <- t(combn(levels(sexo),2))
lista.sexo <- list(Female=FEMALES,Male=MALES)
lista.obesos <- list(Obese=obesos,No.Obese=No.Obesos)
lista.grupo <- list(Female=females,Male=males,PCOS=pcos)
lista.sujetos <- list(No.Obese_Female=females.no.obese,
                      Obese_Female=females.obese,
                      No.Obese_PCOS=pcos.no.obese,
                      Obese_PCOS=pcos.obese,
                      No.Obese_Male=males.no.obese,
                      Obese_Male=males.obese)
matriz.sexos <- as.data.frame(matrix(NA,ncol=1,nrow=131))
colnames(matriz.sexos)<-apply(combinaciones.obesos, 1, function(x) paste(x[1],x[2],sep="_vs_"))
rownames(matriz.sexos) <-colnames(datos)[-c(135,134,133,132)]
matriz.obesos <- as.data.frame(matrix(NA,ncol=1,nrow=131))
colnames(matriz.obesos)<-apply(combinaciones.obesos, 1, function(x) paste(x[1],x[2],sep="_vs_"))
rownames(matriz.obesos) <-colnames(datos)[-c(135,134,133,132)]

## obesos

for(j in 1:131){
for(i in 1:dim(combinaciones.obesos)[1]){
  x<-lista.obesos[[combinaciones.obesos[i,1]]][,j]
  y <- lista.obesos[[combinaciones.obesos[i,2]]][,j]
  matriz.obesos[j,i]<-wilcox.test(x,y)$p.value

  
}
}

matriz.grupo <- as.data.frame(matrix(NA,ncol=3,nrow=131))
colnames(matriz.grupo)<-apply(combinaciones.grupo, 1, function(x) paste(x[1],x[2],sep="_vs_"))
rownames(matriz.grupo) <-colnames(datos)[-c(135,134,133,132)]

## sexo
for(j in 1:131){
for(i in 1:dim(combinaciones.sexos)[1]){
  x<-lista.sexo[[combinaciones.sexos[i,1]]][,j]
  y <- lista.sexo[[combinaciones.sexos[i,2]]][,j]
  matriz.sexos[j,i]<-wilcox.test(x,y)$p.value

  
}
}


## grupo
for(j in 1:131){
for(i in 1:dim(combinaciones.grupo)[1]){
  x<-lista.grupo[[combinaciones.grupo[i,1]]][,j]
  y <- lista.grupo[[combinaciones.grupo[i,2]]][,j]
  matriz.grupo[j,i]<-wilcox.test(x,y)$p.value

  
}
}

matriz.grupo.adj <- as.data.frame(t(apply(matriz.grupo, 1, function(x) p.adjust(x,method="BH"))))


## interaccion

matriz.interaccion <- as.data.frame(matrix(NA,ncol=3,nrow=131))
colnames(matriz.interaccion)<-apply(combinaciones.interaccion, 1, function(x) paste(x[1],x[2],sep="_vs_"))
rownames(matriz.interaccion) <-colnames(datos)[-c(135,134,133,132)]

for(j in 1:131){
for(i in 1:dim(combinaciones.interaccion)[1]){
  x<-lista.sujetos[[combinaciones.interaccion[i,1]]][,j]
  y <- lista.sujetos[[combinaciones.interaccion[i,2]]][,j]
  matriz.interaccion[j,i]<-wilcox.test(x,y)$p.value

  
}
}

matriz.interaccion.adj <- as.data.frame(t(apply(matriz.interaccion, 1, function(x) p.adjust(x,method="BH"))))

df.obesos <-data.frame(obesos_vs_no.obesos=matriz.obesos[which(matriz.obesos[,1]<0.05),])
rownames(df.obesos) <- rownames(matriz.obesos)[which(matriz.obesos[,1]<0.05)]

df.sexos <-data.frame(obesos_vs_no.obesos=matriz.sexos[which(matriz.sexos[,1]<0.05),])
rownames(df.sexos) <- rownames(matriz.sexos)[which(matriz.sexos[,1]<0.05)]


w <- which(apply(matriz.grupo.adj, 1, function(x) any(x<0.05)))
df.grupo <-data.frame(matriz.grupo.adj[w,])
colnames(df.grupo) <- colnames(matriz.grupo.adj)
rownames(df.grupo) <- rownames(matriz.grupo.adj)[w]
df.grupo
w <- which(apply(matriz.interaccion.adj, 1, function(x) any(x<0.05)))
df.interaccion <-data.frame(matriz.interaccion.adj[w,])
colnames(df.interaccion) <- colnames(matriz.interaccion.adj)
rownames(df.interaccion) <- rownames(matriz.interaccion.adj)[w]

```


```{r}
(res<-adonis2(Y~grupo*obesidad,method = "euclidean"))
```

```{r}
(intr <- rownames((df.interaccion[df.interaccion$No.Obese_Female_vs_Obese_Female<0.05 & df.interaccion$No.Obese_Male_vs_Obese_Male>0.05 & df.interaccion$No.Obese_PCOS_vs_Obese_PCOS>0.05,])))
```

```{r}
(intr2 <- rownames(df.interaccion[df.interaccion$No.Obese_Female_vs_Obese_Female>0.05 & df.interaccion$No.Obese_Male_vs_Obese_Male<0.05 & df.interaccion$No.Obese_PCOS_vs_Obese_PCOS>0.05,]))
```


```{r}
(intr3 <- rownames(df.interaccion[df.interaccion$No.Obese_Female_vs_Obese_Female>0.05 & df.interaccion$No.Obese_Male_vs_Obese_Male>0.05 & df.interaccion$No.Obese_PCOS_vs_Obese_PCOS<0.05,]))
```
```{r}
(gru1<-rownames(df.grupo[df.grupo$Female_vs_PCOS<0.05 & df.grupo$Female_vs_Male>0.05 & df.grupo$PCOS_vs_Male>0.05,]))
```
```{r}
(gru2 <- rownames(df.grupo[df.grupo$Female_vs_PCOS>0.05 & df.grupo$Female_vs_Male<0.05 & df.grupo$PCOS_vs_Male>0.05,]))

```
```{r}
(gru3 <- rownames(df.grupo[df.grupo$Female_vs_PCOS>0.05 & df.grupo$Female_vs_Male>0.05 & df.grupo$PCOS_vs_Male<0.05,]))

```

```{r}
(ob1 <-rownames(df.obesos)[which(df.obesos[,1]<0.05)])
```

```{r}
(ob2 <-rownames(df.sexos)[which(df.sexos[,1]<0.05)])
```



```{r}
vars <-data.frame(features=Reduce("union",list(intr,intr2,intr3,gru1,gru2,gru3,ob1,ob2)))
vars$features <- vars$features
vars$views <- ifelse(vars$features %in% rownames(metaboloma),"metaboloma","microbioma")
vars <- vars[order(vars$views),]

```

```{r}
library(Hotelling)
(res.g1 <- hotelling.test(females,pcos,shrinkage = T,var.equal = F,perm = T,B=1000))
(res.g2 <- hotelling.test(females,males,shrinkage = T,var.equal = F,perm = T,B=1000))
(res.g3 <- hotelling.test(pcos,males,shrinkage = T,var.equal = F,perm = T,B=1000))
```

```{r}
(res.ob <- hotelling.test(obesos,No.Obesos,shrinkage = T,var.equal = F,perm = T,B=1000))

```

```{r}
(int1 <- hotelling.test(females.no.obese,females.obese,shrinkage = T,var.equal = F,perm = T,B=1000))

(int2 <- hotelling.test(males.no.obese,males.obese,shrinkage = T,var.equal = F,perm = T,B=1000))

(int3 <- hotelling.test(pcos.no.obese,pcos.obese,shrinkage = T,var.equal = F,perm = T,B=1000))

(int4 <- hotelling.test(females.no.obese,males.obese,shrinkage = T,var.equal = F,perm = T,B=1000))

(int5 <- hotelling.test(females.no.obese,pcos.obese,shrinkage = T,var.equal = F,perm = T,B=1000))

(int6 <- hotelling.test(females.no.obese,males.no.obese,shrinkage = T,var.equal = F,perm = T,B=1000))

(int7 <- hotelling.test(females.no.obese,pcos.no.obese,shrinkage = T,var.equal = F,perm = T,B=1000))

(int8 <- hotelling.test(males.no.obese,females.obese,shrinkage = T,var.equal = F,perm = T,B=1000))

(int9 <- hotelling.test(males.no.obese,pcos.obese,shrinkage = T,var.equal = F,perm = T,B=1000))

(int10 <- hotelling.test(pcos.no.obese,females.obese,shrinkage = T,var.equal = F,perm = T,B=1000))

(int11 <- hotelling.test(females.obese,males.obese,shrinkage = T,var.equal = F,perm = T,B=1000))

(int12 <- hotelling.test(females.obese,pcos.obese,shrinkage = T,var.equal = F,perm = T,B=1000))

(int13 <- hotelling.test(males.obese,pcos.obese,shrinkage = T,var.equal = F,perm = T,B=1000))

(int14 <- hotelling.test(males.no.obese,pcos.no.obese,shrinkage = T,var.equal = F,perm = T,B=1000))

(int15 <- hotelling.test(pcos.no.obese,males.obese,shrinkage = T,var.equal = F,perm = T,B=1000))
```

```{r}
pvals <-c(int1$pval,int2$pval,int3$pval,int4$pval,int5$pval,int6$pval,
  int7$pval,int8$pval,int9$pval,int10$pval,int11$pval,int12$pval,
  int13$pval,int14$pval,int15$pval)
p.adjust(pvals,method = "BH")
```

```{r}
(res1 <- hotelling.test(FEMALES,MALES,shrinkage = T,var.equal = F,perm = T,B = 1000))
```
```{r}
(res1 <- hotelling.test(obesos,No.Obesos,shrinkage = T,var.equal = F,perm = T,B = 1000))

```

```{r}
(res1 <- hotelling.test(females,pcos,shrinkage = T,var.equal = F,perm = T,B = 1000))
(res2 <- hotelling.test(males,pcos,shrinkage = T,var.equal = F,perm = T,B = 1000))
(res3 <- hotelling.test(females,males,shrinkage = T,var.equal = F,perm = T,B = 1000))

p.adjust(c(res1$pval,res2$pval,res3$pval),method = "BH")
```


## Graficos variables

```{r}
Y <-as.data.frame((as.matrix(factores.recast) %*% t(weights.recast[,-ncol(weights.recast)])))
Y$interaccion <- factor(c(rep("No.Obese_Female",8),
                          rep("Obese_Female",8),
                          rep("No.Obese_PCOS",7),
                          rep("Obese_PCOS",8),
                          rep("No.Obese_Male",8),
                          rep("Obese_Male",7)),levels=c("No.Obese_Female","Obese_Female","No.Obese_PCOS","Obese_PCOS","No.Obese_Male","Obese_Male"))
Y$grupo <- variables_in_bacteria$GROUP
Y$obesidad <- variables_in_bacteria$OBESE
p1 <-ggplot(Y, aes(grupo, Hungatella, fill=interaction(grupo,obesidad), dodge=grupo)) +
  stat_boxplot(geom ='errorbar')+
  geom_boxplot()+
  scale_fill_manual(values=c("black","red","green","gray", "darkred","darkgreen"))
p2<-ggplot(Y, aes(grupo, Asaccharobacter, fill=interaction(grupo,obesidad), dodge=grupo)) +
  stat_boxplot(geom ='errorbar')+
  geom_boxplot()+
  scale_fill_manual(values=c("black","red","green","gray", "darkred","darkgreen"))
p3 <-ggplot(Y, aes(grupo, Pyruvate_mean, fill=interaction(grupo,obesidad), dodge=grupo)) +
  stat_boxplot(geom ='errorbar')+
  geom_boxplot()+
  scale_fill_manual(values=c("black","red","green","gray", "darkred","darkgreen"))
p4 <- ggplot(Y, aes(grupo, Staphylococcus, fill=interaction(grupo,obesidad), dodge=grupo)) +
  stat_boxplot(geom ='errorbar')+
  geom_boxplot()+
  scale_fill_manual(values=c("black","red","green","gray", "darkred","darkgreen"))

ggarrange(p1,p2,p3,p4,ncol=2,nrow=2,common.legend = T)
```



```{r}
Y <-(as.matrix(factores.recast) %*% t(weights.recast[,-ncol(weights.recast)]))

data_subset<-Y[,vars$features]

my_hclust_gene <- hclust(dist(t(data_subset)), method = "complete")

my_hclust_sample <- hclust(dist((data_subset)), method = "complete")
# install if necessary
# install.packages("dendextend")
 
# load package
library(dendextend)
par(cex=0.4)

as.dendrogram(my_hclust_gene) %>%
  plot(horiz = TRUE) 
as.dendrogram(my_hclust_sample) %>%
  plot(horiz = TRUE)
my_gene_col <- cutree(tree = as.dendrogram(my_hclust_gene), k = 2)
my_gene_col <- data.frame(cluster = ifelse(test = my_gene_col == 1, yes = "cluster1", no = "cluster2"))
my_gene_col$view <- c(rep("metaboloma",36),rep("microbioma",26))
my_sample_col <- data.frame(obesidad=obesidad,grupo=grupo)
my_colour = list(
    obesidad = c(No.Obese = "black", Obese = "red"),
    view = c(metaboloma = "blue", microbioma = "steelblue"),
    cluster = c(cluster1 = "red", cluster2 = "darkred"),
    grupo = c(Female="red",PCOS="blue",Male="black")
)
row.names(my_sample_col) <-pacientes

library(pheatmap)
pheatmap(t(data_subset), annotation_row = my_gene_col, annotation_col = my_sample_col,annotation_colors = my_colour,fontsize = 7)
```
```{r}
library(ape)
colors = c("red", "blue")
my_hclust_sample <- hclust(dist(t(data_subset)), method = "complete")
clus4 = cutree(my_hclust_sample, 2)
plot(as.phylo(my_hclust_sample), type = "fan", tip.color = colors[clus4],
     label.offset = 0.1, cex = 0.5)
```

```{r}
library(ape)
colors = c("red", "blue","black")
dend <- Y  %>% dist %>% 
   hclust %>% as.dendrogram %>%
   set("branches_k_color", k=6) %>% set("branches_lwd", 1.2) %>%
   set("labels_colors") %>% set("labels_cex", c(.9,1.2)) %>% 
   set("leaves_pch", 19) %>% set("leaves_col", c("blue", "red","black","steelblue","green","darkgreen"))

plot(dend)
```



```{r}
csa <-plot_weights(model,factors = 1:9,nfeatures = 50,return_data = T,scale = T,view=1)
unique(csa[csa$value>0.1,"feature"])

csa <-plot_weights(model,factors = 1:9,nfeatures = 50,return_data = T,scale = T,view=2)
unique(csa[csa$value>0.35,"feature"])
```

```{r}
Y <-(as.matrix(factores.recast) %*% t(weights.recast[,-ncol(weights.recast)]))

data_subset<- Y[,vars$features]
metaboloma <- Y[,which(vars$views=="metaboloma")]
# metaboloma <- metaboloma[rownames(metaboloma) %in% variables_in_bacteria$Paciente[interaccion=="No.Obese_Male"],]
microbioma <- (Y[,which(vars$views=="microbioma")])
# microbioma<- microbioma[rownames(microbioma) %in% variables_in_bacteria$Paciente[interaccion=="No.Obese_Male"],]

datos <- list(metaboloma=(metaboloma),microbioma=(microbioma))
res1.pls.met_micro <- mixOmics::pls(datos$metaboloma,datos$microbioma,ncomp=1)
(rho_pcos<-cor.test(res1.pls.met_micro$variates$X,res1.pls.met_micro$variates$Y))
```



```{r}
Y <-(as.matrix(factores.recast) %*% t(weights.recast[,-ncol(weights.recast)]))
vars <- data.frame(views=c(rep("metaboloma",37),rep("microbioma",94)))
# data_subset<- Y[,vars$features]
metaboloma <- Y[,which(vars$views=="metaboloma")]
metaboloma <- metaboloma[rownames(metaboloma) %in% variables_in_bacteria$Paciente[variables_in_bacteria$OBESE=="Obese"],]
microbioma <- (Y[,which(vars$views=="microbioma")])
microbioma<- microbioma[rownames(microbioma) %in% variables_in_bacteria$Paciente[variables_in_bacteria$OBESE=="Obese"],]

datos <- list(metaboloma=(metaboloma),microbioma=(microbioma))
res1.pls.met_micro <- mixOmics::pls(datos$metaboloma,datos$microbioma,ncomp=1)
(rho_ob1<-cor.test(res1.pls.met_micro$variates$X,res1.pls.met_micro$variates$Y))
```

```{r}
Y <-(as.matrix(factores.recast) %*% t(weights.recast[,-ncol(weights.recast)]))

data_subset<- Y
metaboloma <- Y[,which(vars$views=="metaboloma")]
metaboloma <- metaboloma[rownames(metaboloma) %in% variables_in_bacteria$Paciente[variables_in_bacteria$OBESE=="No Obese"],]
microbioma <- (Y[,which(vars$views=="microbioma")])
microbioma<- microbioma[rownames(microbioma) %in% variables_in_bacteria$Paciente[variables_in_bacteria$OBESE=="No Obese"],]

datos <- list(metaboloma=(metaboloma),microbioma=(microbioma))
res1.pls.met_micro <- mixOmics::pls(datos$metaboloma,datos$microbioma,ncomp=1)
(rho_ob2<-cor.test(res1.pls.met_micro$variates$X,res1.pls.met_micro$variates$Y))
```
```{r}
Y <-(as.matrix(factores.recast) %*% t(weights.recast[,-ncol(weights.recast)]))

data_subset<- Y[]
metaboloma <- Y[,which(vars$views=="metaboloma")]
metaboloma <- metaboloma[rownames(metaboloma) %in% variables_in_bacteria$Paciente[variables_in_bacteria$GROUP=="Female"],]
microbioma <- (Y[,which(vars$views=="microbioma")])
microbioma<- microbioma[rownames(microbioma) %in% variables_in_bacteria$Paciente[variables_in_bacteria$GROUP=="Female"],]

datos <- list(metaboloma=(metaboloma),microbioma=(microbioma))
res1.pls.met_micro <- mixOmics::pls(datos$metaboloma,datos$microbioma,ncomp=1)
(rho_fem<-cor.test(res1.pls.met_micro$variates$X,res1.pls.met_micro$variates$Y))
```
```{r}
Y <-(as.matrix(factores.recast) %*% t(weights.recast[,-ncol(weights.recast)]))

data_subset<- Y[,vars$features]
metaboloma <- Y[,which(vars$views=="metaboloma")]
metaboloma <- metaboloma[rownames(metaboloma) %in% variables_in_bacteria$Paciente[variables_in_bacteria$GROUP=="Male"],]
microbioma <- (Y[,which(vars$views=="microbioma")])
microbioma<- microbioma[rownames(microbioma) %in% variables_in_bacteria$Paciente[variables_in_bacteria$GROUP=="Male"],]

datos <- list(metaboloma=(metaboloma),microbioma=(microbioma))
res1.pls.met_micro <- mixOmics::pls(datos$metaboloma,datos$microbioma,ncomp=1)
(rho_male<-cor.test(res1.pls.met_micro$variates$X,res1.pls.met_micro$variates$Y))
```

```{r}
Y <-(as.matrix(factores.recast) %*% t(weights.recast[,-ncol(weights.recast)]))

data_subset<- Y[,vars$features]
metaboloma <- Y[,which(vars$views=="metaboloma")]
metaboloma <- metaboloma[rownames(metaboloma) %in% variables_in_bacteria$Paciente[variables_in_bacteria$GROUP=="PCOS"],]
microbioma <- (Y[,which(vars$views=="microbioma")])
microbioma<- microbioma[rownames(microbioma) %in% variables_in_bacteria$Paciente[variables_in_bacteria$GROUP=="PCOS"],]

datos <- list(metaboloma=(metaboloma),microbioma=(microbioma))
res1.pls.met_micro <- mixOmics::pls(datos$metaboloma,datos$microbioma,ncomp=1)
(rho_pcos<-cor.test(res1.pls.met_micro$variates$X,res1.pls.met_micro$variates$Y))
```

```{r}
pgrupo <- p.adjust(c(rho_fem$p.value,rho_male$p.value,rho_pcos$p.value),method = "bonferroni")
pgrupo
```

```{r}
Y <-(as.matrix(factores.recast) %*% t(weights.recast[,-ncol(weights.recast)]))

data_subset<- Y[,vars$features]
metaboloma <- Y[,which(vars$views=="metaboloma")]
metaboloma <- metaboloma[rownames(metaboloma) %in% variables_in_bacteria$Paciente[interaccion=="No.Obese_Female"],]
microbioma <- (Y[,which(vars$views=="microbioma")])
microbioma<- microbioma[rownames(microbioma) %in% variables_in_bacteria$Paciente[interaccion=="No.Obese_Female"],]

datos <- list(metaboloma=(metaboloma),microbioma=(microbioma))
res1.pls.met_micro <- mixOmics::pls(datos$metaboloma,datos$microbioma,ncomp=1)
(rho_pcos1<-cor.test(res1.pls.met_micro$variates$X,res1.pls.met_micro$variates$Y))
```

```{r}
Y <-(as.matrix(factores.recast) %*% t(weights.recast[,-ncol(weights.recast)]))

data_subset<- Y[,vars$features]
metaboloma <- Y[,which(vars$views=="metaboloma")]
metaboloma <- metaboloma[rownames(metaboloma) %in% variables_in_bacteria$Paciente[interaccion=="Obese_Female"],]
microbioma <- (Y[,which(vars$views=="microbioma")])
microbioma<- microbioma[rownames(microbioma) %in% variables_in_bacteria$Paciente[interaccion=="Obese_Female"],]

datos <- list(metaboloma=(metaboloma),microbioma=(microbioma))
res1.pls.met_micro <- mixOmics::pls(datos$metaboloma,datos$microbioma,ncomp=1)
(rho_pcos2<-cor.test(res1.pls.met_micro$variates$X,res1.pls.met_micro$variates$Y))
```

```{r}
Y <-(as.matrix(factores.recast) %*% t(weights.recast[,-ncol(weights.recast)]))

data_subset<- Y[,vars$features]
metaboloma <- Y[,which(vars$views=="metaboloma")]
metaboloma <- metaboloma[rownames(metaboloma) %in% variables_in_bacteria$Paciente[interaccion=="No.Obese_Male"],]
microbioma <- (Y[,which(vars$views=="microbioma")])
microbioma<- microbioma[rownames(microbioma) %in% variables_in_bacteria$Paciente[interaccion=="No.Obese_Male"],]

datos <- list(metaboloma=(metaboloma),microbioma=(microbioma))
res1.pls.met_micro <- mixOmics::pls(datos$metaboloma,datos$microbioma,ncomp=1)
(rho_pcos3<-cor.test(res1.pls.met_micro$variates$X,res1.pls.met_micro$variates$Y))
```
```{r}
Y <-(as.matrix(factores.recast) %*% t(weights.recast[,-ncol(weights.recast)]))

data_subset<- Y[,vars$features]
metaboloma <- Y[,which(vars$views=="metaboloma")]
metaboloma <- metaboloma[rownames(metaboloma) %in% variables_in_bacteria$Paciente[interaccion=="Obese_Male"],]
microbioma <- (Y[,which(vars$views=="microbioma")])
microbioma<- microbioma[rownames(microbioma) %in% variables_in_bacteria$Paciente[interaccion=="Obese_Male"],]

datos <- list(metaboloma=(metaboloma),microbioma=(microbioma))
res1.pls.met_micro <- mixOmics::pls(datos$metaboloma,datos$microbioma,ncomp=1)
(rho_pcos4<-cor.test(res1.pls.met_micro$variates$X,res1.pls.met_micro$variates$Y))
```
```{r}
Y <-(as.matrix(factores.recast) %*% t(weights.recast[,-ncol(weights.recast)]))

data_subset<- Y[,vars$features]
metaboloma <- Y[,which(vars$views=="metaboloma")]
metaboloma <- metaboloma[rownames(metaboloma) %in% variables_in_bacteria$Paciente[interaccion=="No.Obese_PCOS"],]
microbioma <- (Y[,which(vars$views=="microbioma")])
microbioma<- microbioma[rownames(microbioma) %in% variables_in_bacteria$Paciente[interaccion=="No.Obese_PCOS"],]

datos <- list(metaboloma=(metaboloma),microbioma=(microbioma))
res1.pls.met_micro <- mixOmics::pls(datos$metaboloma,datos$microbioma,ncomp=1)
(rho_pcos5<-cor.test(res1.pls.met_micro$variates$X,res1.pls.met_micro$variates$Y))
```


```{r}
Y <-(as.matrix(factores.recast) %*% t(weights.recast[,-ncol(weights.recast)]))

data_subset<- Y[,vars$features]
metaboloma <- Y[,which(vars$views=="metaboloma")]
metaboloma <- metaboloma[rownames(metaboloma) %in% variables_in_bacteria$Paciente[interaccion=="Obese_PCOS"],]
microbioma <- (Y[,which(vars$views=="microbioma")])
microbioma<- microbioma[rownames(microbioma) %in% variables_in_bacteria$Paciente[interaccion=="Obese_PCOS"],]

datos <- list(metaboloma=(metaboloma),microbioma=(microbioma))
res1.pls.met_micro <- mixOmics::pls(datos$metaboloma,datos$microbioma,ncomp=1)
(rho_pcos6<-cor.test(res1.pls.met_micro$variates$X,res1.pls.met_micro$variates$Y))
```
```{r}
ppcos <- c(rho_pcos1$p.value,rho_pcos2$p.value,
           rho_pcos3$p.value,rho_pcos4$p.value,
           rho_pcos5$p.value,rho_pcos6$p.value)
p.adjust(ppcos,method = "BH")
```
```{r}
Y <-(as.matrix(factores.recast) %*% t(weights.recast[,-ncol(weights.recast)]))

data_subset<- Y[,vars$features]
metaboloma <- Y[,which(vars$views=="metaboloma")]
metaboloma <- metaboloma[rownames(metaboloma) %in% variables_in_bacteria$Paciente[variables_in_bacteria$SEX=="Female"],]
microbioma <- (Y[,which(vars$views=="microbioma")])
microbioma<- microbioma[rownames(microbioma) %in% variables_in_bacteria$Paciente[variables_in_bacteria$SEX=="Female"],]

datos <- list(metaboloma=(metaboloma),microbioma=(microbioma))
res1.pls.met_micro <- mixOmics::pls(datos$metaboloma,datos$microbioma,ncomp=1)
(rho_pcos6<-cor.test(res1.pls.met_micro$variates$X,res1.pls.met_micro$variates$Y))
```

```{r}
Y <-(as.matrix(factores.recast) %*% t(weights.recast[,-ncol(weights.recast)]))

data_subset<- Y[,vars$features]
metaboloma <- Y[,which(vars$views=="metaboloma")]
metaboloma <- metaboloma[rownames(metaboloma) %in% variables_in_bacteria$Paciente[variables_in_bacteria$SEX=="Male"],]
microbioma <- (Y[,which(vars$views=="microbioma")])
microbioma<- microbioma[rownames(microbioma) %in% variables_in_bacteria$Paciente[variables_in_bacteria$SEX=="Male"],]

datos <- list(metaboloma=(metaboloma),microbioma=(microbioma))
res1.pls.met_micro <- mixOmics::pls(datos$metaboloma,datos$microbioma,ncomp=1)
(rho_pcos6<-cor.test(res1.pls.met_micro$variates$X,res1.pls.met_micro$variates$Y))
```


```{r}
vars <-data.frame(features=Reduce("union",list(intr,intr2,intr3,gru1,gru2,gru3,ob1,ob2)))
vars$features <- vars$features
vars$views <- ifelse(vars$features %in% rownames(met37),"metaboloma","microbioma")
vars <- vars[order(vars$views),]
```


```{r}
plot_weights_heatmap(model,view = 2)
```


```{r}
csa <- plot_weights(model,view =1,return_data = T,factors = 1:2)
(csamet<-unique(csa[csa$value>0.2,"feature"]))

 csa <- plot_weights(model,view =2,return_data = T,factors = c(3,4,5,7,8,9))
(csanicro<-unique(csa[csa$value>0.3,"feature"]))      
common <- c(csamet,csanicro)
```


```{r}
common <- c(csamet,csanicro)
```
```{r}
common[!common %in%vars$features]
```

```{r}
mycor <- cor(males.obese[,-c(which(!colnames(males.obese)%in%vars$features),134,133,132)],method = "spearman")
testRes <- cor.mtest(males.obese[,-c(which(!colnames(males.obese)%in%vars$features),134,133,132)],method = "spearman")
testRes$p <- (matrix(p.adjust(testRes$p,"BH"),ncol=ncol(mycor),byrow = T))
colnames(testRes$p) <- colnames(mycor)
rownames(testRes$p) <- rownames(mycor)
library(corrplot)
corrplot::corrplot(mycor, p.mat = testRes$p, method = 'color', diag = F,
         sig.level = c(0.001, 0.01, 0.05), pch.cex = 0.7,
         insig = 'label_sig', pch.col = 'white',tl.cex = 0.5,title=paste("MALES OBESE",round(rho_pcos4$estimate,2)),mar=c(0,0,1,0))

pheatmap(mycor,main=paste("MALES OBESE",round(rho_pcos4$estimate,2)),fontsize = 10,fontsize_col = 5,fontsize_row = 5)


```

```{r}
mycor <- cor(males.no.obese[,-c(which(!colnames(males.no.obese)%in%vars$features),134,133,132)],method = "spearman")
testRes <- cor.mtest(males.no.obese[,-c(which(!colnames(males.no.obese)%in%vars$features),134,133,132)],method = "spearman")
testRes$p <- (matrix(p.adjust(testRes$p,"BH"),ncol=ncol(mycor),byrow = T))
colnames(testRes$p) <- colnames(mycor)
rownames(testRes$p) <- rownames(mycor)
library(corrplot)
corrplot::corrplot(mycor, p.mat = testRes$p, method = 'color', diag = F,
         sig.level = c(0.001, 0.01, 0.05), pch.cex = 0.7,
         insig = 'label_sig', pch.col = 'white',tl.cex = 0.5,title=paste("MALES NO OBESE",round(rho_pcos3$estimate,2)),mar=c(0,0,1,0))
pheatmap(mycor,main=paste("MALES NO OBESE",round(rho_pcos3$estimate,2)),fontsize = 10,fontsize_col = 5,fontsize_row = 5)


```

```{r}
mycor <- cor(females.no.obese[,-c(which(!colnames(females.no.obese)%in%vars$features),134,133,132)],method = "spearman")
testRes <- cor.mtest(females.no.obese[,-c(which(!colnames(females.no.obese)%in%vars$features),134,133,132)],method = "spearman")
testRes$p <- (matrix(p.adjust(testRes$p,"BH"),ncol=ncol(mycor),byrow = T))
colnames(testRes$p) <- colnames(mycor)
rownames(testRes$p) <- rownames(mycor)
library(corrplot)
corrplot::corrplot(mycor, p.mat = testRes$p, method = 'color', diag = F,
         sig.level = c(0.001, 0.01, 0.05), pch.cex = 0.7,
         insig = 'label_sig', pch.col = 'white',tl.cex = 0.5,title=paste("FEMALES NO  OBESE",round(rho_pcos1$estimate,2)),mar=c(0,0,1,0))

pheatmap(mycor,main=paste("FEMALE NO OBESE",round(rho_pcos1$estimate,2)),fontsize = 10,fontsize_col = 5,fontsize_row = 5)

```

```{r}
mycor <- cor(females.obese[,-c(which(!colnames(females.obese)%in%vars$features),134,133,132)],method = "spearman")
testRes <- cor.mtest(females.obese[,-c(which(!colnames(females.obese)%in%vars$features),134,133,132)],method = "spearman")
testRes$p <- (matrix(p.adjust(testRes$p,"BH"),ncol=ncol(mycor),byrow = T))
colnames(testRes$p) <- colnames(mycor)
rownames(testRes$p) <- rownames(mycor)
library(corrplot)
corrplot::corrplot(mycor, p.mat = testRes$p, method = 'color', diag = F,
         sig.level = c(0.001, 0.01, 0.05), pch.cex = 0.7,
         insig = 'label_sig', pch.col = 'white',tl.cex = 0.5,title=paste("FEMALES OBESE",round(rho_pcos2$estimate,2)),mar=c(0,0,1,0))

pheatmap(mycor[,apply(testRes$p,1,function(x) any(x<0.005))],main=paste("FEMALES OBESE",round(rho_pcos2$estimate,2)),fontsize = 10,fontsize_col = 5,fontsize_row = 5)

```

```{r}
mycor <- cor(pcos.no.obese[,-c(which(!colnames(pcos.no.obese)%in%vars$features),134,133,132)],method = "spearman")
testRes <- cor.mtest(pcos.no.obese[,-c(which(!colnames(pcos.no.obese)%in%vars$features),134,133,132)],method = "spearman")
testRes$p <- (matrix(p.adjust(testRes$p,"BH"),ncol=ncol(mycor),byrow = T))
colnames(testRes$p) <- colnames(mycor)
rownames(testRes$p) <- rownames(mycor)
library(corrplot)
corrplot::corrplot(mycor, p.mat = testRes$p, method = 'color', diag = F,
         sig.level = c(0.001, 0.01, 0.05), pch.cex = 0.7,
         insig = 'label_sig', pch.col = 'white',tl.cex = 0.5,title=paste("PCOS NO OBESE",round(rho_pcos5$estimate,2)),mar=c(0,0,1,0))

pheatmap(mycor,main=paste("PCOS NO OBESE",round(rho_pcos5$estimate,2)),fontsize = 10,fontsize_col = 5,fontsize_row = 5)

```
```{r}
mycor <- cor(pcos.obese[,-c(which(!colnames(pcos.obese)%in%vars$features),134,133,132)],method = "spearman")
testRes <- cor.mtest(pcos.obese[,-c(which(!colnames(pcos.obese)%in%vars$features),134,133,132)],method = "spearman")
testRes$p <- (matrix(p.adjust(testRes$p,"BH"),ncol=ncol(mycor),byrow = T))
colnames(testRes$p) <- colnames(mycor)
rownames(testRes$p) <- rownames(mycor)
library(corrplot)
corrplot::corrplot(mycor, p.mat = testRes$p, method = 'color', diag = F,
         sig.level = c(0.001, 0.01, 0.05), pch.cex = 0.7,
         insig = 'label_sig', pch.col = 'white',tl.cex = 0.5, mar=c(0,0,1,0),title=paste("PCOS OBESE",round(rho_pcos6$estimate,2)))

pheatmap(mycor,main=paste("PCOS OBESE",round(rho_pcos6$estimate,2)),fontsize = 10,fontsize_col = 5,fontsize_row = 5)

```

```{r}
mycor <- cor(obesos[,-c(which(!colnames(obesos)%in%vars$features),134,133,132)],method = "spearman")
testRes <- cor.mtest(obesos[,-c(which(!colnames(obesos)%in%vars$features),134,133,132)],method = "spearman")
testRes$p <- (matrix(p.adjust(testRes$p,"BH"),ncol=ncol(mycor),byrow = T))
colnames(testRes$p) <- colnames(mycor)
rownames(testRes$p) <- rownames(mycor)
library(corrplot)
corrplot::corrplot(mycor, p.mat = testRes$p, method = 'color', diag = F,
         sig.level = c(0.001, 0.01, 0.05), pch.cex = 0.7,
         insig = 'label_sig', pch.col = 'white',tl.cex = 0.5, mar=c(0,0,1,0),title=paste("OBESE",round(rho_ob1$estimate,2)))

pheatmap(mycor,main=paste("OBESE",round(rho_ob1$estimate,2)),fontsize = 5)

```
```{r}
mycor <- cor(No.Obesos[,-c(which(!colnames(No.Obesos)%in%vars$features),134,133,132)],method = "spearman")
testRes <- cor.mtest(No.Obesos[,-c(which(!colnames(No.Obesos)%in%vars$features),134,133,132)],method = "spearman")
testRes$p <- (matrix(p.adjust(testRes$p,"BH"),ncol=ncol(mycor),byrow = T))
colnames(testRes$p) <- colnames(mycor)
rownames(testRes$p) <- rownames(mycor)
library(corrplot)
corrplot::corrplot(mycor, p.mat = testRes$p, method = 'color', diag = F,
         sig.level = c(0.001, 0.01, 0.05), pch.cex = 0.7,
         insig = 'label_sig', pch.col = 'white',tl.cex = 0.5, mar=c(0,0,1,0),title=paste("NO OBESE",round(rho_ob2$estimate,2)))

pheatmap(mycor,main=paste("NO OBESE",round(rho_ob2$estimate,2)),fontsize = 5)
```

```{r}
library(ape)
colors = c("red", "blue")
my_hclust_sample <- hclust(dist(t(mycor)), method = "complete")
clus4 = cutree(my_hclust_sample, 2)
plot(as.phylo(my_hclust_sample), type = "fan", tip.color = colors[clus4],
     label.offset = 0.1, cex = 0.5)
```



## INFERENCIA MULTIVARIANBE UNIBLOQUE metaboloma


```{r}
library(glmnet)
# Find the best lambda using cross-validation
set.seed(123) 
X<-t(voom(met37_norm,normalize.method = "quantile")$E)
dim(X)
```

```{r}
## tradicional modelo logistico
set.seed(123)
library(caret)
n<-46
n.train <- createDataPartition(obesidad,p=0.7,list=F)
mdl.obesity <- bind_cols(as.data.frame(Y),obesidad)
colnames(mdl.obesity) <- c(colnames(Y),"obesidad")
mdl.obesity.train <-mdl.obesity[n.train,]
mdl.obesity.test <- mdl.obesity[-n.train,]
mdl1 <- glm(obesidad~.,data=mdl.obesity.train,family = binomial)
summary(mdl1)
## stepwise
library(stats)
prob <- mdl1 %>% stats::predict(mdl.obesity.test,type="response")
predicted.classes <- as.factor(ifelse(prob>0.5,"Obese","No.Obese"))
(csa <-confusionMatrix(mdl.obesity.test$obesidad,predicted.classes)$overall[1])

# mdl2 <- glm(obesidad ~.,data=mdl.obesity.train,family = binomial) %>% stepAIC(trace=FALSE)
# prob <- mdl2 %>% stats::predict(mdl.obesity.test,type="response")
# predicted.classes <- as.factor(ifelse(prob>0.5,"Obese","No.Obese"))
# (csa <-confusionMatrix(mdl.obesity.test$obesidad,predicted.classes))

### penalized  lasso

x <- model.matrix(obesidad~.,data=mdl.obesity.train)[,-1]
y <- ifelse(mdl.obesity.train$obesidad=="Obese",1,0)

set.seed(123)
cv.lasso <- cv.glmnet(x,y,alpha=1,family="binomial")
lasso.obesidad <- glmnet(x,y,alpha = 1,family = "binomial",lambda=cv.lasso$lambda.min)

coef(lasso.obesidad)

x.test <- model.matrix(obesidad~.,mdl.obesity.test)[,-1]
prob <- lasso.obesidad %>% stats::predict(x.test)
predicted.classes <- as.factor(ifelse(prob >0.5,"Obese","No.Obese"))
(csa <-confusionMatrix(mdl.obesity.test$obesidad,predicted.classes)$overall[1])

x.all <- model.matrix(obesidad~Y)[,-1]
prob <- lasso.obesidad %>% stats::predict(x.all)
prob <- lasso.obesidad %>% stats::predict(x.test)
predicted.classes <- as.factor(ifelse(prob >0.5,"Obese","No.Obese"))
(csa <-confusionMatrix(mdl.obesity.test$obesidad,predicted.classes)$overall[1])


# coef(lasso.obesidad)

library(tidyverse)
lasso.obesidad <-  glmnet(Y,obesidad,alpha = 1,family = "binomial",lambda=cv.lasso$lambda.min)
prob <- lasso.obesidad %>% stats::predict(Y,type="response")
coef.lasso <- coef.glmnet(lasso.obesidad)
predictors <- mdl.obesity[,coef.lasso@Dimnames[[1]][coef.lasso@i+1][-1]]
mydata <- predictors %>% mutate(logit = log(prob/(1-prob))) %>% gather(key = "predictors",value="predictor.value",-logit)

ggplot(mydata,aes(logit,predictor.value))+geom_point(size=0.5,alpha=0.5)+geom_smooth(method="loess")+theme_bw()+facet_wrap(~predictors,scales="free_y")
```

```{r}
## tradicional modelo logistico
set.seed(123)
library(caret)
n<-46
n.train <- createDataPartition(sexo,p=0.7,list=F)
mdl.obesity <- bind_cols(as.data.frame(Y),sexo)
colnames(mdl.obesity) <- c(colnames(Y),"sexo")
mdl.obesity.train <-mdl.obesity[n.train,]
mdl.obesity.test <- mdl.obesity[-n.train,]
mdl1 <- glm(sexo~.,data=mdl.obesity.train,family = binomial)
summary(mdl1)
## stepwise
library(stats)
prob <- mdl1 %>% stats::predict(mdl.obesity.test,type="response")
predicted.classes <- as.factor(ifelse(prob>0.5,"Female","Male"))
(csa <-confusionMatrix(mdl.obesity.test$sexo,predicted.classes)$overall[1])

# mdl2 <- glm(obesidad ~.,data=mdl.obesity.train,family = binomial) %>% stepAIC(trace=FALSE)
# prob <- mdl2 %>% stats::predict(mdl.obesity.test,type="response")
# predicted.classes <- as.factor(ifelse(prob>0.5,"Obese","No.Obese"))
# (csa <-confusionMatrix(mdl.obesity.test$obesidad,predicted.classes))

### penalized  lasso

x <- model.matrix(sexo~.,data=mdl.obesity.train)[,-1]
y <- ifelse(mdl.obesity.train$sexo=="Female",1,0)

set.seed(123)
cv.lasso <- cv.glmnet(x,y,alpha=1,family="binomial")
lasso.obesidad <- glmnet(x,y,alpha = 1,family = "binomial",lambda=cv.lasso$lambda.min)

coef(lasso.obesidad)

x.test <- model.matrix(sexo~.,mdl.obesity.test)[,-1]
prob <- lasso.obesidad %>% stats::predict(x.test)
predicted.classes <- as.factor(ifelse(prob >0.5,"Female","Male"))
(csa <-confusionMatrix(mdl.obesity.test$sexo,predicted.classes)$overall[1])

x.all <- model.matrix(sexo~Y)[,-1]
prob <- lasso.obesidad %>% stats::predict(x.all)
prob <- lasso.obesidad %>% stats::predict(x.test)
predicted.classes <- as.factor(ifelse(prob >0.5,"Female","Male"))
(csa <-confusionMatrix(mdl.obesity.test$sexo,predicted.classes)$overall[1])


# coef(lasso.obesidad)

library(tidyverse)
lasso.obesidad <-  glmnet(Y,obesidad,alpha = 1,family = "binomial",lambda=cv.lasso$lambda.min)
prob <- lasso.obesidad %>% stats::predict(Y,type="response")
coef.lasso <- coef.glmnet(lasso.obesidad)
predictors <- mdl.obesity[,coef.lasso@Dimnames[[1]][coef.lasso@i+1][-1]]
mydata <- predictors %>% mutate(logit = log(prob/(1-prob))) %>% gather(key = "predictors",value="predictor.value",-logit)

ggplot(mydata,aes(logit,predictor.value))+geom_point(size=0.5,alpha=0.5)+geom_smooth(method="loess")+theme_bw()+facet_wrap(~predictors,scales="free_y")
```

## grupo

```{r}
set.seed(123)
library(caret)
n<-46
n.train <- createDataPartition(grupo,p=0.7,list=F)
mdl.obesity <- bind_cols(as.data.frame(Y),grupo)
colnames(mdl.obesity) <- c(colnames(Y),"grupo")
mdl.obesity.train <-mdl.obesity[n.train,]
mdl.obesity.test <- mdl.obesity[-n.train,]

x <- model.matrix(grupo~.,data=mdl.obesity.train)[,-1]
y <- as.numeric(grupo[n.train])

set.seed(123)
cv.lasso <- cv.glmnet(x,y,alpha=1,family="multinomial")
lasso.obesidad <- glmnet(x,y,alpha = 1,family = "multinomial",lambda=cv.lasso$lambda.min)

coef(lasso.obesidad)

x.test <- model.matrix(grupo~.,mdl.obesity.test)[,-1]
prob <- as.factor(lasso.obesidad %>% stats::predict(x.test,type="class"))
# predicted.classes <- as.factor(ifelse(prob >0.5,"Obese","No.Obese"))
(csa <-confusionMatrix(as.factor(as.character(as.numeric(mdl.obesity.test$grupo))),prob)$overall[1])

```



```{r}
correlate_factors_with_covariates(model,
  covariates = c("obesidad","grupo","edad","BMI","WC","WHR","SHGB","hsCRP","TE2","E2","SEX","LBP","GLP2","Zonulin","Succinate"),
  plot="log_pval"
)
```

```{r}
model <- list.trained2[[which.max(unlist(lapply(list.trained2,function(x) get_elbo(x))))]]
features <- c("obesidad","grupo","edad","BMI","WC","WHR","SHGB","hsCRP","TE2","E2","SEX","LBP","GLP2","Zonulin","Succinate")

plot_variance_explained_per_feature(
  model, 
  view = 2,
)+ theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

```{r}

model <- list.trained2[[which.max(unlist(lapply(list.trained2,function(x) get_elbo(x))))]]
features <- c("obesidad","grupo","edad","BMI","WC","WHR","SHGB","hsCRP","TE2","E2","SEX","LBP","GLP2","Zonulin","Succinate")

plot_variance_explained_per_feature(
  model, 
  view = 1,
)+ theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```



